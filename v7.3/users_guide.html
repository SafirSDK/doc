<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<meta name="author" content="Lars Hagström, Anders Widén and Joel Ottosson">
<title>Safir SDK Core User&#8217;s Guide</title>
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}


</style>
<p style="text-align:center;"><a href="http://safirsdkcore.com"><img src="images/logotype256.png"/></a></p>
<style>

</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="book">
<div id="header">
<h1>Safir SDK Core User&#8217;s Guide</h1>
<div class="details">
<span id="author" class="author">Lars Hagström, Anders Widén and Joel Ottosson</span><br>
<span id="revdate">2023-12-07</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_preface">Preface</a>
<ul class="sectlevel2">
<li><a href="#_how_to_read">How to read</a></li>
<li><a href="#_acknowledgements">Acknowledgements</a></li>
<li><a href="#_versions_of_this_document">Versions of this document</a></li>
<li><a href="#licenses">Licences and Copying</a></li>
</ul>
</li>
<li><a href="#_what_is_safir_sdk_core">1. What is Safir SDK Core?</a>
<ul class="sectlevel2">
<li><a href="#_provided_services">1.1. Provided services</a></li>
<li><a href="#_why_core">1.2. Why &#8220;Core&#8221;?</a></li>
<li><a href="#_prerequisites_dependencies">1.3. Prerequisites / Dependencies</a></li>
<li><a href="#_supported_platforms">1.4. Supported Platforms</a></li>
</ul>
</li>
<li><a href="#_what_is_the_dob">2. What is the Dob?</a>
<ul class="sectlevel2">
<li><a href="#_what_does_the_dob_do">2.1. What does the Dob do?</a>
<ul class="sectlevel3">
<li><a href="#_a_bit_about_the_dob_architecture">2.1.1. A bit about the Dob architecture</a></li>
</ul>
</li>
<li><a href="#_which_problem_does_the_dob_solves">2.2. Which problem does the Dob solves?</a></li>
<li><a href="#_quick_intro">2.3. Quick intro</a>
<ul class="sectlevel3">
<li><a href="#_messages">2.3.1. Messages</a></li>
<li><a href="#service_overview">2.3.2. Services</a></li>
<li><a href="#_entities">2.3.3. Entities</a></li>
<li><a href="#_defining_the_information_model">2.3.4. Defining the information model</a>
<ul class="sectlevel4">
<li><a href="#_defining_objects">2.3.4.1. Defining objects</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#_the_type_system">3. The type system</a>
<ul class="sectlevel2">
<li><a href="#_the_simple_types">3.1. The simple types</a>
<ul class="sectlevel3">
<li><a href="#_si_types">3.1.1. SI types</a></li>
<li><a href="#hashed_types">3.1.2. Hashed types</a></li>
<li><a href="#binary_data">3.1.3. Binary type</a></li>
</ul>
</li>
<li><a href="#member_flags">3.2. Flags on members</a></li>
<li><a href="#items_and_structs">3.3. Items and structs</a></li>
<li><a href="#collections">3.4. Collections</a>
<ul class="sectlevel3">
<li><a href="#_a_note_on_collections_in_java">3.4.1. A note on collections in Java</a></li>
</ul>
</li>
<li><a href="#parameters">3.5. Parameters</a>
<ul class="sectlevel3">
<li><a href="#_parameter_arrays">3.5.1. Parameter arrays</a></li>
<li><a href="#_dictionary_parameters">3.5.2. Dictionary parameters</a></li>
<li><a href="#_objects_in_parameters">3.5.3. Objects in parameters</a></li>
<li><a href="#environment_parameters">3.5.4. Environment variables in parameters</a></li>
</ul>
</li>
<li><a href="#_create_routines">3.6. Create routines</a></li>
<li><a href="#_the_syntax_putting_it_all_together">3.7. The syntax - putting it all together</a></li>
<li><a href="#_properties_adv">3.8. Properties <sup>adv</sup></a>
<ul class="sectlevel3">
<li><a href="#_using_the_property">3.8.1. Using the property</a></li>
</ul>
</li>
<li><a href="#code_generation">3.9. Generating code from Dou-files</a>
<ul class="sectlevel3">
<li><a href="#_dependencies_between_modules">3.9.1. Dependencies between modules</a></li>
<li><a href="#_running_dobmake_gui">3.9.2. Running Dobmake GUI</a></li>
<li><a href="#_running_dobmake_from_script_or_command_line">3.9.3. Running Dobmake from script or command line</a></li>
</ul>
</li>
<li><a href="#_using_the_generated_types">3.10. Using the generated types</a>
<ul class="sectlevel3">
<li><a href="#_syntax_in_the_different_languages">3.10.1. Syntax in the different languages</a></li>
<li><a href="#_containers_and_container_proxies">3.10.2. Containers and Container Proxies</a></li>
<li><a href="#smart-pointers">3.10.3. Smart pointers</a>
<ul class="sectlevel4">
<li><a href="#_smart_pointers_in_c">3.10.3.1. Smart pointers in C++</a></li>
<li><a href="#_hints_for_debugging">3.10.3.2. Hints for Debugging</a></li>
</ul>
</li>
<li><a href="#type_casting">3.10.4. Type casting</a>
<ul class="sectlevel4">
<li><a href="#cpp_type_casting">3.10.4.1. C++ type casting</a></li>
<li><a href="#_c_type_casting">3.10.4.2. C# type casting</a></li>
<li><a href="#_java_type_casting">3.10.4.3. Java type casting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_other_details">3.11. Other details</a>
<ul class="sectlevel3">
<li><a href="#change_flags">3.11.1. Change flags</a></li>
<li><a href="#_serialization">3.11.2. Serialization</a>
<ul class="sectlevel4">
<li><a href="#_porting_old_xml_to_new_xml">3.11.2.1. Porting "old" XML to "new" XML</a></li>
</ul>
</li>
<li><a href="#_the_reflection_interface_adv">3.11.3. The reflection interface <sup>adv</sup></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_the_distribution_mechanisms">4. The distribution mechanisms</a>
<ul class="sectlevel2">
<li><a href="#_consumers_and_callbacks">4.1. Consumers and Callbacks</a></li>
<li><a href="#_connections">4.2. Connections</a>
<ul class="sectlevel3">
<li><a href="#dispatching">4.2.1. Dispatching</a>
<ul class="sectlevel4">
<li><a href="#_breaking_out_of_dispatch_early">4.2.1.1. Breaking out of Dispatch "early"</a></li>
</ul>
</li>
<li><a href="#secondary_connections">4.2.2. Secondary Connections</a></li>
</ul>
</li>
<li><a href="#_using_the_mechanisms">4.3. Using the mechanisms</a>
<ul class="sectlevel3">
<li><a href="#addressing">4.3.1. Addressing</a></li>
<li><a href="#proxies">4.3.2. Proxies</a></li>
<li><a href="#_messages_2">4.3.3. Messages</a>
<ul class="sectlevel4">
<li><a href="#_channels">4.3.3.1. Channels</a></li>
<li><a href="#_subscribing_to_messages">4.3.3.2. Subscribing to messages</a></li>
<li><a href="#_sending_messages">4.3.3.3. Sending messages</a></li>
</ul>
</li>
<li><a href="#_services">4.3.4. Services</a>
<ul class="sectlevel4">
<li><a href="#_handlers">4.3.4.1. Handlers</a></li>
<li><a href="#service_handler_registration">4.3.4.2. Registering a service handler</a></li>
<li><a href="#_response_types">4.3.4.3. Response types</a></li>
<li><a href="#_sending_service_requests">4.3.4.4. Sending service requests</a></li>
</ul>
</li>
<li><a href="#_entities_2">4.3.5. Entities</a>
<ul class="sectlevel4">
<li><a href="#_handlers_2">4.3.5.1. Handlers</a></li>
<li><a href="#instanceid_and_entityid">4.3.5.2. InstanceId and EntityId</a></li>
<li><a href="#registering_entity_handler">4.3.5.3. Registering an entity handler</a></li>
<li><a href="#_handling_create_requests">4.3.5.4. Handling Create Requests</a></li>
<li><a href="#_handling_update_requests">4.3.5.5. Handling Update Requests</a></li>
<li><a href="#_handling_delete_requests">4.3.5.6. Handling Delete Requests</a></li>
<li><a href="#_owning_entity_instances">4.3.5.7. Owning entity instances</a></li>
<li><a href="#_subscribing_to_entities">4.3.5.8. Subscribing to entities</a></li>
<li><a href="#reading_entities">4.3.5.9. Reading an entity</a></li>
<li><a href="#_iterating_over_entities">4.3.5.10. Iterating over entities</a></li>
<li><a href="#_sending_entity_requests">4.3.5.11. Sending entity requests</a></li>
<li><a href="#_some_notes_on_the_createrequest_methods">4.3.5.12. Some notes on the CreateRequest methods</a></li>
</ul>
</li>
<li><a href="#persistence">4.3.6. Entity Persistence</a>
<ul class="sectlevel4">
<li><a href="#_synchronousvolatile">4.3.6.1. SynchronousVolatile</a></li>
<li><a href="#_synchronouspermanent">4.3.6.2. SynchronousPermanent</a></li>
<li><a href="#waiting_for_persistence">4.3.6.3. Waiting for persistence data</a></li>
<li><a href="#using_persistence">4.3.6.4. Using persistence</a></li>
<li><a href="#advanced_persistence">4.3.6.5. Understanding persistence <sup>adv</sup></a></li>
</ul>
</li>
<li><a href="#handler_registration_subscription">4.3.7. Handler registration subscriptions</a></li>
</ul>
</li>
<li><a href="#aspects">4.4. Aspects</a></li>
<li><a href="#postpone">4.5. Postponing callbacks</a></li>
<li><a href="#interpreting_change_flags">4.6. Interpreting change flags</a>
<ul class="sectlevel3">
<li><a href="#_messages_3">4.6.1. Messages</a></li>
<li><a href="#_entity_subscriptions">4.6.2. Entity subscriptions</a></li>
<li><a href="#_requests_on_entities">4.6.3. Requests on entities</a></li>
<li><a href="#_requests_on_services">4.6.4. Requests on services</a></li>
</ul>
</li>
<li><a href="#pending_registrations">4.7. Pending Registrations</a></li>
<li><a href="#stop_orders">4.8. Stop orders</a></li>
</ul>
</li>
<li><a href="#safir_websocket">5. Safir WebSocket/JSON-RPC interface</a></li>
<li><a href="#configuration">6. Configuration</a>
<ul class="sectlevel2">
<li><a href="#_basic_system_settings">6.1. Basic system settings</a>
<ul class="sectlevel3">
<li><a href="#locations_ini">6.1.1. locations.ini</a></li>
<li><a href="#logging_ini">6.1.2. logging.ini</a></li>
<li><a href="#typesystem_ini">6.1.3. typesystem.ini</a>
<ul class="sectlevel4">
<li><a href="#_general_section">6.1.3.1. General section</a></li>
<li><a href="#_library_module_sections">6.1.3.2. Library module sections</a></li>
<li><a href="#_parameter_override_sections">6.1.3.3. Parameter override sections</a></li>
</ul>
</li>
<li><a href="#special_variables">6.1.4. Environment and special variable expansion</a></li>
</ul>
</li>
<li><a href="#_network_config">6.2. Network config</a>
<ul class="sectlevel3">
<li><a href="#light-nodes">6.2.1. Full nodes and Light nodes</a>
<ul class="sectlevel4">
<li><a href="#_details_on_light_nodes">6.2.1.1. Details on Light nodes</a></li>
<li><a href="#_light_node_detachattach_behaviour">6.2.1.2. Light node detach/attach behaviour</a></li>
</ul>
</li>
<li><a href="#_safir_sdk_core_networking">6.2.2. Safir SDK Core networking</a></li>
<li><a href="#_node_configuration">6.2.3. Node configuration</a></li>
<li><a href="#node-discovery">6.2.4. Node discovery and system start</a>
<ul class="sectlevel4">
<li><a href="#_node_discovery">6.2.4.1. Node discovery</a></li>
<li><a href="#system-start">6.2.4.2. System start</a></li>
</ul>
</li>
<li><a href="#multiple-nodes-on-one-computer">6.2.5. Multiple nodes on one computer</a></li>
<li><a href="#distribution-scope">6.2.6. Distribution scope</a>
<ul class="sectlevel4">
<li><a href="#_local_types">6.2.6.1. Local types</a></li>
<li><a href="#limited-types">6.2.6.2. Limited Types</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#persistence_config">6.3. Persistence config</a></li>
<li><a href="#request_timeout_config">6.4. Request timeouts config</a></li>
<li><a href="#queue_lengths">6.5. Queue lengths config</a></li>
<li><a href="#memory_config">6.6. Shared Memory config</a></li>
<li><a href="#_memory_levels_and_graceful_degradation">6.7. Memory levels and graceful degradation</a>
<ul class="sectlevel3">
<li><a href="#_forbidden_operations_at_severe_memory_levels">6.7.1. Forbidden operations at severe memory levels</a>
<ul class="sectlevel4">
<li><a href="#_some_notes_on_why_things_are_where_they_are_in_the_table_above">6.7.1.1. Some notes on why things are where they are in the table above</a></li>
</ul>
</li>
<li><a href="#_api_for_getting_current_memory_level">6.7.2. API for getting current memory level</a></li>
<li><a href="#_testing_application_memory_handling">6.7.3. Testing application memory handling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#safir_logging">7. Safir Logging</a>
<ul class="sectlevel2">
<li><a href="#_logging_guidelines">7.1. Logging guidelines</a>
<ul class="sectlevel3">
<li><a href="#_facility_and_severity">7.1.1. Facility and Severity</a></li>
</ul>
</li>
<li><a href="#_safir_logging_configuration">7.2. Safir Logging configuration</a></li>
<li><a href="#_safir_logging_on_windows">7.3. Safir Logging on Windows</a>
<ul class="sectlevel3">
<li><a href="#windows_native_logging">7.3.1. Windows Event Log</a></li>
</ul>
</li>
<li><a href="#_safir_logging_on_linux">7.4. Safir Logging on Linux</a></li>
<li><a href="#_porting_guidelines">7.5. Porting guidelines</a></li>
</ul>
</li>
<li><a href="#node_control">8. Node control</a>
<ul class="sectlevel2">
<li><a href="#_node_control_gui">8.1. Node Control GUI</a></li>
<li><a href="#_command_line_tool">8.2. Command Line Tool</a></li>
<li><a href="#_start">8.3. Start</a>
<ul class="sectlevel3">
<li><a href="#_why_isnt_there_any_support_for_start_of_applications">8.3.1. Why isn&#8217;t there any support for start of applications?</a></li>
</ul>
</li>
<li><a href="#stop">8.4. Stop</a>
<ul class="sectlevel3">
<li><a href="#_safir_node_stop">8.4.1. Safir node stop</a></li>
<li><a href="#_safir_system_stop">8.4.2. Safir system stop</a></li>
<li><a href="#_shutdown">8.4.3. Shutdown</a></li>
<li><a href="#_reboot">8.4.4. Reboot</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#debugging_support">9. Debugging support</a>
<ul class="sectlevel2">
<li><a href="#_the_bd_backdoor_command">9.1. The bd (backdoor) command</a></li>
<li><a href="#_tracer">9.2. Tracer</a>
<ul class="sectlevel3">
<li><a href="#_how_to_use">9.2.1. How to use</a>
<ul class="sectlevel4">
<li><a href="#_expression_expansion">9.2.1.1. Expression expansion</a></li>
</ul>
</li>
<li><a href="#force_log">9.2.2. The FORCE_LOG environment variable</a></li>
<li><a href="#_using_the_tracer_without_a_dob_connection">9.2.3. Using the Tracer without a Dob connection</a></li>
<li><a href="#_tracer_faq">9.2.4. Tracer FAQ</a></li>
<li><a href="#_changes_from_previous_tracer_versions">9.2.5. Changes from previous Tracer versions</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#persistence_service">10. The persistence service</a>
<ul class="sectlevel2">
<li><a href="#_converting_persisted_entities_to_and_from_xml">10.1. Converting persisted entities to and from XML</a>
<ul class="sectlevel3">
<li><a href="#_preserving_persisted_data_when_objects_change">10.1.1. Preserving persisted data when objects change</a></li>
</ul>
</li>
<li><a href="#_redundancy">10.2. Redundancy</a></li>
<li><a href="#_configuring_database_persistence">10.3. Configuring database persistence</a>
<ul class="sectlevel3">
<li><a href="#_connection_strings">10.3.1. Connection strings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_utilities">11. Utilities</a>
<ul class="sectlevel2">
<li><a href="#_sending_many_requests">11.1. Sending many requests</a></li>
<li><a href="#dispatcher_classes">11.2. Asio and Ace Dispatchers</a></li>
<li><a href="#_time">11.3. Time</a></li>
<li><a href="#crash_reporting">11.4. Crash Reporting</a>
<ul class="sectlevel3">
<li><a href="#_enabling_the_crash_reporter">11.4.1. Enabling the Crash Reporter</a></li>
<li><a href="#_requirements_for_using_crash_dumps">11.4.2. Requirements for using crash dumps</a></li>
<li><a href="#_analyzing_a_crash_dump">11.4.3. Analyzing a crash dump</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_application_design_considerations">12. Application Design Considerations</a>
<ul class="sectlevel2">
<li><a href="#overflow_handling">12.1. Overflow handling</a></li>
<li><a href="#request_timeouts">12.2. Request timeouts</a></li>
<li><a href="#_type_system_freedoms">12.3. Type system freedoms</a></li>
<li><a href="#_handling_exceptions">12.4. Handling exceptions</a>
<ul class="sectlevel3">
<li><a href="#_exceptions_in_callbacks">12.4.1. Exceptions in callbacks</a></li>
</ul>
</li>
<li><a href="#_handling_onrevokedregistration">12.5. Handling OnRevokedRegistration</a></li>
<li><a href="#_set_or_delete_an_entity_before_oninitialinjectionsdone_is_received">12.6. Set or Delete an entity before OnInitialInjectionsDone is received</a></li>
<li><a href="#multithreading">12.7. Multithreading</a></li>
<li><a href="#hot_standby">12.8. Hot-standby / Redundancy</a></li>
<li><a href="#_entity_reference_gotchas">12.9. Entity reference gotchas</a></li>
</ul>
</li>
<li><a href="#systems_of_systems">13. Systems of Systems <sup>adv</sup></a>
<ul class="sectlevel2">
<li><a href="#_injectable_entities">13.1. Injectable entities</a></li>
<li><a href="#asynchronous_injections">13.2. Asynchronous Injections</a>
<ul class="sectlevel3">
<li><a href="#_using_asynchronous_injections">13.2.1. Using asynchronous injections</a></li>
<li><a href="#timestamp_merge">13.2.2. Timestamp merges</a></li>
<li><a href="#incomplete_injection_state">13.2.3. IncompleteInjectionState</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#contexts">14. Contexts <sup>adv</sup></a>
<ul class="sectlevel2">
<li><a href="#_what_contexts_can_be_used_for">14.1. What contexts can be used for</a></li>
<li><a href="#_design_principles">14.2. Design principles</a></li>
<li><a href="#_contextshared_types">14.3. ContextShared types</a></li>
<li><a href="#_using_the_context_mechanism">14.4. Using the context mechanism</a>
<ul class="sectlevel3">
<li><a href="#_terminology">14.4.1. Terminology</a></li>
<li><a href="#_each_operator_console_has_one_mode_type_1">14.4.2. Each operator console has one mode (Type 1)</a></li>
<li><a href="#_standalone_system_supporting_one_mode_type_2">14.4.3. StandAlone system supporting one mode (Type 2)</a></li>
<li><a href="#_starting_extra_guis_showing_a_replay_session_type_3">14.4.4. Starting extra GUIs showing a Replay session (Type 3)</a></li>
<li><a href="#_several_replay_sessions_in_one_console_type_4">14.4.5. Several Replay sessions in one console (Type 4)</a></li>
</ul>
</li>
<li><a href="#_app_design">14.5. APP design</a></li>
<li><a href="#_gui_design">14.6. GUI design</a></li>
</ul>
</li>
<li><a href="#_test_support_and_tools">15. Test support and Tools</a>
<ul class="sectlevel2">
<li><a href="#sate">15.1. Sate</a></li>
<li><a href="#dobexplorer">15.2. Dobexplorer</a></li>
<li><a href="#_entity_viewer">15.3. Entity Viewer</a></li>
<li><a href="#_tool_launcher">15.4. Tool Launcher</a></li>
<li><a href="#_dots_configuration_check">15.5. dots_configuration_check</a></li>
</ul>
</li>
<li><a href="#_more_help">16. More help</a>
<ul class="sectlevel2">
<li><a href="#_doxygen_help">16.1. Doxygen help</a></li>
<li><a href="#_asking_questions_and_reporting_bugs">16.2. Asking questions and reporting bugs</a></li>
</ul>
</li>
<li><a href="#example_applications">Appendix A: Example applications</a>
<ul class="sectlevel2">
<li><a href="#_some_background">A.1. Some background</a></li>
<li><a href="#_the_example_problem">A.2. The (example) problem</a></li>
<li><a href="#_the_solution">A.3. The solution</a></li>
<li><a href="#_vehicleapp_business_application">A.4. VehicleApp - Business Application</a>
<ul class="sectlevel3">
<li><a href="#_dou_files">A.4.1. Dou-files</a></li>
<li><a href="#_internal_design">A.4.2. Internal Design</a></li>
</ul>
</li>
<li><a href="#_vehiclemmi_presentation_application">A.5. VehicleMmi - Presentation Application</a>
<ul class="sectlevel3">
<li><a href="#_windows_and_dialogs">A.5.1. Windows and Dialogs</a></li>
<li><a href="#_dou_files_2">A.5.2. Dou-files</a></li>
<li><a href="#_internal_design_2">A.5.3. Internal Design</a></li>
</ul>
</li>
<li><a href="#_vehicledb_database_application">A.6. VehicleDb - Database Application</a>
<ul class="sectlevel3">
<li><a href="#_dou_files_3">A.6.1. Dou-files</a></li>
<li><a href="#_internal_design_3">A.6.2. Internal Design</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#websocket_api_reference">Appendix B: Dob WebSocket/JSON-RPC API reference</a>
<ul class="sectlevel2">
<li><a href="#_methods">B.1. Methods</a>
<ul class="sectlevel3">
<li><a href="#_method_close">B.1.1. Method: close</a></li>
<li><a href="#_method_createrequest">B.1.2. Method: createRequest</a></li>
<li><a href="#_method_deleteallinstances">B.1.3. Method: deleteAllInstances</a></li>
<li><a href="#_method_deleteentity">B.1.4. Method: deleteEntity</a></li>
<li><a href="#_method_deleterequest">B.1.5. Method: deleteRequest</a></li>
<li><a href="#_method_getallinstanceids">B.1.6. Method: getAllInstanceIds</a></li>
<li><a href="#_method_getinstanceidpolicy">B.1.7. Method: getInstanceIdPolicy</a></li>
<li><a href="#_method_getnumberofinstances">B.1.8. Method: getNumberOfInstances</a></li>
<li><a href="#_method_gettypehierarchy">B.1.9. Method: getTypeHierarchy</a></li>
<li><a href="#_method_iscreated">B.1.10. Method: isCreated</a></li>
<li><a href="#_method_isopen">B.1.11. Method: isOpen</a></li>
<li><a href="#_method_open">B.1.12. Method: open</a></li>
<li><a href="#_method_ping">B.1.13. Method: ping</a></li>
<li><a href="#_method_readentity">B.1.14. Method: readEntity</a></li>
<li><a href="#_method_registerentityhandler">B.1.15. Method: registerEntityHandler</a></li>
<li><a href="#_method_registerservicehandler">B.1.16. Method: registerServiceHandler</a></li>
<li><a href="#_method_sendmessage">B.1.17. Method: sendMessage</a></li>
<li><a href="#_method_servicerequest">B.1.18. Method: serviceRequest</a></li>
<li><a href="#_method_setentity">B.1.19. Method: setEntity</a></li>
<li><a href="#_method_setentitychanges">B.1.20. Method: setEntityChanges</a></li>
<li><a href="#_method_subscribeentity">B.1.21. Method: subscribeEntity</a></li>
<li><a href="#_method_subscribemessage">B.1.22. Method: subscribeMessage</a></li>
<li><a href="#_method_subscriberegistration">B.1.23. Method: subscribeRegistration</a></li>
<li><a href="#_method_unregisterhandler">B.1.24. Method: unregisterHandler</a></li>
<li><a href="#_method_unsubscribeentity">B.1.25. Method: unsubscribeEntity</a></li>
<li><a href="#_method_unsubscribemessage">B.1.26. Method: unsubscribeMessage</a></li>
<li><a href="#_method_unsubscriberegistration">B.1.27. Method: unsubscribeRegistration</a></li>
<li><a href="#_method_updaterequest">B.1.28. Method: updateRequest</a></li>
</ul>
</li>
<li><a href="#_notifications">B.2. Notifications</a>
<ul class="sectlevel3">
<li><a href="#_notification_oncompletedregistration">B.2.1. Notification: onCompletedRegistration</a></li>
<li><a href="#_notification_ondeletedentity">B.2.2. Notification: onDeletedEntity</a></li>
<li><a href="#_notification_oninitialinjectionsdone">B.2.3. Notification: onInitialInjectionsDone</a></li>
<li><a href="#_notification_oninjecteddeletedentity">B.2.4. Notification: onInjectedDeletedEntity</a></li>
<li><a href="#_notification_oninjectednewentity">B.2.5. Notification: onInjectedNewEntity</a></li>
<li><a href="#_notification_oninjectedupdatedentity">B.2.6. Notification: onInjectedUpdatedEntity</a></li>
<li><a href="#_notification_onmessage">B.2.7. Notification: onMessage</a></li>
<li><a href="#_notification_onnewentity">B.2.8. Notification: onNewEntity</a></li>
<li><a href="#_notification_onnotmessageoverflow">B.2.9. Notification: onNotMessageOverflow</a></li>
<li><a href="#_notification_onnotrequestoverflow">B.2.10. Notification: onNotRequestOverflow</a></li>
<li><a href="#_notification_onregistered">B.2.11. Notification: onRegistered</a></li>
<li><a href="#_notification_onrevokedregistration">B.2.12. Notification: onRevokedRegistration</a></li>
<li><a href="#_notification_onunregistered">B.2.13. Notification: onUnregistered</a></li>
<li><a href="#_notification_onupdatedentity">B.2.14. Notification: onUpdatedEntity</a></li>
</ul>
</li>
<li><a href="#_receive_and_respond_to_requests">B.3. Receive and respond to requests</a>
<ul class="sectlevel3">
<li><a href="#_method_oncreaterequest">B.3.1. Method: onCreateRequest</a></li>
<li><a href="#_method_ondeleterequest">B.3.2. Method: onDeleteRequest</a></li>
<li><a href="#_method_onservicerequest">B.3.3. Method: onServiceRequest</a></li>
<li><a href="#_method_onupdaterequest">B.3.4. Method: onUpdateRequest</a></li>
</ul>
</li>
<li><a href="#_errors">B.4. Errors</a></li>
</ul>
</li>
<li><a href="#faq">Appendix C: FAQ</a></li>
<li><a href="#_building_from_source">Appendix D: Building from source</a></li>
<li><a href="#_glossary">Glossary</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this document is to provide a comprehensive guide to using the services in Safir SDK Core. The reader should have general knowledge about object-oriented programming. Some knowledge of distributed real-time systems programming is also desirable, but not essential.</p>
</div>
<div class="paragraph">
<p>This document is delivered as part of Safir SDK Core with version tag &#8220;7.3.0&#8221;.</p>
</div>
<div class="sect2">
<h3 id="_how_to_read">How to read</h3>
<div class="paragraph">
<p>This document is intended to be used both as an introduction to new users of the Safir SDK Core, and as a reference for those who have used the SDK for a long time. Because of this the level of the different sections vary quite a lot. Some sections are marked as advanced (with an <sup>adv</sup> tag to them), to signal that they cover advanced topics that can be skipped by newcomers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgements">Acknowledgements</h3>
<div class="paragraph">
<p>This document is a combination of several other documents, so some parts of the text have different authors, or is based on texts authored by other people.</p>
</div>
<div class="paragraph">
<p>More specifically the section on Safir.Utilities.Foreach was written by Stefan Lindström,
and the appendix about the example applications was written by Petter Lönnstedt. Most of
the text on the basic Dob services is based on the original Dob Software User&#8217;s Guide
written by Jörgen Johansson.</p>
</div>
</div>
<div class="sect2">
<h3 id="_versions_of_this_document">Versions of this document</h3>
<div class="paragraph">
<p>To obtain the latest version, please visit <a href="http://safirsdkcore.com/" class="bare">http://safirsdkcore.com/</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="licenses">Licences and Copying</h3>
<div class="literalblock">
<div class="content">
<pre>Copyright (C) 2004 - 2023 Saab AB.
Permission is granted to copy, distribute and/or modify this document
under the terms of the GNU Free Documentation License, Version 1.3
or any later version published by the Free Software Foundation;
with no Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.
A copy of the license is included in the source code distribution and it
is also available from https://www.gnu.org/licenses.</pre>
</div>
</div>
<div class="paragraph">
<p>Safir SDK Core itself is available under the GPL v3 (GNU General Public License version 3) license from <a href="http://safirsdkcore.com" class="bare">http://safirsdkcore.com</a> or a commercial license from Saab AB.</p>
</div>
<div class="paragraph">
<p>The GPL license means that you are free to try out or modify the software to your hearts content and create your own applications on top of it. But you are not allowed to distribute the modified software or your applications (which will classify as derivative works) without releasing your code under the GPL license too. If you want to do this you need to obtain (and pay for&#8230;&#8203;) a commercial license from Saab AB (contact information at <a href="http://www.saabgroup.com" class="bare">http://www.saabgroup.com</a>).</p>
</div>
<div class="paragraph">
<p>For more information on the GPL v3 license, see <a href="http://gplv3.fsf.org/" class="bare">http://gplv3.fsf.org/</a>.</p>
</div>
<div class="paragraph">
<p>Portions of the source code has other licenses and other copyright holders. These are
listed in the file source package file build/packaging/debian/copyright.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_safir_sdk_core">1. What is Safir SDK Core?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core is a middleware and platform for creation of distributed soft real-time
systems. It is Scalable, Reliable, Portable, and last but not least, it is Open!</p>
</div>
<div class="paragraph">
<p>Safir SDK Core is based on modern architectural principles and has a solid foundation in
more than 20 years of experience of development of distributed systems at Saab AB.</p>
</div>
<div class="sect2">
<h3 id="_provided_services">1.1. Provided services</h3>
<div class="paragraph">
<p>Safir SDK Core is mainly aimed at providing data distribution for distributed real-time systems and information systems, but there are a few other services included in Safir SDK Core, mostly because they are needed internally. <a href="#sdk_service_summary">Components and Services in Safir SDK Core</a> contains a summary of the services provided by Safir SDK Core.</p>
</div>
<div class="paragraph">
<p>Safir SDK Core consists of a number of <em>components</em>, some of which have cryptic four-letter acronyms as names. Each component provides one or more services. This document tries not to use the cryptic acronyms, but rather talks about the services provided, but it is good to know about them.</p>
</div>
<table id="sdk_service_summary" class="tableblock frame-ends grid-none" style="width: 80%;">
<caption class="title">Table 1. Components and Services in Safir SDK Core</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 15%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component/Service</th>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Provided Service(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low Level Utility Functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lluf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low level functions that are not provided by Boost.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logging</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Send log messages to the Safir Log mechanism.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distribution</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low level communication mechanism.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed Objects Type system</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dots</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type system used for the distributed objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed Objects Service</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dose</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inter-process and inter-computer distribution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Control</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Application launching and monitoring (currently limited implementation).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dob Utility Functions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Douf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Utility functions for applications using the Dob.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Software Reports</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Swre</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debug trace logging.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dob Persistence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Dope</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Persistent storage of Dob entities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foreach</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Functionality for operating on multiple entity instances.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When we talk about <em>the Dob</em> what is really meant is the services provided by Dots, Dose and Dope, i.e. distributed objects with optional persistence.</p>
</div>
<div class="paragraph">
<p>Component dependencies and the layered architecture of Safir SDK Core is illustrated in <a href="#sdk_core_component_dependencies">Safir SDK Core component dependencies</a>.</p>
</div>
<div id="sdk_core_component_dependencies" class="imageblock">
<div class="content">
<a class="image" href="images/block_diagram.png"><img src="images/block_diagram.png" alt="Component Dependencies"></a>
</div>
<div class="title">Figure 1. Safir SDK Core component dependencies</div>
</div>
<div class="paragraph">
<p>Again, to be able to use Safir SDK Core you do not need to understand or like these acronyms, but knowing that they are there may make some things in the SDK easier to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="_why_core">1.2. Why &#8220;Core&#8221;?</h3>
<div class="paragraph">
<p>Saab sells another product Safir SDK, which is not open-source, which consists of Safir
SDK Core plus a number of services that are very useful when building systems for both
the civilian and military markets.</p>
</div>
<div class="paragraph">
<p>The additional services that Safir SDK provides include Alert handling, Application and Node redundancy control, communication over low-bandwidth and low connectivity media (e.g. radios of different kinds), track handling and correlation etc.</p>
</div>
<div class="paragraph">
<p>Contact Saab AB for more information (contact information at <a href="http://www.saabgroup.com" class="bare">http://www.saabgroup.com</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_prerequisites_dependencies">1.3. Prerequisites / Dependencies</h3>
<div class="paragraph">
<p>Safir SDK Core uses the <em>Boost</em> library to provide low level functionality and operating system independence wrappers. See <a href="http://www.boost.org/" class="bare">http://www.boost.org/</a> for more information.</p>
</div>
<div class="paragraph">
<p>Safir SDK Core also uses some other open source libraries, such as Qt for C++ widgets and CMake for building. See the build instructions for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_supported_platforms">1.4. Supported Platforms</h3>
<div class="paragraph">
<p>Safir SDK Core supports both the Windows and Linux platforms on the x86 and x86_64 platforms. It also successufully builds and runs on ARM Linux, but we have not tested this extensively.</p>
</div>
<div class="paragraph">
<p>Obviously it is possible to combine all these platforms into one system and use Safir SDK Core for communication (after all what use is a middleware if it isn&#8217;t platform independent).</p>
</div>
<div class="paragraph">
<p>An application should, written correctly using Boost and Safir SDK Core, be portable to all the supported platforms with no or very little effort.</p>
</div>
<div class="paragraph">
<p>The compilers that we use for building and testing for the C++ code are GNU gcc (version
9 or later), Microsoft Visual Studio (2015, 2017, 2019 and 2022). For C# code we use Visual
Studio (2015, 2017, 2019 and 2022) or Mono (version 6.8 or later). Any Java 11 compiler should be
able to compile the Java code (we&#8217;ve used Temurin for Windows and plain OpenJDK for Linux). We strive to make all
our code standards compliant, so other versions and compilers <em>should</em> work.</p>
</div>
<div class="paragraph">
<p>There is more information about platform support on the
<a href="https://github.com/SafirSDK/safir-sdk-core/wiki/Platform-Support">Safir SDK Core wiki</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_the_dob">2. What is the Dob?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes what the Dob does and a little bit about why it does it the way it does.</p>
</div>
<div class="sect2">
<h3 id="_what_does_the_dob_do">2.1. What does the Dob do?</h3>
<div class="paragraph">
<p>The Dob provides several distribution mechanisms needed to create distributed real-time systems. It is possible to interface with the Dob from several languages. Currently we provide C++, C#, and Java interfaces.</p>
</div>
<div class="paragraph">
<p>The main &#8220;selling points&#8221; include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Completely transparent addressing on single or multi-node systems.</p>
</li>
<li>
<p>Supports <em>both</em> request/response and publish/subscribe idioms.</p>
</li>
<li>
<p>Easy-to-use Persistency.</p>
</li>
<li>
<p>Support for redundancy and hot-standby.</p>
</li>
<li>
<p>Language independent inter-process and inter-computer communication.</p>
</li>
<li>
<p>Supports use of a modular information model.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_a_bit_about_the_dob_architecture">2.1.1. A bit about the Dob architecture</h4>
<div class="paragraph">
<p>From the user perspective the Dob itself consists of two parts that together provide the
object distribution mechanism. These two parts are the type system (Dots), which provides
the language independent types and manages the definitions of the objects to distribute,
and the distribution mechanism (Dose), which does the actual data disfstart an d sttribution and
synchronisation.</p>
</div>
<div class="paragraph">
<p>To use the Dob an application includes the language specific interface part of the Dob interface into the application. This language specific interface in turn uses language independent libraries (written in C++) to manage the objects and to communicate with other parts of the Dob.</p>
</div>
<div class="paragraph">
<p>To run the Dob there is an executable, "safir_control", that must be running. This
executable is responsible launching and monitoring the process that manages the
distribution of data between applications and nodes in the system.</p>
</div>
<div class="paragraph">
<p>Within a node all data distribution is done through shared memory, and between the nodes it is UDP/IP communication (with a reliable protocol on top, to guarantee delivery).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_which_problem_does_the_dob_solves">2.2. Which problem does the Dob solves?</h3>
<div class="paragraph">
<p>The Dob is appropriate for distribution of data between applications (in the same, or another, computer) in real-time and information systems, since it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Has no infinite queues.</p>
</li>
<li>
<p>Is event driven (no polling).</p>
</li>
<li>
<p>Is asynchronous (no RPC, no blocking calls).</p>
</li>
<li>
<p>Designed to provide bounded latency.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Dob implements a distributed object cache, making it possible to either read object information synchronously from shared memory, or to subscribe to object changes.</p>
</div>
<div class="paragraph">
<p>The Dob provide services so that applications (possibly written in different languages) running on Windows and Linux platforms can communicate transparently.</p>
</div>
</div>
<div class="sect2">
<h3 id="_quick_intro">2.3. Quick intro</h3>
<div class="paragraph">
<p>The Dob provides three distribution mechanisms; Messages, Services and Entities. These three fulfil different needs in a distributed real time system, and have different characteristics and provide different guarantees.</p>
</div>
<div class="paragraph">
<p>This section describes these, and then goes on to describe how the objects are defined.</p>
</div>
<div class="sect3">
<h4 id="_messages">2.3.1. Messages</h4>
<div class="paragraph">
<p>Messages are data that any application can subscribe to and any application can send. Messages do not have owners in any useful sense. When an application sends a message, the Dob forwards it to all subscribers of that message.</p>
</div>
<div class="paragraph">
<p>No record is kept of messages, i.e. they are not stored in the Dob in any way. So once the message has been sent there is no way of getting hold of it again.</p>
</div>
<div class="paragraph">
<p>Messages do not have guaranteed delivery. If some application cannot keep up with the rate of messages it will miss messages. If you need guaranteed delivery, messages are not what you are looking for.</p>
</div>
</div>
<div class="sect3">
<h4 id="service_overview">2.3.2. Services</h4>
<div class="paragraph">
<p>A Service has one or more handlers (known as a Service Handler) to which any application (known as a Requestor) can send service requests. For each service request that is sent, a response is received. The response is sent by the Service Handler, and should indicate the result of the operation (i.e. success or failure, with or without result data). If the service handler does not send a response within a reasonable amount of time (configurable, see <a href="#request_timeout_config">Request timeouts config</a>), the Dob will send a timeout response to the requestor.</p>
</div>
<div class="paragraph">
<p>Service requests and responses are guaranteed to be delivered. And you are guaranteed a response if you have sent a request, even if it may be a timeout response if the handler is overloaded.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entities">2.3.3. Entities</h4>
<div class="paragraph">
<p>An entity is a <em>class</em> of which there can be objects (known as instances) that are stored in the Dob and has one (and only one) owner. Only the owner is allowed to modify the object. Any application can subscribe for a entity instances, which means that it will receive updates whenever the instances are changed. Applications can also send requests (very similar to the service requests above) to the entity owner asking it to change something in the object.</p>
</div>
<div class="paragraph">
<p>Entity requests and responses are guaranteed to be delivered. And you are guaranteed a response if you have sent a request (this may be a timeout response, just as for service requests, as described above). Entity updates are guaranteed to reach all subscribers, with one important caveat; subscribers are not guaranteed to see all intermediate states of an entity. E.g. if an application misses one update the next update will look as if both things changed at once.</p>
</div>
</div>
<div class="sect3">
<h4 id="_defining_the_information_model">2.3.4. Defining the information model</h4>
<div class="paragraph">
<p>The Dob allows each application/component that wants to provide a Dob interface (as in a Service, Message or Entity that other applications/components can use) to contribute to the information model by specifying its objects in xml files, which are built into the information model.</p>
</div>
<div class="paragraph">
<p>The xml files are used to generate language interfaces, that any application that wishes to use an object can include and use.</p>
</div>
<div class="sect4">
<h5 id="_defining_objects">2.3.4.1. Defining objects</h5>
<div class="paragraph">
<p>New types are defined by inheritance from a number of predefined classes. The classes for the distribution mechanisms are Safir.Dob.Message, Safir.Dob.Service, Safir.Dob.Entity, Safir.Dob.SuccessResponse and Safir.Dob.ErrorResponse.</p>
</div>
<div class="paragraph">
<p>All classes are defined off-line using xml in a file called a <em>dou</em>-file (named after its extension; ".dou"). These dou-files are then used to generate and compile language specific interfaces to that specific class. Applications use these generated interfaces for operating on the objects.</p>
</div>
<div class="paragraph">
<p>The dou-files are also used by the Dob to create binary chunks (usually called <em>blobs</em>) from the classes that can be sent to other nodes over a network. The dou-file information is of course also needed to interpret these blobs. The dou-files can also contain parameters for the applications. These parameters are read by the Dob at start-up, so no recompilation is required for parameter changes.</p>
</div>
<div class="paragraph">
<p>When a member is added to an object it is only necessary to regenerate/recompile the interface, and not the applications that use it. An application that is built against a previous version of the object will still work correctly (although it, of course, is unaware of the new member).</p>
</div>
<div class="paragraph">
<p>Here is an example of a dou-file for a simple entity (containing one 32-bit integer):</p>
</div>
<div class="listingblock">
<div class="title">A simple dou-file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;summary&gt;</span>This is an example entity<span class="nt">&lt;/summary&gt;</span>
  <span class="nt">&lt;name&gt;</span>MyEntity<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Entity<span class="nt">&lt;/baseClass&gt;</span>
  <span class="nt">&lt;members&gt;&lt;member&gt;</span>
    <span class="nt">&lt;name&gt;</span>TheNumber<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
  <span class="nt">&lt;/member&gt;&lt;/members&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is described in greater detail in the next chapter.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_type_system">3. The type system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One "half" of the Dob consists of a type system that is used to describe and manage the types in the Dob. This is needed to be able to create objects that are language inter-operable and to have types that it is possible to use in heterogeneous systems (e.g different nodes having different processor architectures and operating systems).</p>
</div>
<div class="paragraph">
<p>All Safir systems are based around types defined using the Dob type system.</p>
</div>
<div class="paragraph">
<p>A Dob object is made up of <em>members</em>, that can be simple or complex types (and collections of these).</p>
</div>
<div class="paragraph">
<p>The type system also provides functionality for defining run-time parameters (values are loaded at start-up) and properties, that provide a common interface for accessing members of different classes.</p>
</div>
<div class="sect2">
<h3 id="_the_simple_types">3.1. The simple types</h3>
<div class="paragraph">
<p>These are the simple types that class members can have, either as single members or in
collections (it is also possible to put objects inside objects, which is described
below).</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 2. The simple Dob type system types.</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">As defined in each supported language.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enumeration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Routines for conversion to/from strings are generated.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Int32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 byte signed integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Int64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 byte signed integer.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 byte floating point value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">8 byte floating point value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TypeId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reference to a Dob class or enumeration.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ChannelId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Message channel identifier (see <a href="#hashed_types">Hashed types</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HandlerId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A Service or Entity handler identifier (see <a href="#hashed_types">Hashed types</a>)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">InstanceId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An Entity instance identifier (see <a href="#hashed_types">Hashed types</a>).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EntityId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An aggregate of a TypeId and an InstanceId. A reference to an Entity instance</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unicode string. Size is defined in number of Unicode characters.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary data. An arbitrary sequence of bytes.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_si_types">3.1.1. SI types</h4>
<div class="paragraph">
<p>The Dob type system also has definitions for the SI units. This makes it easier to specify what values are expected in objects. If a member is called "Angle" it should have a type of Radian32; this makes it easy for object users to know what to expect from the member. If it had been defined as a Float32 the users would have to find out from somewhere else what the expected contents are supposed to be; should there be radians, degrees, gons or mils in there?</p>
</div>
<div class="paragraph">
<p>The SI unit types are all based on Float32 or Float64 respectively:</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 60%;">
<caption class="title">Table 3. Types for SI units.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">4 byte type</th>
<th class="tableblock halign-left valign-top">8 byte type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ampere32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ampere64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CubicMeter32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CubicMeter64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hertz32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Hertz64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Joule32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Joule64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kelvin32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kelvin64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kilogram32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kilogram64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meter32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meter64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MeterPerSecond32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MeterPerSecond64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MeterPerSecondSquared32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MeterPerSecondSquared64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Newton32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Newton64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pascal32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pascal64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Radian32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Radian64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RadianPerSecond32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RadianPerSecond64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RadianPerSecondSquared32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RadianPerSecondSquared64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SquareMeter32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SquareMeter64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steradian32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Steradian64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Volt32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Volt64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Watt32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Watt64</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="hashed_types">3.1.2. Hashed types</h4>
<div class="paragraph">
<p>The InstanceId, ChannelId and HandlerId types are <em>hashed types</em>. They can be defined either as a string or as a number. If defined as a number the number will be used as the value, but if defined by a string, the string is hashed and the hash is used as the value.</p>
</div>
<div class="paragraph">
<p>If a string is used to define hashed type, the string will be included in the type, but is only meant to be used for reference (the hash value is used for all built-in operations). There is a method on all the hashed types, <code>RemoveString</code>, that removes the string to save space/bandwidth.</p>
</div>
</div>
<div class="sect3">
<h4 id="binary_data">3.1.3. Binary type</h4>
<div class="paragraph">
<p><em>Binary</em> is a simple type that can be used for binary data of any size. When the Binary
type is used in parameters and xml or json serialized objects, the data is encoded to
base64 format.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="member_flags">3.2. Flags on members</h3>
<div class="paragraph">
<p>Each member inside a Dob object has two flags associated with it. One <em>IsNull</em> flag and one <em>IsChanged</em> flag. The purpose of the IsNull flag is to allow all members to, apart from their normal values, have a state where they&#8217;re not set or unknown. The IsChanged-flag allows the Dob and applications to signal <em>intent as well as content</em> when transmitting data, for example indicating what has changed in an entity between two subscription responses.</p>
</div>
<div class="paragraph">
<p>All members have methods to access these flags, <code>IsNull</code> and <code>IsChanged</code>, and the flags can be manipulated using the <code>SetChanged</code> and <code>SetNull</code> methods.</p>
</div>
<div class="paragraph">
<p>The change flags are described in greater detail in <a href="#change_flags">Change flags</a> and <a href="#interpreting_change_flags">Interpreting change flags</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="items_and_structs">3.3. Items and structs</h3>
<div class="paragraph">
<p>Apart from simple types such as integers and strings and collections of these, classes
can also contain other classes. These complex types or "contained classes" are usually
called <em>Items</em> (due to the fact that they should inherit from Safir.Dob.Item).</p>
</div>
<div class="paragraph">
<p>An Item works exactly the same way as any other Dob class apart from the fact that it is not possible to send it to another application without putting it inside an object that is distributable (i.e. a Message, Entity, Service or Response). An item has change flags and null flags just like any other member, and all of the item&#8217;s members have change flags and null flags too.</p>
</div>
<div class="paragraph">
<p>All these flags mean that there is a certain overhead to items, which in many cases is undesirable. And also, it doesn&#8217;t always make sense to have null and change flags on all members of items. For example, in a Position type, there is no point in setting the Latitude member to null. Either the position as a whole is null or it is a valid position. For this purpose <em>Structs</em> (inheriting from Safir.Dob.Struct) were introduced. Currently they behave exactly like an Item, but in a future Dob version they will be optimised so as to remove all the flags and overhead.</p>
</div>
<div class="paragraph">
<p>This means that there are some limitations to what you should do to a Struct. Do not use IsChanged or IsNull on any members of a struct. Instead check IsNull and IsChanged on the whole struct. Do not inherit from a user-defined struct (structs will not support inheritance). In the current Dob this will of course work, but once the optimisation is introduced your code will break.</p>
</div>
</div>
<div class="sect2">
<h3 id="collections">3.4. Collections</h3>
<div class="paragraph">
<p>The Dob type system supports three kinds of collections. <em>Arrays</em>, <em>Sequences</em> and
<em>Dictionaries</em>.</p>
</div>
<div class="paragraph">
<p>An array is a fixed-length integer-indexed collection of simple or complex members. Each
index has its own IsNull and IsChanged flag.</p>
</div>
<div class="paragraph">
<p>A sequence is a variable-length collection of simple or complex members. There is only an
IsChanged flag on the whole collection, i.e. not on individual elements. The change flag
will be set whenever a value is added, removed or replaced. IsChanged/SetChanged on
sequences containing objects are be recursive, just as you would expect. Sequences do not
have a real IsNull flag, but instead <code>IsNull()</code> is equivalent to the sequence being <code>empty()</code>,
and calling <code>SetNull()</code> is the same as calling <code>clear()</code>.</p>
</div>
<div class="paragraph">
<p>A dictionary is a variable-length collection of key-value pairs. The keys can be any
simple type (with some exceptions, i.e. Boolean and floating point types) and the values
can be simple or complex members. Each value has its own IsNull and IsChanged flags, and
the collection itself has an IsChanged flag that will be set whenever a value is added or
removed.</p>
</div>
<div class="sect3">
<h4 id="_a_note_on_collections_in_java">3.4.1. A note on collections in Java</h4>
<div class="paragraph">
<p>Due to the nature of function overloading in Java the operations for adding elements to
dictionaries and sequences in Java differ slightly from the other languages. The <code>put()</code>
function expects a <em>Container</em>, not a value, which makes it rather difficult to work
with. Unfortunately it is not possible to overload this function in a sensible way, so
instead there is another operation <code>putVal()</code> (or <code>putObj()</code> for objects). Use this
operation to not have to worry about the containers.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>Use <code>putVal(&#8230;&#8203;)</code>/<code>putObj(&#8230;&#8203;)</code> instead of <code>put(&#8230;&#8203;)</code> when adding elements to collections
in Java.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="parameters">3.5. Parameters</h3>
<div class="paragraph">
<p>Apart from members a class can also contain constant parameters. These parameters are not
compile-time constants, instead they are read from the dou-files by the Dob when it
starts and applications can ask for the values by a simple function call. This means that
all that is needed to change a parameter is to change its value in the dou file, or to
add a copy of the dou file, with modifications, in an override directory, as described in
<a href="#typesystem_ini">typesystem.ini</a>) and restarting the Dob and all the applications that use the Dob
(note that running the code generation, as described in <a href="#code_generation">Generating code from Dou-files</a>, will
overwrite these changes).</p>
</div>
<div class="paragraph">
<p>Parameters are defined by a name, a type and a value. Here is an example of a parameter
definition (it is cut out of its context, but it goes in the dou-file at the same level
as the <em>members</em>-tag).</p>
</div>
<div class="listingblock">
<div class="title">Example of parameter definitions</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;summary&gt;</span>An example parameter file.<span class="nt">&lt;/summary&gt;</span>
    <span class="nt">&lt;name&gt;</span>Capabilities.MyParameters<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Parametrization<span class="nt">&lt;/baseClass&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyStringParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>Safir SDK Core, for truly distibuted systems<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyInt32Parameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>25<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyFloat32Parameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Float32<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>3.14<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyBooleanParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Boolean<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>True<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyWeekdayParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Capabilities.MyWeekdayEnum<span class="nt">&lt;/type&gt;</span> <span class="c">&lt;!--assumes this type has been defined in another dou-file--&gt;</span>
            <span class="nt">&lt;value&gt;</span>Monday<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyTypeId<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>TypeId<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>Safir.Dob.Item<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyInstanceId<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>InstanceId<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>myNamedInstance<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- name or hash are valid, same sytax for ChannelId and HandlerId --&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyEntityId<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>EntityId<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;entityId&gt;</span>
                <span class="nt">&lt;name&gt;</span>Safir.Dob.Entity<span class="nt">&lt;/name&gt;</span> <span class="c">&lt;!-- name of an entity type --&gt;</span>
                <span class="nt">&lt;instanceId&gt;</span>theOnlyInstance<span class="nt">&lt;/instanceId&gt;</span>
            <span class="nt">&lt;/entityId&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>MyBinaryParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Binary<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>SGVsbG8gV29ybGQ=<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- base64 encoding of the ascii bytes "Hello World" --&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines a number of parameters of different types. For example the parameter MyInt32Parameter that is a 32 bit integer of value 25.</p>
</div>
<div class="paragraph">
<p>It is recommended to keep most parameters in pure parameter classes, suffixed Parameters, that inherit from Safir.Dob.Parametrization. These classes should not contain any members. The reason for this is to make it easier to know where parameters can be found. The Dob does not enforce this recommendation in any way.</p>
</div>
<div class="paragraph">
<p>String members are normally trimmed, i.e. leading and trailing whitespace is removed. This behaviour can be changed by using the attribute <code>xml:space="preserve"</code>.</p>
</div>
<div class="paragraph">
<p>Parameter values can contain CDATA sections and use character references to specify characters by their numeric codes, e.g. <code>&amp;#89;</code>.</p>
</div>
<div class="sect3">
<h4 id="_parameter_arrays">3.5.1. Parameter arrays</h4>
<div class="paragraph">
<p>A parameter can also be an array of values, as shown below, where one array parameter of strings and one array parameter of entityIds are defined with two values each.</p>
</div>
<div class="listingblock">
<div class="title">A parameter array</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;summary&gt;</span>An example parameter file.<span class="nt">&lt;/summary&gt;</span>
    <span class="nt">&lt;name&gt;</span>Capabilities.MyParameters<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Parametrization<span class="nt">&lt;/baseClass&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>StringParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;array&gt;</span>
                <span class="nt">&lt;value&gt;</span>Safir(R)<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;value&gt;</span>(R)rifaS<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;/array&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>EntityIdParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>EntityId<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;array&gt;</span>
                <span class="nt">&lt;entityId&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Safir.Dob.Entity<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;instanceId&gt;</span>one<span class="nt">&lt;/instanceId&gt;</span>
                <span class="nt">&lt;/entityId&gt;</span>
                <span class="nt">&lt;entityId&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Safir.Dob.Entity<span class="nt">&lt;/name&gt;</span>
                    <span class="nt">&lt;instanceId&gt;</span>two<span class="nt">&lt;/instanceId&gt;</span>
                <span class="nt">&lt;/entityId&gt;</span>
            <span class="nt">&lt;/array&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Array indexing starts at 0 when accessing the values from code.</p>
</div>
<div class="paragraph">
<p>In previous versions of Safir SDK Core the array parameter syntax was a bit more bulky. For backward compatibility the old syntax is still supported but is considered deprecated. The example below shows a parameter declaration in the old format.</p>
</div>
<div class="listingblock">
<div class="title">Old syntax array parameter (deprecated)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;summary&gt;</span>An example parameter file.<span class="nt">&lt;/summary&gt;</span>
    <span class="nt">&lt;name&gt;</span>Capabilities.MyParameters<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Parametrization<span class="nt">&lt;/baseClass&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>StringParameter<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;arrayElements&gt;</span>
                <span class="nt">&lt;arrayElement&gt;</span>
                    <span class="nt">&lt;value&gt;</span>Safir(R)<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/arrayElement&gt;</span>
                <span class="nt">&lt;arrayElement&gt;</span>
                    <span class="nt">&lt;value&gt;</span>(R)rifaS<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/arrayElement&gt;</span>
            <span class="nt">&lt;/arrayElements&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_dictionary_parameters">3.5.2. Dictionary parameters</h4>
<div class="paragraph">
<p>A parameter can also be a dictionary of key/value pairs, as shown in the example below.</p>
</div>
<div class="listingblock">
<div class="title">A dictionary parameter of Strings mapped to Float64</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;summary&gt;</span>An example parameter file.<span class="nt">&lt;/summary&gt;</span>
    <span class="nt">&lt;name&gt;</span>Capabilities.MyParameters<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Parametrization<span class="nt">&lt;/baseClass&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>StringsMappedToDoubles<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Float64<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;dictionary</span> <span class="na">keyType=</span><span class="s">"String"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;entry&gt;</span>
                    <span class="nt">&lt;key&gt;</span>Hot<span class="nt">&lt;/key&gt;</span>
                    <span class="nt">&lt;value&gt;</span>65.4321<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
                <span class="nt">&lt;entry&gt;</span>
                    <span class="nt">&lt;key&gt;</span>Cold<span class="nt">&lt;/key&gt;</span>
                    <span class="nt">&lt;value&gt;</span>-12.3456<span class="nt">&lt;/value&gt;</span>
                <span class="nt">&lt;/entry&gt;</span>
            <span class="nt">&lt;/dictionary&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_objects_in_parameters">3.5.3. Objects in parameters</h4>
<div class="paragraph">
<p>Parameters can also contain whole Dou-defined objects, not just the basic types. Below is an example from <code>Safir.Dob.NodeParameters</code>, where there is in fact an array of items in a parameter.</p>
</div>
<div class="listingblock">
<div class="title">A parameter array</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
       ...
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>Nodes<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Safir.Dob.NodeDefinition<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;array&gt;</span>
                <span class="nt">&lt;Safir.Dob.NodeDefinition&gt;</span>
                    <span class="nt">&lt;NodeName&gt;</span>My Server<span class="nt">&lt;/NodeName&gt;</span>
                <span class="nt">&lt;/Safir.Dob.NodeDefinition&gt;</span>
                <span class="nt">&lt;Safir.Dob.NodeDefinition&gt;</span>
                    <span class="nt">&lt;NodeName&gt;</span>My Client<span class="nt">&lt;/NodeName&gt;</span>
                <span class="nt">&lt;/Safir.Dob.NodeDefinition&gt;</span>
                <span class="nt">&lt;Safir.Dob.NodeDefinition</span> <span class="na">type=</span><span class="s">"Safir.Dob.NodeDefinitionSubtype"</span><span class="nt">&gt;</span>
                    <span class="c">&lt;!-- type attribute is needed since we're inserting derived type --&gt;</span>
                    <span class="nt">&lt;NodeName&gt;</span>My Special Client<span class="nt">&lt;/NodeName&gt;</span>
                    <span class="nt">&lt;AnotherValue&gt;</span>5<span class="nt">&lt;/AnotherValue&gt;</span>
                <span class="nt">&lt;/Safir.Dob.NodeDefinition&gt;</span>
            <span class="nt">&lt;/array&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each index in the array contains the xml serialization of an instance of the <code>Safir.Dob.NodeDefinition</code> item (which currently only contains one member, the node name).
Of course this can be done in non-array parameters as well, just leave out all the array stuff.</p>
</div>
<div class="paragraph">
<p>One interesting feature is that you can put any item that <em>derives</em> from <code>Safir.Dob.NodeDefinition</code> into this array (that is the reason for the redundant specification of the <code>type</code> attribute in the objects). The type attribute is only needed when you want to put an instance of a derived type into the member or array element, otherwise it is redundant.</p>
</div>
</div>
<div class="sect3">
<h4 id="environment_parameters">3.5.4. Environment variables in parameters</h4>
<div class="paragraph">
<p>For parameters it is also possible to use environment variables in the parameter value.</p>
</div>
<div class="paragraph">
<p>The syntax for environment variables is <code>$(ENVIRONMENT_VARIABLE_NAME)</code>, and there can be
several environment variables in one parameter. An example use is shown below.</p>
</div>
<div class="listingblock">
<div class="title">Environment variable in parameter.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;parameter&gt;</span>
    <span class="nt">&lt;name&gt;</span>MyParameterWithEnv<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;value&gt;</span>The HOME environment variable points to $(HOME).<span class="nt">&lt;/value&gt;</span>
<span class="nt">&lt;/parameter&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that all parameters are loaded <em>when the first application that uses parameters
starts</em>, so any environment variables set after that time will not be seen by the type
system environment variable expansion.</p>
</div>
<div class="paragraph">
<p>There is also support for <em>special variable</em> expansion using the same syntax as is
described in <a href="#special_variables">Environment and special variable expansion</a>. Special variables have built in magic in order to make them easy to use, for example when specifying operating system paths in parameters.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_routines">3.6. Create routines</h3>
<div class="paragraph">
<p>Create routines allow the designer of a Dob class to define custom routines for creating
commonly used instances of that class.</p>
</div>
<div class="paragraph">
<p>Create routines are similar to constructors. The members to be given as parameters to the
routine, and those to be fetched from parameter definitions are defined. For example:</p>
</div>
<div class="listingblock">
<div class="title">A create routine definition.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;createRoutines&gt;</span>
    <span class="nt">&lt;createRoutine&gt;</span>
        <span class="nt">&lt;summary&gt;</span>Create a position with dummy altitude.<span class="nt">&lt;/summary&gt;</span>
        <span class="nt">&lt;name&gt;</span>Position<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;parameters&gt;</span>
            <span class="nt">&lt;member&gt;</span>Latitude<span class="nt">&lt;/member&gt;</span>
            <span class="nt">&lt;member&gt;</span>Longitude<span class="nt">&lt;/member&gt;</span>
        <span class="nt">&lt;/parameters&gt;</span>
        <span class="nt">&lt;values&gt;</span>
            <span class="nt">&lt;value&gt;</span>
                <span class="nt">&lt;member&gt;</span>Altitude<span class="nt">&lt;/member&gt;</span>
                <span class="nt">&lt;parameter&gt;</span>
                    <span class="nt">&lt;name&gt;</span>Safir.Geodesy.Position.DummyAltitude<span class="nt">&lt;/name&gt;</span>
                <span class="nt">&lt;/parameter&gt;</span>
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/values&gt;</span>
    <span class="nt">&lt;/createRoutine&gt;</span>
<span class="nt">&lt;/createRoutines&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Will result in generated code like:</p>
</div>
<div class="listingblock">
<div class="title">Generated C++ create routine</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cm">/**
 * Create a position with dummy altitude.
 */</span>
<span class="k">static</span> <span class="n">PositionPtr</span> <span class="nf">CreatePosition</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">Si64</span><span class="o">::</span><span class="n">Radian</span> <span class="n">Latitude</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">Si64</span><span class="o">::</span><span class="n">Radian</span> <span class="n">Longitude</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>CreatePosition</code> method will allow the user to create a two-dimensional Position object using only one line of code, instead of having to first create the object, and then set the three members to correct values (Position is a Struct, so it doesn&#8217;t have the null flag for its members, hence the dummy position is used to signal that it is a two-dimensional position).</p>
</div>
<div class="paragraph">
<p>The Altitude member will be set to the value specified in the <code>Safir.Geodesy.Position.DummyAltitude</code> member.</p>
</div>
<div class="paragraph">
<p>The Position class also supplies a create routine for a three-dimensional position, but the two-dimensional one is a better example, since it uses a parameter.</p>
</div>
<div class="paragraph">
<p>From version 5.0 of Safir SDK Core it is also possible to write member values in place instead of referencing parameters the way it&#8217;s done above with the Altitude member. The example could then be written like this instead:</p>
</div>
<div class="listingblock">
<div class="title">In place altitude value.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;createRoutines&gt;</span>
    <span class="nt">&lt;createRoutine&gt;</span>
        ...
        <span class="nt">&lt;values&gt;</span>
            <span class="nt">&lt;value&gt;</span>
                <span class="nt">&lt;member&gt;</span>Altitude<span class="nt">&lt;/member&gt;</span>
                <span class="nt">&lt;value&gt;</span>0<span class="nt">&lt;/value&gt;</span> <span class="c">&lt;!-- No need to declare a dummy parameter --&gt;</span>
            <span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/values&gt;</span>
    <span class="nt">&lt;/createRoutine&gt;</span>
<span class="nt">&lt;/createRoutines&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_syntax_putting_it_all_together">3.7. The syntax - putting it all together</h3>
<div class="paragraph">
<p>As mentioned above classes are defined by creating an Xml-file called a dou-file. The dou-file describes the class and is used to generate the interface code used by the components to interface the Dob. All dou-files have two mandatory fields that describe the name of the class and its base class. The <em>name</em> field contains both the name of class and the namespace the class is located in, and the <em>baseClass</em> field contains the base class (and its namespace) to inherit from.</p>
</div>
<div class="paragraph">
<p>In the example below the name is Vehicle and the Vehicle class is located in the namespace Vehicles which is located in the namespace Capabilities. The class is referenced by other classes as Capabilities.Vehicles.Vehicle. The Vehicle class is an Entity (that resides in the Safir.Dob namespace).</p>
</div>
<div class="listingblock">
<div class="title">Start of a dou-file class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;summary&gt;</span>Definition of vehicle entity<span class="nt">&lt;/summary&gt;</span>
    <span class="nt">&lt;name&gt;</span>Capabilities.Vehicles.Vehicle<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Entity<span class="nt">&lt;/baseClass&gt;</span></code></pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">A note on namespaces</div>
<div class="paragraph">
<p>The top-level namespace <em>Safir</em> is reserved for Dob classes belonging to Safir and shall not be used for classes not belonging to Safir.</p>
</div>
<div class="paragraph">
<p>One of the main purposes of Safir SDK is to promote reusable code. Due to this Saab recommends <strong>not</strong> using project names as top-level namespaces (or indeed any part of the namespace), since this will cause problems when reusing those components in another project.</p>
</div>
<div class="paragraph">
<p>Saab uses <em>Capabilities</em> as the top-level namespace for reusable components built on Safir. Non-top-level namespaces should not be component or project specific names but rather service oriented names describing the functionality of the classes in that namespace. As an example the class <code>Capabilities.Vehicles.Vehicle</code> is a class in a reusable component for handling vehicles.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Arrays are declared by adding the field <code>arraySize</code> to an element or constant as shown in
the example below.</p>
</div>
<div class="listingblock">
<div class="title">Array member declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;name&gt;</span>Type<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;arraySize&gt;</span>10<span class="nt">&lt;/arraySize&gt;</span>
        <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Sequences are declared by adding the field <code>sequence</code> to an element or constant as shown
in the example below.</p>
</div>
<div class="listingblock">
<div class="title">Sequence member declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;name&gt;</span>Type<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;sequence/&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dictionaries are declared by adding the field <code>dictionary</code> to an element or constant as
shown in the example below. The key type is specified using the <code>keyType</code> attribute.</p>
</div>
<div class="listingblock">
<div class="title">Declaration of dictionary of strings mapped to 32 bit integers</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;name&gt;</span>Type<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;dictionary</span> <span class="na">keyType=</span><span class="s">"String"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For strings the maximum length in number of Unicode characters can be defined using the
<code>maxLength</code> tag.</p>
</div>
<div class="listingblock">
<div class="title">String member declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;name&gt;</span>Callsign<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;maxLength&gt;</span>10<span class="nt">&lt;/maxLength&gt;</span> <span class="c">&lt;!-- Optional --&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Exceeding the maxiumum string length (i.e. setting a string that is too long) will cause
an exception to be thrown <em>when the object is serialized</em>, e.g. when a Message is
transmitted. If no maximum length is specified the strings can be Very Long<sup>TM</sup>.</p>
</div>
<div class="paragraph">
<p>The string lengths and array sizes can also be specified with parameters. The tags
used for this is arraySizeRef and maxLenghtRef, and the parameter name must be fully
qualified (full namespace and class name).</p>
</div>
<div class="listingblock">
<div class="title">Parameters and members</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;parameters&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>ArraySize<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
        <span class="nt">&lt;parameter&gt;</span>
            <span class="nt">&lt;name&gt;</span>StringLength<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/parameter&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
    <span class="nt">&lt;members&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;name&gt;</span>Type<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;arraySizeRef&gt;</span>
                <span class="nt">&lt;name&gt;</span>Capabilities.Vehicles.Vehicle.ArraySize<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;/arraySizeRef&gt;</span>
            <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;name&gt;</span>Callsign<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
            <span class="nt">&lt;maxLengthRef&gt;</span>
                <span class="nt">&lt;name&gt;</span>Capabilities.Vehicles.Vehicle.StringLength<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;/maxLengthRef&gt;</span>
        <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, as mentioned in <a href="#parameters">Parameters</a> it is recommended that parameters are placed in separate parameter classes.</p>
</div>
<div class="paragraph">
<p>It is possible - indeed it is even recommended - to add comments to most fields in dou-files since these comments will be put into the generated code in a style that is appropriate for the specific language.</p>
</div>
<div class="listingblock">
<div class="title">A commented member</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;summary&gt;</span>This is a callsign.<span class="nt">&lt;/summary&gt;</span>
            <span class="nt">&lt;name&gt;</span>Callsign<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>Int32<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_properties_adv">3.8. Properties <sup>adv</sup></h3>
<div class="paragraph">
<p>A property is not an object on its own. It is merely an interface into other objects. The way that a property interfaces into an object is defined at start-up, <em>so it is possible to change the way the interface works without recompiling any applications.</em></p>
</div>
<div class="paragraph">
<p>The interface itself is specified in a dou-file which is slightly different from class definitions.</p>
</div>
<div class="listingblock">
<div class="title">A simple property (NamedObject)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;property</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;name&gt;</span>Safir.NamedObject<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;members&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;name&gt;</span>Name<span class="nt">&lt;/name&gt;</span>
            <span class="nt">&lt;type&gt;</span>String<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;/members&gt;</span>
<span class="nt">&lt;/property&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create a <em>dom</em>-file (has .dom as its extension) to define to which object member the property member is mapped.</p>
</div>
<div class="listingblock">
<div class="title">A NamedObject mapping for Vehicle</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;propertyMapping</span> <span class="na">xmlns=</span><span class="s">"urn:safir-obj"</span>
        <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property&gt;</span>Safir.NamedObject<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;class&gt;</span>Capabilties.Vehicles.Vehicle<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;memberMapping&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;propertyMember&gt;</span>Name<span class="nt">&lt;/propertyMembert&gt;</span>
            <span class="nt">&lt;classMemberReference&gt;</span>
                <span class="nt">&lt;classMember&gt;</span>Callsign<span class="nt">&lt;/classMember&gt;</span>
            <span class="nt">&lt;/classMemberReference&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;/memberMapping&gt;</span>
<span class="nt">&lt;/propertyMapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping above specifies that the member Name in the NamedObject property is mapped to the Callsign member of the Vehicle object.</p>
</div>
<div class="paragraph">
<p>It is also possible to map property members to values (either to direct values or to references to parameters) or to null.</p>
</div>
<div class="listingblock">
<div class="title">Property mapping to value or parameter</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;propertyMember&gt;</span>Int32Member<span class="nt">&lt;/propertyMember&gt;</span>
        <span class="nt">&lt;value&gt;</span>10<span class="nt">&lt;/value&gt;</span>
    <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;propertyMember&gt;</span>Int64Member<span class="nt">&lt;/propertyMember&gt;</span>
        <span class="nt">&lt;valueRef&gt;</span>
            <span class="nt">&lt;name&gt;</span>Safir.UnitParameters.SomeParameter<span class="nt">&lt;/name&gt;</span>
        <span class="nt">&lt;/valueRef&gt;</span>
    <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;propertyMember&gt;</span>NullMember<span class="nt">&lt;/propertyMember&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is even possible to map to members that reside inside an item array inside the mapped class.</p>
</div>
<div class="listingblock">
<div class="title">Property mapping into an array</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml">    <span class="nt">&lt;member&gt;</span>
        <span class="nt">&lt;propertyMember&gt;</span>Int64Member<span class="nt">&lt;/propertyMember&gt;</span>
        <span class="nt">&lt;classMemberReference&gt;</span>
            <span class="nt">&lt;classMember&gt;</span>ItemArrayMember<span class="nt">&lt;/classMember&gt;</span>
            <span class="nt">&lt;index&gt;</span>2<span class="nt">&lt;/index&gt;</span>
            <span class="nt">&lt;classMemberReference&gt;</span>
                <span class="nt">&lt;classMember&gt;</span>TheMemberIWanted<span class="nt">&lt;/classMember&gt;</span>
            <span class="nt">&lt;/classMemberReference&gt;</span>
        <span class="nt">&lt;/classMemberReference&gt;</span>
    <span class="nt">&lt;/member&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And so on&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>All fields in the property have to be mapped to something (i.e. a member, parameter or to null) to be a complete mapping. Dom-files have to be named "&lt;mapped class name&gt;-&lt;property name&gt;.dom", e.g. "Capabilties.Vehicles.Vehicle-Safir.NamedObject.dom".</p>
</div>
<div class="paragraph">
<p>It is possible to use properties on any kind of object except Structs. So the same property could be mapped into an item, an entity, a service and a response.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Properties are inherited</div>
<div class="paragraph">
<p>Property mappings are inherited, so, for example, any class that inherits from Safir.Vehicles.Vehicle will inherit the property mapping defined above. The derived class can override the inherited property mapping by supplying its own mapping.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_property">3.8.1. Using the property</h4>
<div class="paragraph">
<p>To use the property you need to have an object of a type that is mapped to it. For example you could have set up a subscription to Capabilities.Vehicles.Vehicle (which is mapped to the NamedObject property).</p>
</div>
<div class="listingblock">
<div class="title">Using a property</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="nf">DisplayName</span><span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">ObjectPtr</span> <span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">name</span> <span class="o">=</span> <span class="n">Safir</span><span class="o">::</span><span class="n">NamedObject</span><span class="o">::</span><span class="n">GetName</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="p">...</span> <span class="n">display</span> <span class="n">the</span> <span class="n">name</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that in the code above there is no reference at all to what kind of object <code>obj</code> is. It could be any object that has the property mapped to it. It is possible to check if an object has a specific property mapped to it using the <code>HasProperty</code> method on the property.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="code_generation">3.9. Generating code from Dou-files</h3>
<div class="paragraph">
<p>In order to use the classes defined by the Dou-files, interface code has to be generated
for the different languages. First, source code has to be generated from the dou-files and
then this source code needs to be built into loadable libraries suitable for your language and
platform (e.g. dlls, shared libraries, or assemblies). Then libraries and header files have to
be installed into a location where they can be accessed by your programs.</p>
</div>
<div class="paragraph">
<p>The easiest way to perform all these steps is using CMake and <em>dobmake</em>, for which you will need to
install CMake (version 2.8 or later) and Python (version 2.7 or later).</p>
</div>
<div class="paragraph">
<p>You need to have your dou files in one or more directories, and in each directory you
will need to put a file named <code>CMakeLists.txt</code>. This file is a CMake control file that
contains the information needed to build the code in that directory (for more information
on CMake, visit <a href="http://www.cmake.org" class="bare">http://www.cmake.org</a>).</p>
</div>
<div id="cmake-simple" class="listingblock">
<div class="title">Simple CMakeLists.txt for building a safir_generated module out of two dou files</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="cmake"><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.16<span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span>SafirSDKCore REQUIRED<span class="p">)</span>

<span class="nf">add_safir_generated_library</span><span class="p">(</span>
  NAME Test1
  DEPENDENCIES Core
  DOU_FILES Dobmake.Test1.dou
            Dobmake.Test2.dou<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Above is a simple CMakeLists.txt file that will build a module out of two dou files, named
<code>Dobmake.Test1.dou</code> and <code>Dobmake.Test2.dou</code>. The names of the resulting binaries will be
as defined in <a href="#dobmake-binaries">Names of binaries generated by dobmake</a>, with <code>&lt;name&gt;</code> replaced by the value passed as the
<code>NAME</code> argument to <code>add_safir_generated_library</code>. The <code>DEPENDENCIES</code> argument specifies
that the dou file contains a dependency to the Core dou files, e.g. Safir.Dob.Entity.dou
etc.</p>
</div>
<div class="paragraph">
<p>The full documentation of <code>add_safir_generated_library</code> can be found in the
SafirSDKCoreConfig.cmake file that is installed as part of the Safir SDK Core
installation package. Please read that information, since there are more things
that you can do with this function than what has been described here.</p>
</div>
<table id="dobmake-binaries" class="tableblock frame-ends grid-none" style="width: 90%;">
<caption class="title">Table 4. Names of binaries generated by dobmake</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Linux file name</th>
<th class="tableblock halign-left valign-top">Windows file names</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C++ shared library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">libsafir_generated-&lt;name&gt;-cpp.so</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-cpp.dll<br>
safir_generated-&lt;name&gt;-cppd.dll</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C++ link library</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-cpp.lib<br>
safir_generated-&lt;name&gt;-cppd.lib</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C# assembly</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-dotnet.dll</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-dotnet.dll</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Java archive</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-java.jar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">safir_generated-&lt;name&gt;-java.jar</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you are using cmake for your own project, you can incorporate your dou-file
cmake files into your &#8220;build tree&#8221;. If you are using another build system, or
are not using a build tree in cmake you will need to install the produced binaries
and C++ header files somewhere where your code can find them.</p>
</div>
<div id="cmake-install" class="listingblock">
<div class="title">CMakeLists.txt commands for installing safir_generated files</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="cmake"><span class="c1">#relative paths, relative to CMAKE_INSTALL_PREFIX</span>
<span class="nf">install_safir_generated_library</span><span class="p">(</span>
  TARGETS Test1
  CXX_RUNTIME bin
  CXX_LIBRARY lib
  CXX_INCLUDE include
  JAR java
  DOTNET dotnet
  DOU_BASE dou<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Above is an example of an installation directive for the binaries and include files
generated from the Test1 module. In the example the installation paths are relative, and
will be relative to CMAKE_INSTALL_PREFIX (which will be set by dobmake). If you specify
absolute installation paths they will be used as specified.</p>
</div>
<div class="sect3">
<h4 id="_dependencies_between_modules">3.9.1. Dependencies between modules</h4>
<div class="paragraph">
<p>As hinted to above it is possible to have many safir_generated library modules, that have
dependencies on each other. Naturally circular dependencies are not allowed.</p>
</div>
<div class="paragraph">
<p>If you build all your safir_generated library modules in one CMake &#8220;build tree&#8221;, you
only have to specify the dependencies using the <code>DEPENDENCIES</code> argument as described. But
if you are building library modules separately, you will also have to tell the typesystem
where to find other library modules that you depend on.  Dobmake uses information in
<code>typesystem.ini</code> - as described in <a href="#typesystem_ini">typesystem.ini</a> - to find library module
dependencies that it cannot find within the current CMake build tree.</p>
</div>
<div class="paragraph">
<p>If you download the Safir SDK Core source code you can find an example of a dobmake/CMake
build tree under <code>src/dots/dots_dobmake.ss/tests/tree</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_dobmake_gui">3.9.2. Running Dobmake GUI</h4>
<div class="paragraph">
<p>Dobmake is really only a gui for building and installing a CMake project. In fact, it can
be used to build any CMakeLists.txt file. <a href="#dobmake">Dobmake screen shot</a> shows dobmake running under Windows 10.</p>
</div>
<div id="dobmake" class="imageblock">
<div class="content">
<a class="image" href="images/dobmake.png"><img src="images/dobmake.png" alt="Dobmake Screen shot"></a>
</div>
<div class="title">Figure 2. Dobmake screen shot</div>
</div>
<div class="paragraph">
<p>To build a CMake project, enter the path to the CMakeLists.txt file in the <em>Dou
directory</em> field (or select the CMakeLists.txt file using the browse button).
Most likely you should leave the <em>Build configs</em> settings unchanged.
You should now be able to press the <em>Build</em> button to generate code and build it.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using absolute install paths in your CMakeLists.txt file you can select
<em>Absolute</em> and then press <em>Build &amp; Install</em> to also install the results to the
directories you specified. If you&#8217;re using relative install paths you first need to
specify a CMAKE_INSTALL_PREFIX, using the <em>Prefix</em> field.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>Dobmake will build binaries for C++, C# and Java if it can find compilers for each of
these languages.</p>
</div>
<div class="paragraph">
<p>It is possible to explicitly disable Java builds by setting an environment variable
<code>SAFIR_DONT_BUILD_JAVA</code> to <code>True</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_dobmake_from_script_or_command_line">3.9.3. Running Dobmake from script or command line</h4>
<div class="paragraph">
<p>If you want to run dobmake from a script or from the command line, use dobmake-batch (or
dobmake-batch.py on Windows) to run without using the GUI.</p>
</div>
<div class="paragraph">
<p>The dobmake-batch script expects to be run from the directory containing the
CMakeLists.txt file, and CMAKE_INSTALL_PREFIX can be set using the <code>--install</code> argument.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_generated_types">3.10. Using the generated types</h3>
<div class="paragraph">
<p>This section contains some pointers on how to use the generated types, and what the different operations and classes "mean".</p>
</div>
<div class="paragraph">
<p>For the examples in this section we need a couple of Dob-class definitions:
B is an item (a Dob-object to use inside other objects) which contains an Int64, called MyInt. A is a Dob-Object (could be an Entity, Service, Message or Response) that contains one B, called MyB and one Float32 called MyFloat.
So an A object (myA) could look like in <a href="#example_object">Example object</a>.</p>
</div>
<div id="example_object" class="imageblock">
<div class="content">
<a class="image" href="images/example_object.png"><img src="images/example_object.png" alt="Example object"></a>
</div>
<div class="title">Figure 3. Example object</div>
</div>
<div class="sect3">
<h4 id="_syntax_in_the_different_languages">3.10.1. Syntax in the different languages</h4>
<div class="paragraph">
<p>The design approach is that the generated code should make use of the language&#8217;s own
features in the best possible way. Languages that support operator overloading should use
them if it makes the interface &#8220;better&#8221;, and languages that support properties should
use them. This makes each language interface &#8220;as good as it can possibly be&#8221;, but it
has one obvious side effect, i.e. the interfaces are <em>not identical</em>.</p>
</div>
<div class="paragraph">
<p>The syntax for operating on top-level members in the different languages is shown in
<a href="#cpp-top-level">Operating on top-level members in C++</a>, <a href="#cs-top-level">Operating on top-level members in C#</a> and <a href="#java-top-level">Operating on top-level members in Java</a>. The code is identical, except
in the C++ example, where some alternative ways of accomplishing the same thing is shown.</p>
</div>
<div class="paragraph">
<p>(The attentive reader will notice the pointer stuff in the C++ examples. This is because
the SDK uses smart pointers to manage memory in languages without a garbage
collector. See <a href="#smart-pointers">Smart pointers</a> for some info on smart pointers).</p>
</div>
<div id="cpp-top-level" class="listingblock">
<div class="title">Operating on top-level members in C++</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="c1">// Get MyFloat out of myA</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">();</span>
<span class="c1">// or</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">().</span><span class="n">GetVal</span><span class="p">();</span>

<span class="c1">// Set MyFloat in myA to 3.14</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">()</span> <span class="o">=</span> <span class="mf">3.14</span><span class="p">;</span>
<span class="c1">// or</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">().</span><span class="n">SetVal</span><span class="p">(</span><span class="mf">3.14</span><span class="p">);</span>

<span class="c1">// Check if MyFloat is null</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">().</span><span class="n">IsNull</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Check if MyFloat is changed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">().</span><span class="n">IsChanged</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Set MyFloat to null</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyFloat</span><span class="p">().</span><span class="n">SetNull</span><span class="p">();</span></code></pre>
</div>
</div>
<div id="cs-top-level" class="listingblock">
<div class="title">Operating on top-level members in C#</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="c1">// Get MyFloat out of myA</span>
<span class="kt">int</span> <span class="n">val</span> <span class="p">=</span> <span class="n">myA</span><span class="p">.</span><span class="n">MyFloat</span><span class="p">.</span><span class="n">Val</span><span class="p">;</span>

<span class="c1">// Set MyFloat in myA to 3.14</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyFloat</span><span class="p">.</span><span class="n">Val</span> <span class="p">=</span> <span class="m">3.14</span><span class="p">;</span>

<span class="c1">// Check if MyFloat is null</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="p">.</span><span class="n">MyFloat</span><span class="p">.</span><span class="nf">IsNull</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Check if MyFloat is changed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="p">.</span><span class="n">MyFloat</span><span class="p">.</span><span class="nf">IsChanged</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Set MyFloat to null</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyFloat</span><span class="p">.</span><span class="nf">SetNull</span><span class="p">()</span></code></pre>
</div>
</div>
<div id="java-top-level" class="listingblock">
<div class="title">Operating on top-level members in Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Get MyFloat out of myA</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">.</span><span class="na">myFloat</span><span class="o">().</span><span class="na">getVal</span><span class="o">();</span>

<span class="c1">// Set MyFloat in myA to 3.14</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myFloat</span><span class="o">().</span><span class="na">setVal</span><span class="o">(</span><span class="mf">3.14</span><span class="o">);</span>

<span class="c1">// Check if MyFloat is null</span>
<span class="k">if</span> <span class="o">(</span><span class="n">myA</span><span class="o">.</span><span class="na">myFloat</span><span class="o">().</span><span class="na">isNull</span><span class="o">())</span>
    <span class="o">...</span>

<span class="c1">// Check if MyFloat is changed</span>
<span class="k">if</span> <span class="o">(</span><span class="n">myA</span><span class="o">.</span><span class="na">myFloat</span><span class="o">().</span><span class="na">isChanged</span><span class="o">())</span>
    <span class="o">...</span>

<span class="c1">// Set MyFloat to null</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myFloat</span><span class="o">().</span><span class="na">setNull</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "extra level" to get to the actual values, e.g. the <code>GetVal()</code> bit in C++ and <code>Val</code> bit in C# is needed due to the fact that the value is contained, together with the change and null flags, in a <em>container</em>. That there are two different ways of doing the operations in C++ is because of a clever C++ construction, <em>proxy objects</em>, combined with operator overloading. More on containers and proxies later.</p>
</div>
<div class="paragraph">
<p>C# and Java has only one way of doing the operations, and the C# interface uses properties for accessing the values - not as in Dob properties, but as in the language construct. (Look it up in your favourite C# reference if you don&#8217;t know what they are.)</p>
</div>
<div class="paragraph">
<p>Things get a bit more interesting when accessing nested members, see <a href="#cpp-nested">Operating on nested members in C++</a>, <a href="#cs-nested">Operating on nested members in C#</a> and <a href="#java-nested">Operating on nested members in Java</a>, that show operations on nested members in the different languages.</p>
</div>
<div id="cpp-nested" class="listingblock">
<div class="title">Operating on nested members in C++</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="c1">// Get MyInt</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">();</span>
<span class="c1">// or</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">().</span><span class="n">GetVal</span><span class="p">();</span>

<span class="c1">// Set MyInt to 3 (if MyB is not null)</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">()</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="c1">// or</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">().</span><span class="n">SetVal</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="c1">// Create an empty B item for MyB and set B.MyInt to 3</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span> <span class="o">=</span> <span class="n">B</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">()</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="c1">// Check if MyInt is null</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">().</span><span class="n">IsNull</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Check if MyInt is changed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">().</span><span class="n">IsChanged</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Set MyInt to null</span>
<span class="n">myA</span><span class="o">-&gt;</span><span class="n">MyB</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">MyInt</span><span class="p">().</span><span class="n">SetNull</span><span class="p">();</span></code></pre>
</div>
</div>
<div id="cs-nested" class="listingblock">
<div class="title">Operating on nested members in C#</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="c1">// Get MyInt</span>
<span class="kt">int</span> <span class="n">val</span> <span class="p">=</span> <span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyInt</span><span class="p">.</span><span class="n">Val</span><span class="p">;</span>

<span class="c1">// Set MyInt to 3 (if MyB is not null)</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyInt</span><span class="p">.</span><span class="n">Val</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>

<span class="c1">// Create an empty B item for MyB and set B.MyInt to 3</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">B</span><span class="p">();</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyInt</span><span class="p">.</span><span class="n">Val</span> <span class="p">=</span> <span class="m">3</span><span class="p">;</span>

<span class="c1">// Check if MyInt is null</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="nf">IsNull</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Check if MyInt is changed</span>
<span class="k">if</span> <span class="p">(</span><span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="nf">IsChanged</span><span class="p">())</span>
    <span class="p">...</span>

<span class="c1">// Set MyInt to null</span>
<span class="n">myA</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="n">Obj</span><span class="p">.</span><span class="n">MyB</span><span class="p">.</span><span class="nf">SetNull</span><span class="p">();</span></code></pre>
</div>
</div>
<div id="java-nested" class="listingblock">
<div class="title">Operating on nested members in Java</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="c1">// Get MyInt</span>
<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">getVal</span><span class="o">();</span>

<span class="c1">// Set MyInt to 3 (if MyB is not null)</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">setVal</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

<span class="c1">// Create an empty B item for MyB and set B.MyInt to 3</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">setObj</span><span class="o">(</span><span class="k">new</span> <span class="no">B</span><span class="o">());</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">setVal</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

<span class="c1">// Check if MyInt is null</span>
<span class="k">if</span> <span class="o">(</span><span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">isNull</span><span class="o">())</span>
    <span class="o">...</span>

<span class="c1">// Check if MyInt is changed</span>
<span class="k">if</span> <span class="o">(</span><span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">isChanged</span><span class="o">())</span>
    <span class="o">...</span>

<span class="c1">// Set MyInt to null</span>
<span class="n">myA</span><span class="o">.</span><span class="na">myB</span><span class="o">().</span><span class="na">getObj</span><span class="o">().</span><span class="na">myInt</span><span class="o">().</span><span class="na">setNull</span><span class="o">();</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Casting objects up and down in the inheritance hierarchy also differs between the languages, see <a href="#type_casting">Type casting</a> for more information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_containers_and_container_proxies">3.10.2. Containers and Container Proxies</h4>
<div class="paragraph">
<p>As mentioned in other parts of this document each member in a class has two flags associated with it; the <em>IsNull</em> flag and the <em>IsChanged</em> flag. To associate these flags with the value all three (the value and the two flags) are all put inside a <em>container</em>. The container has functions for getting and setting the value (which check/update the flags) and for changing the flags.</p>
</div>
<div class="paragraph">
<p>There are containers for all of the types in the Dob, e.g. Int32Container, Float64Container EntityIdContainer, and so on. There are also containers for user-generated types (classes and enums), and they are defined in the auto-generated code, so in the above example there would be a definition of AContainer and BContainer.</p>
</div>
<div class="paragraph">
<p>The members of the class A would be of type BContainer and Float32Container, and B&#8217;s would be of type Int64Container.</p>
</div>
<div class="paragraph">
<p>The containers introduce an extra level of indirection, which shows itself in the "GetVal()", "SetVal()" and "Val" parts of the expressions above. This unfortunately has the effect of cluttering up the code a bit, so to reduce this cluttering (in C++, which is the only supported language where it is possible) <em>container proxies</em> with <em>operator overloading</em> were introduced. They are really just an intermediate object that allows safe use of operator overloading, and they are what allows "myA.MyB()-&gt;MyInt().SetVal(3)" to be replaced with "myA.MyB()-&gt;MyInt() = 3" (as shown in the examples above). The proxies are meant to be transparent, but they do not have all operations overloaded, so for example if you&#8217;re manipulating a string, you will probably have to do GetVal() to be able to get to most of the string operations.</p>
</div>
<div class="paragraph">
<p>Note that these proxies (container proxies) should not be confused with the proxies that the Dob passes to the applications in the distribution callbacks. The Container Proxies are only meant to simplify use of the typesystems containers, whereas the proxies in the distribution callbacks are used to encapsulate a collection of data and metadata into a single object for the callback (basically allowing the callback to take just a few arguments, instead of a whole bunch, where most applications only use a few).</p>
</div>
</div>
<div class="sect3">
<h4 id="smart-pointers">3.10.3. Smart pointers</h4>
<div class="paragraph">
<p>The generated classes are allocated on the heap and then handled via pointers. Using pointers to objects is necessary for polymorphism to work properly in the Dob interfaces.</p>
</div>
<div class="paragraph">
<p>For C++, which is not a garbage collected language, we use the smart pointer concept. Smart pointers are <em>pointer wrapper objects</em> that store pointers to dynamically allocated objects. They keep track of how many references there are to a certain object, and automatically deletes the referenced object when there are no more references to it.</p>
</div>
<div class="paragraph">
<p>In C# and Java there is no need for smart pointers, since both these languages have garbage collection.</p>
</div>
<div class="sect4">
<h5 id="_smart_pointers_in_c">3.10.3.1. Smart pointers in C++</h5>
<div class="paragraph">
<p>In C<code> to guarantee that all dynamically allocated memory is deallocated, the Dob uses
the <code>std::shared_ptr</code> implementation of smart pointers. Since C</code> is not garbage
collected we do not want to use raw pointers. <code>std::shared_ptr</code> is a smart pointer that
automatically deletes the object pointed to when there are no references to it.</p>
</div>
<div class="paragraph">
<p>Read more about them in your favourite C+\+ Reference</p>
</div>
<div class="paragraph">
<p>Prior to version 7.0 Safir SDK Core used the Boost version of shared_ptr, <code>boost::shared_ptr</code>.</p>
</div>
<div class="paragraph">
<p>See <a href="#cpp_type_casting">C++ type casting</a> for more information on how to cast smart pointers in C++.</p>
</div>
</div>
<div class="sect4">
<h5 id="_hints_for_debugging">3.10.3.2. Hints for Debugging</h5>
<div class="paragraph">
<p>It is possible to look at the contents of a Dob object in the debugger. Since the containers are all part of a class hierarchy the objects may seem a little difficult to understand at first. But just remember these things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Value containers have three values: m_Value, m_bIsNull and m_bIsChanged (which is the member value and the null and change flag respectively).</p>
</li>
<li>
<p>Object containers have two values: m_pObject (which can be null) and m_bIsChanged.</p>
</li>
<li>
<p>C++ smart pointers have two pointers in them, the reference count (pn) and the pointer to the object they point to (px). It is px that you are interested in.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The naming of the container members is also slightly different in the different languages.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="type_casting">3.10.4. Type casting</h4>
<div class="paragraph">
<p>Since the Dob types use inheritance any application that uses the Dob will have to do a lot of type casting. It is very important to understand how this is done, otherwise your application is likely to behave in very strange and unexpected ways.</p>
</div>
<div class="paragraph">
<p>For the discussion in this section the object hierarchy in <a href="#example_object_hierarchy">Example object hierarchy</a> is used.</p>
</div>
<div id="example_object_hierarchy" class="imageblock">
<div class="content">
<a class="image" href="images/object_hierarchy.png"><img src="images/object_hierarchy.png" alt="Example object hierarchy"></a>
</div>
<div class="title">Figure 4. Example object hierarchy</div>
</div>
<div class="sect4">
<h5 id="cpp_type_casting">3.10.4.1. C++ type casting</h5>
<div class="paragraph">
<p>The Dob C++ interface uses <code>std::shared_ptr</code> (as described above) for passing around
objects over the interfaces. For example this means that you get a
<code>std::shared_ptr&lt;Safir.Dob.Entity&gt;</code> (typedefed to <code>Safir.Dob.EntityPtr</code> in the generated
code) out of the <code>EntityProxy</code> in <code>OnNewEntity</code>. If you&#8217;re subscribing to <code>EntityParent</code>
you would want to somehow cast this <code>EntityPtr</code> to an <code>EntityParentPtr</code>.</p>
</div>
<div class="paragraph">
<p>If it was an ordinary pointer you would either use a <code>static_cast</code> or a <code>dynamic_cast</code>
operation (if you&#8217;re unfamiliar with them you should look them up in your C++ reference
now), but since these are shared_ptrs you have to use <code>std::static_pointer_cast</code> or
<code>std::dynamic_pointer_cast</code> to accomplish the same thing.</p>
</div>
<div class="paragraph">
<p><strong>std::static_pointer_cast</strong></p>
</div>
<div class="paragraph">
<p>Use std::static_pointer_cast when you know that the cast will succeed (i.e. you know what type the pointer really has). For example if you have an EntitySubscriber that has subscribed to EntityParent <em>only</em> you can do:</p>
</div>
<div class="listingblock">
<div class="title">Using std::static_pointer_cast</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">MyEntitySubscriber</span><span class="o">::</span><span class="n">OnUpdatedEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EntityParentPtr</span> <span class="n">parent</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">EntityParent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntity</span><span class="p">());</span>
    <span class="p">...</span> <span class="n">Your</span> <span class="n">code</span> <span class="k">for</span> <span class="n">handling</span> <span class="n">the</span> <span class="n">entity</span> <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note that this code will be used to handle updates to both of the subclasses of EntityParent too, but the assumption here is that you want to handle EntityParent and all its subclasses in the same way.)</p>
</div>
<div class="paragraph">
<p><strong>Warning:</strong> If you add a subscription to AnotherEntity this code will cast AnotherEntity-objects to EntityParentPtrs too, which will result in undefined behaviour.</p>
</div>
<div class="paragraph">
<p><strong>std::dynamic_pointer_cast</strong></p>
</div>
<div class="paragraph">
<p>Use std::dynamic_pointer_cast when the pointer could be of several different types that you want to treat differently. For example if you have an EntitySubscriber that has subscribed to EntityChild <em>and</em> AnotherEntity you can do:</p>
</div>
<div class="listingblock">
<div class="title">Using std::dynamic_pointer_cast</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">MyEntitySubscriber</span><span class="o">::</span><span class="n">OnUpdatedEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EntityPtr</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntity</span><span class="p">();</span>

    <span class="n">EntityChildPtr</span> <span class="n">child</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">EntityChild</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HandleChild</span><span class="p">(</span><span class="n">child</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">AnotherEntityPtr</span> <span class="n">another</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">AnotherEntity</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">another</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HandleAnother</span><span class="p">(</span><span class="n">another</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This would use a different routine to handle the different entities. Another example would be if you have subscribed to EntityParent <em>only</em> but want to treat EntityChild2 differently:</p>
</div>
<div class="listingblock">
<div class="title">Another std::dynamic_pointer_cast example</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">MyEntitySubscriber</span><span class="o">::</span><span class="n">OnUpdatedEntity</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EntityPtr</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntity</span><span class="p">();</span>

    <span class="n">EntityChild2Ptr</span> <span class="n">child2</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">dynamic_pointer_cast</span><span class="o">&lt;</span><span class="n">EntityChild2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">child2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HandleChild2</span><span class="p">(</span><span class="n">child2</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">HandleParent</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">EntityParent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entity</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this code HandleChild2 gets called for all objects of the EntityChild2 type (remember that it can be a subclass of EntityChild2 too) and all others will be handled by HandleParent.</p>
</div>
<div class="paragraph">
<p><strong>Remember:</strong> Dynamic casts are a lot more expensive than static casts. So use <code>static_cast</code> when you can!</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> You may have noticed that in both the above examples we extract the entity out of the proxy separately (and not inline in the casts). This is because the call to GetEntity in the callback proxy includes a deserialization of a binary blob into a language specific class. This is a non-trivial operation, so don&#8217;t call it several times if you don&#8217;t need to.</p>
</div>
<div class="paragraph">
<p><strong>Direct TypeId comparison</strong></p>
</div>
<div class="paragraph">
<p>You should <strong>only</strong> use direct TypeId comparison when you want to check that a type is of <em>one specific type but not a subtype.</em> For example if you have subscribed to EntityParent and you want to handle EntityParent differently from the subclasses you can do:</p>
</div>
<div class="listingblock">
<div class="title">Direct TypeId comparison</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">MyEntitySubscriber</span><span class="o">::</span><span class="n">OnUpdatedEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">EntityPtr</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntity</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">GetTypeId</span><span class="p">()</span> <span class="o">==</span> <span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HandleParent</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">HandleChildren</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">EntityParent</span><span class="o">&gt;</span><span class="p">(</span><span class="n">entity</span><span class="p">));</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here the HandleParent routine would be called for EntityParent objects <em>only</em> and all other objects would be handled by HandleChildren.</p>
</div>
<div class="paragraph">
<p>This construction should be used <em>very</em> sparingly. It is probably not the behaviour you are looking for, since it makes your application unable to handle derived objects in the way usually expected in object oriented systems.</p>
</div>
<div class="paragraph">
<p><strong>IsOfType</strong>
The Dob provides an operation Safir::Dob::Typesystem::Operations::IsOfType that can be used to check the relationship between TypeIds while taking inheritance into account.</p>
</div>
<div class="listingblock">
<div class="title">IsOfType logic</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">IsOfType</span><span class="p">(</span><span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span>  <span class="c1">//True</span>
<span class="n">IsOfType</span><span class="p">(</span><span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">AnotherEntity</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span> <span class="c1">//False</span>
<span class="n">IsOfType</span><span class="p">(</span><span class="n">EntityChild</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span>  <span class="c1">//True</span>
<span class="n">IsOfType</span><span class="p">(</span><span class="n">EntityParent</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">EntityChild</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span>   <span class="c1">//False</span>
<span class="n">IsOfType</span><span class="p">(</span><span class="n">EntityChild2</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">EntityChild</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">)</span>   <span class="c1">//False</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This operation should <em>only</em> be used when you need to check relationships between TypeIds. If you have an object you should be using <code>std::dynamic_pointer_cast</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_c_type_casting">3.10.4.2. C# type casting</h5>
<div class="paragraph">
<p>Since C# is garbage collected the Dob can use normal C# pointers to objects. This means that the normal type casting operations can be used. C# also does not have an equivalent to static_cast, so there is really only the choice between different forms of the dynamic_cast-like operation to choose between. If you&#8217;re unsure of how C# casting works you should look it up in your C# reference, since a complete explanation is outside the scope of this document. But here are some pointers:</p>
</div>
<div class="paragraph">
<p>If you know the type of the object (by only having subscribed to one type), go right ahead and cast it:</p>
</div>
<div class="listingblock">
<div class="title">Type casting in C#</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp">    <span class="n">AnotherEntity</span> <span class="n">ent</span> <span class="p">=</span> <span class="p">(</span><span class="n">AnotherEntity</span><span class="p">)</span><span class="n">entity</span><span class="p">;</span>
   <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="p">...</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If for some reason the entity was not of the expected type an exception will be thrown, but remember that in this case that can be only due to a programmer error.</p>
</div>
<div class="paragraph">
<p>If you need to find out the type there are two ways to do it. One good and one not so good. Either you can use the <em>is</em> operation to check that the type is of the right kind and then cast it using c-style casts to get an object of the right type:</p>
</div>
<div class="listingblock">
<div class="title">Using the <code>is</code> operator</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="k">is</span> <span class="n">EntityChild</span><span class="p">)</span> <span class="c1">//not recommended way of checking type</span>
<span class="p">{</span>
    <span class="n">EntityChild</span> <span class="n">child</span> <span class="p">=</span> <span class="p">(</span><span class="n">EntityChild</span><span class="p">)</span><span class="n">entity</span><span class="p">;</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The drawback of using this approach is that you in fact get two type checks, one in the is operation and one in the cast operation. C# provides another operation that means that you only get one type check:</p>
</div>
<div class="listingblock">
<div class="title">Using the <code>as</code> operator</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="n">EntityChild</span> <span class="n">child</span> <span class="p">=</span> <span class="n">entity</span> <span class="k">as</span> <span class="n">EntityChild</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">child</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Prefer using the <em>as</em> operation in C#.</p>
</div>
</div>
<div class="sect4">
<h5 id="_java_type_casting">3.10.4.3. Java type casting</h5>
<div class="paragraph">
<p>Since Java is garbage collected the Dob can use normal Java pointers to objects. This means that the normal type casting operations can be used. Java also does not have an equivalent to static_cast, so there is really only the choice between different forms of the dynamic_cast-like operation to choose between. If you&#8217;re unsure of how Java casting works you should look it up in your Java reference, since a complete explanation is outside the scope of this document.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_other_details">3.11. Other details</h3>
<div class="paragraph">
<p>Details, details, details and even more details&#8230;&#8203;</p>
</div>
<div class="sect3">
<h4 id="change_flags">3.11.1. Change flags</h4>
<div class="paragraph">
<p>As mentioned before (<a href="#member_flags">Flags on members</a>) each member inside a Dob object (i.e. Entity, Message, Service, and Item, but not Struct, see <a href="#items_and_structs">Items and structs</a>) has two flags associated with it, an IsNull flag and an IsChanged flag (often called a <em>null flag</em> and a <em>change flag</em>, respectively).</p>
</div>
<div class="paragraph">
<p>The distribution mechanism uses the change flags to provide meaningful change information in the different distribution mechanisms, which you can read more about in <a href="#interpreting_change_flags">Interpreting change flags</a>. This section covers only how the change flags work inside an object inside one single process.</p>
</div>
<div class="paragraph">
<p>When an object is created all change flags are set to false. When a method to change a members value is called the change flag for that member is set to true (even if the value was the same as before, i.e. it didn&#8217;t change!). If the value is changed to null (via SetNull()) it is also set to true.</p>
</div>
<div class="paragraph">
<p>If a member inside an item inside an object is changed only the change flag on the nested member is set.</p>
</div>
<div class="paragraph">
<p>The change flags' values can be checked using the IsChanged()-methods on the members. In the case of a simple member (i.e. not an item) the flag&#8217;s value is received, but in the case of an item true is returned if <em>any one of the item&#8217;s members are changed</em>. So IsChanged on an item member is recursive! If you need to find out if a change flag is set on the member itself, rather than on one of its members you can use IsChangedHere().</p>
</div>
<div class="paragraph">
<p>An example to make this clearer:</p>
</div>
<table id="my_object" class="tableblock frame-ends grid-none" style="width: 40%;">
<caption class="title">Table 5. Type definition for MyObject type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member Name</th>
<th class="tableblock halign-left valign-top">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Int64</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MyItem</p></td>
</tr>
</tbody>
</table>
<table id="my_item" class="tableblock frame-ends grid-none" style="width: 40%;">
<caption class="title">Table 6. Type definition for MyItem type.</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member Name</th>
<th class="tableblock halign-left valign-top">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Int32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Float64</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>We have two types, MyObject and MyItem (<a href="#my_object">Type definition for MyObject type</a> and <a href="#my_item">Type definition for MyItem type.</a>), where MyObject contains among other things an item of type MyItem.</p>
</div>
<div class="paragraph">
<p>If we have an object with change flags set like in <a href="#object_with_changeflags">An object with change flags</a> (note that member C has a change flag of its own as well as a change flag for each member in it) the result of the calls to IsChanged would be like in <a href="#ischanged_results">Result of IsChanged() and IsChangedHere()</a>.</p>
</div>
<table id="object_with_changeflags" class="tableblock frame-ends grid-none" style="width: 40%;">
<caption class="title">Table 7. An object with change flags</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">Change flag</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C::X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C::Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
</tbody>
</table>
<table id="ischanged_results" class="tableblock frame-ends grid-none" style="width: 50%;">
<caption class="title">Table 8. Result of IsChanged() and IsChangedHere()</caption>
<colgroup>
<col style="width: 34%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">IsChanged</th>
<th class="tableblock halign-left valign-top">IsChangedHere</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">B</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C::X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">C::Y</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>There are also methods to explicitly set the change flags, SetChanged(bool) and SetChangedHere(bool). As in the case of IsChanged the SetChanged-method on items is recursive, so if you need to change only the flag on the item itself you will have to use SetChangedHere. (In fact the above example could only be produced from a newly created object using some SetChanged methods).</p>
</div>
<div class="paragraph">
<p>So, what of all this stuff do you need to use? Probably only the IsChanged() method. All the other stuff is mostly used behind the scenes by the Dob to weave its magic. But there may be times that you have to do something like this.</p>
</div>
</div>
<div class="sect3">
<h4 id="_serialization">3.11.2. Serialization</h4>
<div class="paragraph">
<p>All objects of types defined by dou files can be serialized to and from XML and JSON format (JSON support was introduced in Safir SDK Core 5.0). Methods for serialization and deserialization of objects are found in Safir.Dob.Typesystem.Serialization.</p>
</div>
<div class="paragraph">
<p><strong>Some notes on the XML serialization:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>When serializing objects to XML, all null values are omitted to keep serialization results small and readable. This means that an object with only null values will only consist of a start and end tag, e.g. <code>&lt;Safir.Dob.Position/&gt;</code>.</p>
</li>
<li>
<p>Serialized strings are trimmed by default and all leading and trailing whitespaces, newlines and tabs are removed. To change this behaviour, use the xml attribute <code>xml:space="preserve"</code>, which will cause the spaces in the string to be preserved.</p>
</li>
<li>
<p>Arrays in serialized objects can optionally have an index attribute on each array element, which makes it possible to have gaps in arrays. If no index attribute is specified the array elements are assumed to be in order with the first index being 0. Indices have to be specified for all or none of the array elements. When using the Safir.Dob.Typesystem.Serialization API the index attribute will always be generated.</p>
</li>
<li>
<p>Serialized objects can have a type attribute that specifies the exact type of the object. This is mostly useful when an object member or parameter array element needs to be of a subtype of the type specified in the dou file. E.g. if the type of the member is specified to be <code>BaseObject</code>, but you want to put an instance of <code>DerivedObject</code> in that member.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example of object serialized to XML</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="nt">&lt;Capabilities.TestObj&gt;</span>
    <span class="nt">&lt;MyStringArray&gt;</span> <span class="c">&lt;!-- indices are implicit, 0 and 1 --&gt;</span>
        <span class="nt">&lt;String&gt;</span>  bla bla <span class="nt">&lt;/String&gt;</span> <span class="c">&lt;!-- will be trimmed to "bla bla" --&gt;</span>
        <span class="nt">&lt;String</span> <span class="na">xml:space=</span><span class="s">"preserve"</span><span class="nt">&gt;</span>  bla bla <span class="nt">&lt;/String&gt;</span> <span class="c">&lt;!-- will not be trimmed --&gt;</span>
    <span class="nt">&lt;/MyStringArray&gt;</span>
    <span class="nt">&lt;MyInt32Array&gt;</span> <span class="c">&lt;!-- indices are explicit, all missing will be null --&gt;</span>
        <span class="nt">&lt;Int32</span> <span class="na">index=</span><span class="s">"1"</span><span class="nt">&gt;</span>123<span class="nt">&lt;/Int32&gt;</span>
        <span class="nt">&lt;Int32</span> <span class="na">index=</span><span class="s">"3"</span><span class="nt">&gt;</span>456<span class="nt">&lt;/Int32&gt;</span>
    <span class="nt">&lt;/MyInt32Array&gt;</span>
    <span class="nt">&lt;MyFirstBaseObject&gt;</span> <span class="c">&lt;!-- type expected to comply with dou file specification --&gt;</span>
        ...
    <span class="nt">&lt;MyFirstBaseObject&gt;</span>
    <span class="nt">&lt;MySecondBaseObject</span> <span class="na">type=</span><span class="s">"Capabilities.Derived"</span><span class="nt">&gt;</span> <span class="c">&lt;!-- type attr needed since type is a subtype --&gt;</span>
        ...
    <span class="nt">&lt;MySecondBaseObject&gt;</span>
<span class="nt">&lt;/Capabilities.TestObj&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Some notes on the JSON serialization:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Null values in non-array attributes are always omitted to keep the JSON serialization small and readable. For arrays, since there is no explicit index attribute in JSON, null values in between two non-null values must be present to ensure correct indices. However consecutive null values at the end of an array can and should be omitted.</p>
</li>
<li>
<p>JSON serialized objects must always have an attribute named "_douType" which specifies the type as it is stated in the dou file. For example <code>"_douType" : "Safir.Dob.NodeInfo"</code>. The rest of the attributes will be named exactly as they are in the corresponding dou file.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example of object serialized to JSON</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"_douType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Capabilities.TestObj"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"MyStringArray"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"hello"</span><span class="p">,</span><span class="w"> </span><span class="s2">"world"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"MyInt32Array"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">123</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mi">456</span><span class="p">],</span><span class="w">
         </span><span class="err">//Note:</span><span class="w"> </span><span class="err">array</span><span class="w"> </span><span class="err">is</span><span class="w"> </span><span class="err">padded</span><span class="w"> </span><span class="err">with</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="err">values</span><span class="w"> </span><span class="err">up</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">array</span><span class="w"> </span><span class="err">size</span><span class="w">
    </span><span class="nl">"MyFirstBaseObject"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_douType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Capabilities.Base"</span><span class="p">,</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="nl">"MySecondBaseObject"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_douType"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Capabilities.Derived"</span><span class="p">,</span><span class="w">
        </span><span class="err">...</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_porting_old_xml_to_new_xml">3.11.2.1. Porting "old" XML to "new" XML</h5>
<div class="paragraph">
<p>Safir SDK Core versions prior to 5.0 used a different XML serialization format that did not follow any XML best practices. In 5.0 a new XML serialization was introduced, to make it easier to use third party tools to manipulate the XML, and to make it more like "good" XML.</p>
</div>
<div class="paragraph">
<p>For backward compatibility reasons and to make the transition to 5.0 as smooth as possible, Safir SDK Core can still read the old format, even though it is considered deprecated.</p>
</div>
<div class="paragraph">
<p>However, it is quite easy to convert old XML to new XML, since Safir SDK Core provides a
script, <em>xml_convert.py</em>, that does just that. For example <code>xml_convert.py -d
&lt;path_to_douFiles&gt; -o &lt;converted_result_path&gt; -r</code> will recursively convert all dou and
dom files for you. The script is included in the installation packages, and can be found
in the documentation directory.</p>
</div>
<div class="paragraph">
<p>To convert serialized objects that reside in databases etc, it might be easier to write a small program that deserializes your objects and then serializes them back to XML again. Those two steps will generate equivalent XML but in the new format. Actually such tool already exists, please don&#8217;t hesitate to contact any Safir SDK Core developers for help and information.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_reflection_interface_adv">3.11.3. The reflection interface <sup>adv</sup></h4>
<div class="paragraph">
<p>The reflection interface can be used to interrogate (and modify) anonymous Objects about their member names, types and values. This is something that not many applications should have to do, and therefore it is not described fully in this document.</p>
</div>
<div class="paragraph">
<p>But here are some hints:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Safir.Dob.Typesystem namespace contains a lot of functions for asking the typesystem about static information about types (e.g. what is the name and type of the third member of this type?).</p>
</li>
<li>
<p>Safir.Dob.Typesystem has an ObjectFactory that allows applications to create an object straight from a TypeId.</p>
</li>
<li>
<p>All Dob objects have GetMember(&#8230;&#8203;) routines that return a ContainerBase for a specified member and array index. This can be casted to a container of the correct type, and thereafter manipulated.</p>
</li>
<li>
<p>Very few of the routines in the reflection interface check for errors. If you call them with incorrect arguments the results are usually undefined. E.g. If you try to get the type of the 4th member of a type that has only 3 members you will probably get an undefined value as the type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><em>Use with care!</em> or even better: <em>With great power comes great responsibility!</em></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_distribution_mechanisms">4. The distribution mechanisms</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter will give more details of how to use the distribution mechanisms of the Dob.</p>
</div>
<div class="sect2">
<h3 id="_consumers_and_callbacks">4.1. Consumers and Callbacks</h3>
<div class="paragraph">
<p>Before learning about how to connect to the Dob we need to define a few basic concepts.</p>
</div>
<div class="paragraph">
<p>The first basic concept is a <code>Consumer</code>. A consumer is an interface, or an abstract base class, which represents a <em>role</em> or a set of functionality that an application can have. For example, the <code>MessageSubscriber</code> consumer is an interface that an application has to implement in order to be able to receive messages through a subscription.</p>
</div>
<div class="paragraph">
<p>The second basic concept is <code>Callbacks</code>. Each consumer has one or more callbacks, which are abstract methods that application has to implement. The MessageSubscriber consumer interface has one callback <code>OnMessage</code>, which is called by the Dob each time a message is received.</p>
</div>
<div class="paragraph">
<p>The third concept is <code>Dispatching</code>, which is the name of the strategy that the Dob uses to be able to call the callbacks. We will get to dispatching in a moment (<a href="#dispatching">Dispatching</a>), but for the moment all you need to know is that Dispatching is what causes the callbacks to be called.</p>
</div>
</div>
<div class="sect2">
<h3 id="_connections">4.2. Connections</h3>
<div class="paragraph">
<p>For an application to talk to the Dob it needs a connection. There are in fact two kinds of connections; one that is called Connection and one that is called SecondaryConnection. In this document "connection" will be used when either kind of connection is implied, "primary connection" when Connection is referred to and "secondary connection" when a SecondaryConnection is referred to.</p>
</div>
<div class="paragraph">
<p>First we&#8217;ll describe primary connections, and we&#8217;ll cover secondary connections later in this chapter (<a href="#secondary_connections">Secondary Connections</a>).</p>
</div>
<div class="paragraph">
<p>To create a primary connection the application must create a Connection object and then call <code>Open</code> on it. The <code>Open</code> method takes a number of parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A connection name and a connection instance. These are used to uniquely identify the connection in the system. No two connections can have the same name and instance.</p>
</li>
<li>
<p>A context, which specifies the data "universe" that the connection will operate in. A normal application that is not concerned with Replay should connect with context 0. See <a href="#contexts">Contexts <sup>adv</sup></a> for further details.</p>
</li>
<li>
<p>A <code>StopHandler</code> consumer, which the Dob uses to tell the application to stop executing. Stop orders are described in <a href="#stop_orders">Stop orders</a>.</p>
</li>
<li>
<p>A <code>Dispatcher</code> consumer, which the Dob uses to tell the application that there is data available to it, which it will receive if it calls the <code>Dispatch</code> method. Dispatching is discussed in the next section.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When an application wants to close a connection it calls Close. It is not necessary to call Close before application shutdown, since the Connection destructor will do that automatically.</p>
</div>
<div class="sect3">
<h4 id="dispatching">4.2.1. Dispatching</h4>
<div class="paragraph">
<p>When a connection is opened a separate thread is started in the application. This thread, known as the <em>dispatch thread</em> listens to a shared memory event which signals that something has happened that the application needs to know about, e.g. a message that the application is subscribing to has arrived. When this event is triggered, the dispatch thread calls the <code>OnDoDispatch</code> callback of the <code>Dispatcher</code> consumer.</p>
</div>
<div class="paragraph">
<p>When this happens the application <strong>must</strong> notify (through an event or some other mechanism) the thread that the connection was started in that it should call <code>Dispatch</code> on the connection. When the Dispatch method is called the Dob will call all &#8220;pending&#8221; callbacks, e.g. <code>OnMessage</code> for received messages.</p>
</div>
<div class="paragraph">
<p>The reason for all this is to make things easier for the application developer as well as removing the need for the Dob connection to be thread safe (which would inevitably make it less efficient and slower).</p>
</div>
<div class="paragraph">
<p>The upshot is that all callbacks (except, of course, the <code>OnDoDispatch</code> one) are called <em>from the same thread that opened the connection</em>, which means that most applications should not have to worry at all about locking and having multiple threads.</p>
</div>
<div class="paragraph">
<p><strong>Important:</strong> Do the thread switch as described above, or things will probably crash in surprising ways.</p>
</div>
<div class="paragraph">
<p><a href="#dispatching_sequence_diagram">Dispatching sequence diagram</a> shows the dispatching sequence.</p>
</div>
<div id="dispatching_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/dispatching_sequence_diagram.png"><img src="images/dispatching_sequence_diagram.png" alt="Dispatching Sequence Diagram"></a>
</div>
<div class="title">Figure 5. Dispatching sequence diagram</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using C++ and Boost.Asio or ACE the SDK provides Dispatcher classes that do the thread switch and calls Dispatch, see <a href="#dispatcher_classes">Asio and Ace Dispatchers</a>.</p>
</div>
<div class="sect4">
<h5 id="_breaking_out_of_dispatch_early">4.2.1.1. Breaking out of Dispatch "early"</h5>
<div class="paragraph">
<p>As mentioned above, the <code>Dispatch</code> call will call <em>all</em> pending callbacks before returning. If there is a lot happening in a system this can potientially take a long time, and for example for applications that have requirements to do other tasks periodically this can cause trouble (e.g. missed deadlines).</p>
</div>
<div class="paragraph">
<p>To resolve this applications can, from within a callback, call <code>ExitDispatch</code>, which will cause the <code>Dispatch</code> function to return &#8220;as soon as possible&#8221;. ExitDispatch will also cause a new event to be triggered, so that dispatching will be resumed automatically.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If you&#8217;re using an ACE_Reactor in your application you will also need to call <code>max_notify_iterations(1)</code> on your rector to make the reactor handle your timers in a fair manner. See your ACE documentation for more information.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="secondary_connections">4.2.2. Secondary Connections</h4>
<div class="paragraph">
<p>Whereas a primary connection is a real connection to the Dob, a secondary connection is only a "handle" to a primary connection.</p>
</div>
<div class="paragraph">
<p>Each application needs one primary connection (at least, see <a href="#multithreading">Multithreading</a>). This connection is the one that the Dob knows about and through which data is dispatched. A secondary connection is used by other parts of the application to "attach" to the primary connection.</p>
</div>
<div class="paragraph">
<p>The reason for providing this functionality is so that for example a C++ library used by a C# application can use the main programs connection. This would otherwise be impossible, since passing the connecton object over the C# to C++ interface is not possible. Instead modules can attach to the main program&#8217;s connection using a secondary connection.</p>
</div>
<div class="paragraph">
<p>When creating a secondary connection you can either specify a connection name and instance to get a specific connection instance, or not specify anything at all, in which case you will be given the first connection that was created in the current thread.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_mechanisms">4.3. Using the mechanisms</h3>
<div class="paragraph">
<p>The three different distribution mechanisms of the Dob are used in different ways and require different things from the user application.</p>
</div>
<div class="paragraph">
<p>But before attacking the mechanisms themselves we need to talk about addressing and something called proxies.</p>
</div>
<div class="sect3">
<h4 id="addressing">4.3.1. Addressing</h4>
<div class="paragraph">
<p>The Dob uses logical addressing for its distribution mechanisms, which means that you use a logical name for which applications to send messages to, for example.</p>
</div>
<div class="paragraph">
<p>There are two concepts that we&#8217;ll introduce here (they&#8217;re described in greater detail later), <em>channels</em> and <em>handlers</em>.</p>
</div>
<div class="paragraph">
<p>A <em>channel</em> is like an FM radio frequency; when you send, you&#8217;re sending on a particular frequency, and when you&#8217;re receiving, you&#8217;re listening to a particular frequency. When you send messages, you send them on a channel, and when you subscribe to messages, you subscribe to a particular channel (or all channels, which is where the analogy isn&#8217;t quite as good any more).</p>
</div>
<div class="paragraph">
<p>A <em>handler</em> is the concept that is used for addressing requests (both service and entity requests). A handler is more like a telephone number where only one person can have a particular telephone number (and has to register with the phone company to have it), but anyone can phone that person, as long as they know the number. To be able to receive service and entity requests an application has to register as a handler for that entity or service with the Dob. Then any application can send requests to it, as long as it knows the handler id (the "telephone number" to the handler).</p>
</div>
<div class="paragraph">
<p>Also, to be allowed to <em>own entity instances</em> an application has to register an entity handler for that entity type. Entity instances are the <em>only</em> thing that it is possible to <em>own</em>, and this document tries to only use "own" in that sense. Handlers are registered, not owned, entities are not owned (as opposed to entity instances), but there can be entity handlers registered, and so on.</p>
</div>
</div>
<div class="sect3">
<h4 id="proxies">4.3.2. Proxies</h4>
<div class="paragraph">
<p>There are quite a few different callbacks for different kinds of data, and most of them take some kind of <em>proxy</em> as an argument. The proxies are really only a container for a whole bunch of arguments that the user might need inside the callback, but instead of passing all the arguments separately they are collected into one proxy. This simplifies things for the application, which need only care about the parts of the proxy that it needs, and it makes it easier to add more information in a callback in the future, should there be a need to, without breaking the interfaces.</p>
</div>
<div class="paragraph">
<p>Not all methods on the proxies are applicable in all situations, for example you cannot call <code>GetPrevious</code> on an <code>EntityProxy</code> obtained in an <code>OnNewEntity</code>, since there is no previous version of an entity that was just created, but in <code>OnUpdatedEntity</code> or <code>OnDeletedEntity</code> calling <code>GetPrevious</code> will give you the version of the entity that you got in the previous subscription response for that instance.</p>
</div>
<div class="paragraph">
<p>Internally the proxies contain direct references into the Dob shared memory, which means that there are some constraints on how you can/should use them. Mainly, <em>you&#8217;re not allowed to copy a proxy</em>, and <em>you&#8217;re not allowed to keep a proxy</em>! The rationale for the second is that keeping it would also keep the data in the shared memory, which could cause the Dob to run out of shared memory, and the rationale for the first constraint is to make it more difficult to keep the proxy.</p>
</div>
<div class="paragraph">
<p>Proxies are (with a couple of exceptions) received as parameters to callbacks. After returning from the callback the shared memory that the proxy refers to is released, and the proxy therefore becomes invalid. If you try to use a proxy obtained through a callback after returning from that callback an exception will be thrown!</p>
</div>
<div class="paragraph">
<p>Of course it is possible to pass proxies to other methods, as long as the proxy is not copied. Passing it as a const-reference (<code>const EntityProxy&amp; proxy</code>) works very well in C++.</p>
</div>
</div>
<div class="sect3">
<h4 id="_messages_2">4.3.3. Messages</h4>
<div class="paragraph">
<p><a href="#messages_sequence_diagram">Sequence diagram for messages</a> shows a sequence diagram of how Dob Messages are handled.</p>
</div>
<div id="messages_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/messages_sequence_diagram.png"><img src="images/messages_sequence_diagram.png" alt="Messages Sequence Diagram"></a>
</div>
<div class="title">Figure 6. Sequence diagram for messages</div>
</div>
<div class="paragraph">
<p>For messages there are two different roles involved. The Message Sender sends messages and the Message Subscriber receives messages. The subscriber needs to set up the subscription, and subsequently it will receive messages in its <code>OnMessage</code> callback function whenever a Message Sender sends a message.</p>
</div>
<div class="sect4">
<h5 id="_channels">4.3.3.1. Channels</h5>
<div class="paragraph">
<p>For every message type there can be several message channels. A subscriber can subscribe to all channels, or to only a specific channel. A sender has to send on a specific channel.</p>
</div>
<div class="paragraph">
<p>Channels are identified by the class <em>Safir.Dob.Typesystem.ChannelId</em>, which is a hashed type as described in <a href="#hashed_types">Hashed types</a>.</p>
</div>
<div class="paragraph">
<p>Most of the time only one channel is needed, and then the default channel should be used. The default constructor for ChannelId creates a default channel ChannelId.</p>
</div>
<div class="paragraph">
<p>The constant ChannelId::ALL_CHANNELS is used to identify <em>all channels</em>, and can be used to subscribe to all channels for a certain message type.</p>
</div>
<div class="paragraph">
<p>It is worth noting that the channel is all the addressing there is for messages, i.e. it is completely transparent to the sender and receiver whether they reside on the same or different computers in the system.</p>
</div>
</div>
<div class="sect4">
<h5 id="_subscribing_to_messages">4.3.3.2. Subscribing to messages</h5>
<div class="paragraph">
<p>Two steps are necessary to receive messages. The first is to implement the Safir.Dob.MessageSubscriber interface:</p>
</div>
<div class="listingblock">
<div class="title">Message subscriber class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleMessageSubscriber</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">MessageSubscriber</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnMessage</span><span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">MessageProxy</span> <span class="n">messageProxy</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step is to start the subscription by calling the <code>SubscribeMessage</code> method on the Dob connection object. This method takes a TypeId (the message type to subscribe to), a ChannelId (the channel to listen to) and a pointer to a class that implements the MessageSubscriber interface.</p>
</div>
<div class="listingblock">
<div class="title">Subscribing to a message</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">SubscribeMessage</span>
        <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsg</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
         <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">ChannelId</span><span class="o">::</span><span class="n">ALL_CHANNELS</span><span class="p">,</span>
         <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This subscribes to VehicleMsg (and all messages that inherit from VehicleMsg) on all channels, and the <code>OnMessage</code> callback will be called by the Dob for each received VehicleMsg.</p>
</div>
<div class="paragraph">
<p>If you do not want to include subclasses in your subscription, there is an overload to the <code>SubscribeMessage</code> method that allows you to specify whether or not to include subclasses. Default behaviour of most applications should be to include subclasses.</p>
</div>
<div class="listingblock">
<div class="title">Handling OnMessage callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleMessageSubscriber</span><span class="o">::</span><span class="n">OnMessage</span>
                    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">MessageProxy</span> <span class="n">messageProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsgPtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span>
        <span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsg</span><span class="o">&gt;</span><span class="p">(</span><span class="n">messageProxy</span><span class="p">.</span><span class="n">GetMessage</span><span class="p">());</span>

    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">with</span> <span class="n">vehicle</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#type_casting">Type casting</a> for more information on the casting in the example above.</p>
</div>
<div class="paragraph">
<p>To cancel a subscription you call the <code>UnsubscribeMessage</code> method on the Dob connection object. (It is not necessary to do this before closing a connection or before the application shuts down, the Dob will handle that automatically when the connection is destroyed/closed.)</p>
</div>
<div class="listingblock">
<div class="title">Removing a message subscription (unsubscribing)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">UnsubscribeMessage</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsg</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">ChannelId</span><span class="o">::</span><span class="n">ALL_CHANNELS</span><span class="p">,</span>
     <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A note on combinations of subscribe and unsubscribe: If you subscribe to ALL_CHANNELS, but unsubscribe the default channel you will receive all VehicleMsg:es except those sent on the default channel. You can also do things like subscribe to VehicleMsg including subclasses, and then do an unsubscribe to VehicleMsg not including subclasses, which would make you only receive subclasses to VehicleMsg, but not VehicleMsg itself. These rules apply <em>per consumer</em>, so subscriptions set up with one consumer are not affected by unsubscribes made with another consumer.</p>
</div>
</div>
<div class="sect4">
<h5 id="_sending_messages">4.3.3.3. Sending messages</h5>
<div class="paragraph">
<p>To send messages it is necessary to implement the Dob interface <em>MessageSender.</em> The MessageSender interface is used to manage overflow situations when sending messages.</p>
</div>
<div class="listingblock">
<div class="title">Message sender class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleMessageSender</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">MessageSender</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnNotMessageOverflow</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Messages are sent with the <code>Send</code> function in the Safir.Dob.Connection class. This function takes the message as a parameter and a pointer to the MessageSender interface.</p>
</div>
<div class="paragraph">
<p>When an overflow occurs the <code>Send</code> function will throw an exception (Safir.Dob.OverflowException). This means that the applications message out queue is full, and that the application should not try to send any more messages until told otherwise (and the message that was passed to the Send function was not sent). When the message out queue is no longer full the Dob will call the <code>OnNotMessageOverflow</code> method in the MessageSender passed in the send call that failed, which means that it is now okay to start sending messages again.</p>
</div>
<div class="listingblock">
<div class="title">Sending a message</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsgPtr</span> <span class="n">msg</span> <span class="o">=</span>
                            <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleMsg</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>
<span class="n">msg</span><span class="o">-&gt;</span><span class="n">MessageText</span><span class="p">()</span> <span class="o">=</span> <span class="s">L"Something happened to a vehicle!!!"</span><span class="p">;</span>
<span class="k">try</span>
<span class="p">{</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">ChannelId</span><span class="p">(),</span> <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">OverflowException</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Doh! I got an exception so I have to remember the message and</span>
    <span class="c1">// send it again after I have received an OnNotMessageOverflow</span>
    <span class="c1">// callback</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_services">4.3.4. Services</h4>
<div class="paragraph">
<p><a href="#services_sequence_diagram">Sequence diagram for services</a> contains a sequence diagram for how services are handled.</p>
</div>
<div id="services_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/services_sequence_diagram.png"><img src="images/services_sequence_diagram.png" alt="Services Sequence Diagram"></a>
</div>
<div class="title">Figure 7. Sequence diagram for services</div>
</div>
<div class="paragraph">
<p>For services there are two different roles involved. The ServiceHandler is the component implementing the service and the Requestor is the component using the service. The Handler needs to register the service and then the Requestor can send requests to it.</p>
</div>
<div class="sect4">
<h5 id="_handlers">4.3.4.1. Handlers</h5>
<div class="paragraph">
<p>For every service type there can be several service handlers. A service handler has to be registered with a specific handler id, and a requestor has to send service requests to a specific handler, identified by the handler id.</p>
</div>
<div class="paragraph">
<p>Handler ids are identified by the class <code>Safir.Dob.Typesystem.HandlerId</code>, which is a hashed type as described in <a href="#hashed_types">Hashed types</a>.</p>
</div>
<div class="paragraph">
<p>For most services there is only one handler, and then the default handler should be used. The default constructor for HandlerId creates a default handler identifier.</p>
</div>
<div class="paragraph">
<p>There is also a constant <code>HandlerId::ALL_HANDLERS</code>, which can be used for subscribing to registered handlers, as described <a href="#handler_registration_subscription">Handler registration subscriptions</a>. It is considered an error to use <code>ALL_HANDLERS</code> for either registration or sending requests.</p>
</div>
<div class="paragraph">
<p>The HandlerId is all the addressing that is needed. The request will be sent to the registered handler regardless of whether it is located on the same computer in the system or on a different one.</p>
</div>
</div>
<div class="sect4">
<h5 id="service_handler_registration">4.3.4.2. Registering a service handler</h5>
<div class="paragraph">
<p>Two things need to be done to register a service handler. The first is to implement the Dob ServiceHandler interface. The ServiceHandler consumer interface allows the owner to receive service requests and be notified if some other application <em>overregisters</em> the handler.</p>
</div>
<div class="paragraph">
<p><em>Overregistration</em> occurs when another application registers the same handler for the same service. This will cause the current handler to loose the registration, which is known as an overregistration.</p>
</div>
<div class="listingblock">
<div class="title">Service handler class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleServiceHandler</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ServiceHandler</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnServiceRequest</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ServiceRequestProxy</span> <span class="n">serviceRequestProxy</span><span class="p">,</span>
         <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>         <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnRevokedRegistration</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>     <span class="n">typeId</span><span class="p">,</span>
         <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span> <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second thing that needs to be done is to call the RegisterServiceHandler method on the Dob connection object.</p>
</div>
<div class="listingblock">
<div class="title">Registering a service handler</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">RegisterServiceHandler</span>
    <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">BearingDistanceService</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">(),</span>
     <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After this call is complete the service handler is registered, with the default handler id. If another application had previously registered the same handler for the same type it will now get a call to <code>OnRevokedRegistration</code>, to tell it that someone has <em>overregistered</em> its handler.</p>
</div>
<div class="paragraph">
<p>The above registration mechanism is "hard" in the way that it overregisters previous registerers. There is an alternative, <em>pending registration</em> which is described in <a href="#pending_registrations">Pending Registrations</a>.</p>
</div>
<div class="paragraph">
<p>It is possible to subscribe to handler registrations, so an application might at this point be told that the service handler is registered. See <a href="#handler_registration_subscription">Handler registration subscriptions</a>.</p>
</div>
<div class="paragraph">
<p>The <code>OnServiceRequest</code> callback will now be called whenever the application receives a service request.</p>
</div>
<div class="paragraph">
<p>Every service request must be responded to with an object that inherits from the Safir::Dob::Response class. The response is sent using the ResponseSender that is received in the <code>OnServiceRequest</code> callback.</p>
</div>
<div class="listingblock">
<div class="title">Handling the OnServiceRequest callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleServiceHandler</span><span class="o">::</span><span class="n">OnServiceRequest</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ServiceRequestProxy</span> <span class="n">serviceRequestProxy</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>         <span class="n">responseSender</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">BearingDistanceServicePtr</span> <span class="n">bearingService</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span>
            <span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">BearingDistanceService</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">serviceRequestProxy</span><span class="p">.</span><span class="n">GetRequest</span><span class="p">());</span>

    <span class="p">...</span> <span class="n">validate</span> <span class="n">request</span> <span class="n">contents</span> <span class="p">...</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">bearingService</span> <span class="n">is</span> <span class="n">a</span> <span class="n">correct</span> <span class="n">request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="p">...</span>

        <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">SuccessResponse</span><span class="o">::</span><span class="n">Create</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="c1">// Send an error response</span>
        <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponsePtr</span> <span class="n">response</span> <span class="o">=</span>
           <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponse</span><span class="o">::</span><span class="n">CreateErrorResponse</span>
               <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseGeneralErrorCodes</span><span class="o">::</span><span class="n">SafirReqErr</span><span class="p">,</span>
                <span class="s">L"The request didn't contain all expected data"</span><span class="p">);</span>
        <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to keep the <code>responseSender</code> "for later" if it is not possible to send the response immediately (e.g. if the application has to wait for a database query to complete before sending the response). It is considered a programming error to not send a response to a request (and the ResponseSender destructor will try to alert you to that fact if you fail to use it).</p>
</div>
<div class="paragraph">
<p>To stop handling a service you call the UnregisterHandler method. (It is not necessary to do this before closing a connection or before the application shuts down, the Dob will handle that automatically when the connection is destroyed/closed.)</p>
</div>
<div class="listingblock">
<div class="title">Unregistering the handler</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">UnregisterHandler</span><span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">BearingDistanceService</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
                               <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">()));</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_response_types">4.3.4.3. Response types</h5>
<div class="paragraph">
<p>There are two base classes for responses, <code>Safir.Dob.SuccessResponse</code> and <code>Safir.Dob.ErrorResponse</code> (they in turn inherit from <code>Safir.Dob.Response</code>, but no other responses should do that). If a custom response is needed (e.g. responding with the result of a database query, or with error information from a database query), create your own dou-file, inheriting from either of these two.</p>
</div>
<div class="paragraph">
<p>There is one more predefined error response, <code>Safir.Dob.ErrorListResponse</code>, which allows many errors to be specified, typically used to report errors for individual members in the request.</p>
</div>
<div class="paragraph">
<p>The parameter file <code>Safir.Dob.ResponseGeneralErrorCodes.dou</code> contains some predefined error codes that can be used for the <code>Code</code> field in error responses.</p>
</div>
</div>
<div class="sect4">
<h5 id="_sending_service_requests">4.3.4.4. Sending service requests</h5>
<div class="paragraph">
<p>To send a service request you have to have a class that implements the Requestor consumer interface and create a request and send it using the <code>ServiceRequest</code> method in the Dob connection object.</p>
</div>
<div class="listingblock">
<div class="title">Request sender class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleServiceRequestSender</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Requestor</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnResponse</span><span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseProxy</span> <span class="n">responseProxy</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnNotRequestOverflow</span><span class="p">()</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>OnResponse</code> callback will be called with the response to your request, and the <code>OnNotRequestOverflow</code> callback will be called when it is okay to start sending requests again after an overflow has occurred.</p>
</div>
<div class="paragraph">
<p>Sending a request is done like this:</p>
</div>
<div class="listingblock">
<div class="title">Sending a service request</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleServicePtr</span> <span class="n">request</span> <span class="o">=</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehicleService</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>

<span class="n">request</span><span class="o">-&gt;</span><span class="n">ServiceText</span><span class="p">()</span> <span class="o">=</span> <span class="s">L"Do something!"</span><span class="p">;</span>
<span class="k">try</span>
<span class="p">{</span>
    <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">RequestId</span> <span class="n">reqId</span> <span class="o">=</span> <span class="n">m_connection</span><span class="p">.</span><span class="n">ServiceRequest</span>
        <span class="p">(</span><span class="n">request</span><span class="p">,</span>
         <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">()</span>
         <span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">OverflowException</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//Doh! I got an exception! Better tell the operator to</span>
    <span class="c1">//press that button again in a little while.</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The RequestId that is returned by the <code>ServiceRequest</code> call is a unique identifier for that request. When the response is received the request id for the request that generated the response can be gotten from the ResponseProxy using the <code>GetRequestId()</code> method. This is to allow applications to know which request generated which response.</p>
</div>
<div class="paragraph">
<p>If, for some reason, no response is sent from the service handler a time-out response is generated by the Dob to ensure that the sender of the request always receives a response.</p>
</div>
<div class="paragraph">
<p>If the handler is not registered the Dob will send an error response that indicates exactly that.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_entities_2">4.3.5. Entities</h4>
<div class="paragraph">
<p>Entities are objects that are stored in shared memory and distributed between system nodes by the Dob. It is also possible to send requests on them, to create new entities, to update or delete them. These requests are very similar to service requests, although they are tailored to be used specifically on "things" rather than services. If you haven&#8217;t read the previous section, on services, do so now, since this section assumes that you are familiar with how services and service handlers work.</p>
</div>
<div class="paragraph">
<p><a href="#entities_sequence_diagram">Sequence diagram for entities</a> shows a sequence diagram that describes (a shortened version of) the Entity Handling pattern describing how entities are handled in a Safir system.</p>
</div>
<div class="paragraph">
<p>When handling entities there are three roles involved. <em>Entity Handler</em> is an application registered as a handler of the entity (and is allowed to <em>own</em> entity instances), <em>Entity Subscriber</em> is an application that subscribes to the entity and <em>Entity Requestor</em> is an application sending a request to update the entity. At start-up Entity Subscriber sets up a subscription and Entity Handler registers an entity handler. When Entity Requestor sends a request the Dob sends it to Entity Handler. Entity Handler then validates the request, creates, updates or deletes the entity and sends a response to Entity Requestor containing the status of the request. The Entity Subscriber gets notified of the new entity.</p>
</div>
<div id="entities_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/entities_sequence_diagram.png"><img src="images/entities_sequence_diagram.png" alt="Entities Sequence Diagram"></a>
</div>
<div class="title">Figure 8. Sequence diagram for entities</div>
</div>
<div class="paragraph">
<p>This section will first describe "simple" entity handling, such as is shown in <a href="#entities_sequence_diagram">Sequence diagram for entities</a>, and later go on to describe more advanced concepts, such as <em>persistence</em> and <em>injections</em>.</p>
</div>
<div class="paragraph">
<p><strong>First a note on application design:</strong> You are not supposed to keep internal copies of entities in your program. It is often better to use Read (see <a href="#reading_entities">Reading an entity</a>) when needed. If you often need to locate a particular entity instance depending on its contents you may want to maintain some kind of lookup-table in your program, to be able to find the correct instance quickly. This is better than iterating over all instances to find the correct one.</p>
</div>
<div class="sect4">
<h5 id="_handlers_2">4.3.5.1. Handlers</h5>
<div class="paragraph">
<p>For entities there are handlers, just as there are handlers for services. If you haven&#8217;t already, please read the chapter on Services, and specifically the bit about service handlers.</p>
</div>
<div class="paragraph">
<p>An entity handler is registered to handle entity create, delete and update requests, and handlers are also allowed to own entity instances.</p>
</div>
<div class="paragraph">
<p>Use the default handler if there is only going to be one handler for a certain entity type.</p>
</div>
<div class="paragraph">
<p>When sending Create requests you need to specify which handler should create the instance. When sending an Update or Delete request the request will be automatically sent to the handler of the specified instance, so there is no need to explicitly specify the handler.</p>
</div>
</div>
<div class="sect4">
<h5 id="instanceid_and_entityid">4.3.5.2. InstanceId and EntityId</h5>
<div class="paragraph">
<p>For every entity type there can be many entity instances. Each instance within an entity type is identified by a the class <code>Safir.Dob.Typesystem.InstanceId</code>, which is a hashed type as described <a href="#hashed_types">Hashed types</a>.</p>
</div>
<div class="paragraph">
<p>The class <code>Safir.Dob.Typesystem.EntityId</code> is simply an entity TypeId coupled with an InstanceId, allowing it to be used to uniquely identify an entity instance (remember that there can be instances of different entity types with the same instance id).</p>
</div>
<div class="paragraph">
<p>There are several ways of generating an instance id:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a 64 bit integer</p>
</li>
<li>
<p>Using a string (InstanceId is a hashed type, so the string will give a unique 64 bit integer)</p>
</li>
<li>
<p>Randomly (InstanceId::GenerateRandom() will give a random instance id).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The instance id strategy should be chosen very carefully, to ensure that entity instances can be uniquely identified. An example: For Vehicles the instance id could be generated from the "Callsign" string member. This ensures that there can be no two vehicles with the same callsign, and that two applications processing information on the same vehicle (with the same callsign) will be referring to the same entity. Another example is the ProcessInfo entity that the Dob provides (shows processes that have a connection to the Dob) which uses the process PID as instance id.</p>
</div>
<div class="paragraph">
<p>Using random numbers is another good strategy for generating a unique instance id. Remember that the ids are 64bit integers, so the likelihood of collision when using random numbers is negligible (1 in 10<sup>19</sup>).</p>
</div>
<div class="paragraph">
<p>One other aspect of InstanceIds is who gets to decide which instance id to use, the Requestor or the Handler? For some entity types it might make sense to include an InstanceId in create requests, and for others it might make more sense not to include an InstanceId in the create request, but rather be told of which instance was created in the response. For this purpose all entity handlers are registered with a <code>Safir.Dob.InstanceIdPolicy</code>, which has two possible values <code>HandlerDecidesInstanceId</code> and <code>RequestorDecidesInstanceId</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>HandlerDecidesInstanceId</strong></dt>
<dd>
<p>As the name states, in this case the handler decides which instance id to use for creating new objects. As a response to the CreateRequest it should send a <code>Safir.Dob.EntityIdResponse</code> to indicate success.</p>
<div class="paragraph">
<p>A Requestor to this handler <strong>cannot</strong> specify an instance id in its create request. If it tries to an exception will be thrown.</p>
</div>
</dd>
<dt class="hdlist1"><strong>RequestorDecidesInstanceId</strong></dt>
<dd>
<p>The requestor decides which instance it wants, and includes the instance id in the CreateRequest.</p>
<div class="paragraph">
<p>The handler <strong>must</strong> then create that instance, or if it cannot it should send an ErrorResponse. A handler that is registered with RequestorDecidesInstanceId is <em>not allowed to choose another instance than what is specified in the request</em>!</p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="registering_entity_handler">4.3.5.3. Registering an entity handler</h5>
<div class="paragraph">
<p>Again there is a consumer interface to implement, <code>EntityHandler</code>, which allows the application to receive Create, Update and Delete requests. The interface also allows the applications to be told of overregistrations, just as for ServiceHandler registrations.</p>
</div>
<div class="listingblock">
<div class="title">Entity handler class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleHandler</span> <span class="o">:</span>
    <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityHandler</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnCreateRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnUpdateRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnDeleteRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnRevokedRegistration</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>     <span class="n">typeId</span><span class="p">,</span>
          <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span> <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>OnRevokedRegistration</code> callback works exactly as for Services, as does the <code>responseSender</code>.</p>
</div>
<div class="paragraph">
<p>Applications register an entity handler by calling the <code>RegisterEntityHandler</code> method in the Dob connection object. This method takes an EntityHandler (like the one declared above), a HandlerId, an InstanceIdPolicy and an entity TypeId.</p>
</div>
<div class="listingblock">
<div class="title">Registering an entity handler</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">RegisterEntityHandler</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">(),</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">InstanceIdPolicy</span><span class="o">::</span><span class="n">HandlerDecidesInstanceId</span><span class="p">,</span>
     <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After the call to RegisterEntityHandler the application can immediately use the handler to set entity instances, and other applications can send entity requests to the EntityHandler.</p>
</div>
<div class="paragraph">
<p>To stop handling an entity you call the UnregisterHandler method. (It is not necessary to do this before closing a connection or before the application shuts down, the Dob will handle that automatically when the connection is destroyed/closed.)</p>
</div>
<div class="listingblock">
<div class="title">Unregistering an entity handler</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">UnregisterHandler</span><span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
                               <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">()));</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_handling_create_requests">4.3.5.4. Handling Create Requests</h5>
<div class="paragraph">
<p>The method OnCreateRequest is used by the Dob to notify the entity handler of a create request. The arguments to the method is an EntityRequestProxy which contains the request data and metadata, and a ResponseSender which must be used to send the mandatory response to the request.</p>
</div>
<div class="listingblock">
<div class="title">Handling a create request</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleHandler</span><span class="o">::</span><span class="n">OnCreateRequest</span>
     <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
      <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">entityRequestProxy</span><span class="p">.</span><span class="n">GetRequest</span><span class="p">());</span>

    <span class="c1">// Callsign and Vehicle ID is required for a create</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsNull</span><span class="p">()</span> <span class="o">||</span>
        <span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">VehicleKey</span><span class="p">().</span><span class="n">IsNull</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="c1">//Set error</span>
        <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponsePtr</span> <span class="n">response</span> <span class="o">=</span>
            <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponse</span><span class="o">::</span><span class="n">CreateErrorResponse</span>
            <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseGeneralErrorCodes</span><span class="o">::</span><span class="n">SafirMissingMember</span><span class="p">(),</span>
             <span class="s">"Callsign and VehicleKey are mandatory elements"</span><span class="p">);</span>
        <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//decide a good instance id (we registered as handler decides)</span>
    <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">InstanceId</span> <span class="n">instance</span><span class="p">(</span><span class="n">vehicle</span><span class="p">.</span><span class="n">VehicleKey</span><span class="p">())</span>

    <span class="c1">// Create vehicle</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">SetChanges</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span>
                            <span class="n">instance</span><span class="p">,</span>
                            <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">());</span>

    <span class="c1">// Create response</span>
    <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityIdResponsePtr</span> <span class="n">response</span> <span class="o">=</span>
        <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityIdResponse</span><span class="o">::</span><span class="n">CreateResponse</span>
        <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">EntityId</span><span class="p">(</span><span class="n">vehicle</span><span class="p">.</span><span class="n">GetTypeId</span><span class="p">(),</span><span class="n">instance</span><span class="p">));</span>
    <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of the EntityIdResponse class for the response, which must be used as the success response when HandlerDecidesInstanceId is used as the InstanceIdPolicy for the handler. See <a href="#instanceid_and_entityid">InstanceId and EntityId</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_handling_update_requests">4.3.5.5. Handling Update Requests</h5>
<div class="paragraph">
<p>The method <code>OnUpdateRequest</code> is used by the Dob to notify the entity handler of an update request on an entity owned by that handler. The arguments to the method is an EntityRequestProxy which contains the request data and metadata, and a ResponseSender which must be used to send the mandatory response to the request.</p>
</div>
<div class="paragraph">
<p>Note that the Dob guarantees that the update request is on an existing entity. There is no need to check for the existence of the entity inside <code>OnUpdateRequest</code>.</p>
</div>
<div class="listingblock">
<div class="title">Handling an update request</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleHandler</span><span class="o">::</span><span class="n">OnUpdateRequest</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span>
            <span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">entityRequestProxy</span><span class="p">.</span><span class="n">GetRequest</span><span class="p">());</span>

    <span class="c1">// Callsign</span>
    <span class="k">if</span><span class="p">(</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsChanged</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsNull</span><span class="p">()</span> <span class="o">||</span>
            <span class="n">Callsign</span> <span class="n">has</span> <span class="n">an</span> <span class="n">illegal</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Set error</span>
            <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponsePtr</span> <span class="n">response</span> <span class="o">=</span>
                <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ErrorResponse</span><span class="o">::</span><span class="n">CreateErrorResponse</span>
                    <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseGeneralErrorCodes</span><span class="o">::</span><span class="n">SafirReqErr</span><span class="p">(),</span>
                     <span class="s">"Illegal value for callsign"</span><span class="p">);</span>
            <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">...</span> <span class="n">check</span> <span class="n">all</span> <span class="n">other</span> <span class="n">members</span> <span class="n">that</span> <span class="n">are</span> <span class="n">changed</span> <span class="p">...</span>

    <span class="c1">// Update vehicle</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">SetChanges</span><span class="p">(</span><span class="n">vehicle</span><span class="p">,</span>
                            <span class="n">entityRequestProxy</span><span class="p">.</span><span class="n">GetInstanceId</span><span class="p">(),</span>
                            <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">());</span>

    <span class="c1">// send a success response</span>
    <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">SuccessResponse</span><span class="o">::</span><span class="n">Create</span><span class="p">());</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of <code>SetChanges</code> instead of <code>SetAll</code> above. <code>SetChanges</code> will take the members that have its change flag set in the passed object and merge them into the existing entity that is stored in the Dob shared memory.</p>
</div>
</div>
<div class="sect4">
<h5 id="_handling_delete_requests">4.3.5.6. Handling Delete Requests</h5>
<div class="paragraph">
<p>The method <code>OnDeleteRequest</code> is used by the Dob to notify the entity handler of a delete request on an entity owned by that handler. The arguments to the method is an EntityRequestProxy which contains the request data and metadata, and a ResponseSender which must be used to send the mandatory response to the request.</p>
</div>
<div class="paragraph">
<p>Note that the Dob guarantees that the delete request is on an existing entity. There is no need to check for the existence of the entity inside <code>OnDeletedRequest</code>.</p>
</div>
<div class="listingblock">
<div class="title">Handling a delete request</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleHandler</span><span class="o">::</span><span class="n">OnDeleteRequest</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">entityRequestProxy</span><span class="p">.</span><span class="n">GetEntityId</span><span class="p">(),</span>
                        <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">());</span>

    <span class="c1">// send a response</span>
    <span class="n">responseSender</span><span class="o">-&gt;</span><span class="n">Send</span><span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">SuccessResponse</span><span class="o">::</span><span class="n">Create</span><span class="p">());</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that it is also possible to delete all entity instances owned by a handler by calling <code>DeleteAllInstances</code> (but obviously this is not something that should be done as a result of a DeleteRequest, which is something that should operate on only one object).</p>
</div>
</div>
<div class="sect4">
<h5 id="_owning_entity_instances">4.3.5.7. Owning entity instances</h5>
<div class="paragraph">
<p>Apart from handling requests on entities the entity handler is of course allowed to change an entity whenever it wants to. Generally this should be done using calls to <code>SetChanges</code>, rather than <code>SetAll</code>. The reason for this is the <em>injection timestamps</em> as described in <a href="#timestamp_merge">Timestamp merges</a></p>
</div>
</div>
<div class="sect4">
<h5 id="_subscribing_to_entities">4.3.5.8. Subscribing to entities</h5>
<div class="paragraph">
<p>Once more there is a consumer interface to be implemented to subscribe to entities, <code>EntitySubscriber</code>, which provides callbacks when an entity is created, updated or deleted.</p>
</div>
<div class="listingblock">
<div class="title">Entity subscriber class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleSubscriber</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntitySubscriber</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">OnNewEntity</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnUpdatedEntity</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnDeletedEntity</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">,</span>
         <span class="k">const</span> <span class="kt">bool</span> <span class="cm">/*deprecated*/</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The subscription is started by a call to the <code>SubscribeEntity</code> method on the Dob connection object.</p>
</div>
<div class="listingblock">
<div class="title">Subscribing to an entity</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">SubscribeEntity</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The subscription will be to all instances of that entity, including subclasses. There are a couple of overloads to the <code>SubscribeEntity</code> method that the subscriber can use if it wants to exclude subclasses, or just subscribe to a single entity instance.</p>
</div>
<div class="paragraph">
<p>After the call to <code>SubscribeEntity</code> the Dob will start calling the <code>OnNewEntity</code> callback for all entities that already existed when the subscription was set up, and thereafter it will call the callbacks whenever an entity is created, updated or deleted.</p>
</div>
<div class="listingblock">
<div class="title">Handling the <code>OnNewEntity</code> callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnNewEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntity</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsNull</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="n">Process</span> <span class="n">Callsign</span> <span class="n">here</span> <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="k">else</span> <span class="p">...</span>
    <span class="p">}</span>

    <span class="p">...</span> <span class="n">process</span> <span class="n">other</span> <span class="n">fields</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#type_casting">Type casting</a> for more information on what <code>std::static_pointer_cast</code> is.</p>
</div>
<div class="listingblock">
<div class="title">Handling the <code>OnUpdatedEntity</code> callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnUpdatedEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span>
            <span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">entityProxy</span><span class="p">.</span><span class="n">GetEntityWithChangeInfo</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsChanged</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">().</span><span class="n">IsNull</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">callsign</span> <span class="o">=</span> <span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">();</span>
        <span class="p">...</span> <span class="n">process</span> <span class="n">Callsign</span> <span class="p">...</span>
    <span class="p">}</span>

    <span class="p">...</span> <span class="n">process</span> <span class="n">other</span> <span class="n">fields</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of <code>GetEntityWithChangeInfo()</code> and the change flag on the callsign member to only look at it if it changes. See <a href="#interpreting_change_flags">Interpreting change flags</a> for more information on how to interpret change flags. It is also possible to get hold of the <em>previous</em> entity that was seen by a subscription. Use <code>entityProxy.GetPrevious()</code> to get information about the previous subscription response.</p>
</div>
<div class="listingblock">
<div class="title">Handling the <code>OnDeletedEntity</code> callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnDeletedEntity</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span><span class="p">,</span>
     <span class="k">const</span> <span class="kt">bool</span> <span class="cm">/*deprecated*/</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If this class had been used to subscribe to several entities it can use <code>entityProxy.GetTypeId()</code> to work out which way to handle the remove.</p>
</div>
<div class="paragraph">
<p>It is also possible to use <code>entityProxy.GetPrevious()</code> to get hold of information about the entity that was deleted, such as actually looking at the entity like it was when it was previously dispatched to the subscriber.</p>
</div>
<div class="paragraph">
<p>Please ignore the <code>deprecated</code> flag, it will be removed in a future version of Safir SDK Core (see <a href="#faq">FAQ</a> if you&#8217;re curious).</p>
</div>
<div class="paragraph">
<p>To stop subscribing to an entity the application calls the <code>Unsubscribe</code> method in the Dob connection object. (It is not necessary to do this before closing a connection or before the application shuts down, the Dob will handle that automatically when the connection is destroyed/closed.)</p>
</div>
<div class="listingblock">
<div class="title">Removing an entity subscription (unsubscribing)</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">UnsubscribeEntity</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note:</strong> You should read the section on <a href="#interpreting_change_flags">Interpreting change flags</a> for more information about the change flags during entity subscriptions. The change flags are a very powerful tool to allow the subscriber to determine what has changed during an entity subscription.</p>
</div>
</div>
<div class="sect4">
<h5 id="reading_entities">4.3.5.9. Reading an entity</h5>
<div class="paragraph">
<p>Sometimes the information in an entity is needed directly rather than as a part of a subscription (e.g. a Vehicle might contain an EntityId reference to another object, which can be <em>read</em> when an update to the Vehicle occurs). For these occasions the Dob provides a method to synchronously read an entity, <code>Read</code>.</p>
</div>
<div class="paragraph">
<p>The <code>Read</code> operation returns an EntityProxy, and as described above (<a href="#proxies">Proxies</a>) there are some constraints on using proxies, but in this case it is not passed as a parameter into a callback, but as a return value from a method. Since it is illegal to "keep" an EntityProxy this means that a user of <code>Read</code> has certain obligations:</p>
</div>
<div class="paragraph">
<p>Do not keep the proxy (it is possible, and it will appear to work, but remember that it will lock resources in the Dob).</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using C#, you <em>must</em> dispose of the proxy before letting go of your reference to it. The proxy is an <code>IDisposable</code> object, and C# best practice states that <code>IDisposable</code> objects shall always be disposed explicitly. The easiest way to do this in an exception safe way is to use the <code>using</code> construct:</p>
</div>
<div class="listingblock">
<div class="title">Using the <code>using</code> construction with EntityProxy</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">using</span> <span class="p">(</span><span class="n">Safir</span><span class="p">.</span><span class="n">Dob</span><span class="p">.</span><span class="n">EntityProxy</span> <span class="n">ep</span> <span class="p">=</span> <span class="n">m_connection</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">anEntityId</span><span class="p">))</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">with</span> <span class="n">the</span> <span class="n">read</span> <span class="n">entity</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The advantage of using the above construct is that the <code>Dispose</code> method of EntityProxy is guaranteed to be called regardless of whether an exception is thrown or a "return" is done inside the curly brackets.</p>
</div>
<div class="paragraph">
<p>If you forget to do this the garbage collector will try to dispose the proxy at some later time, at which time the Dob will detect that the proxy was not correctly disposed, and generate an error (as of this writing a dialog will pop up, and the program will terminate).</p>
</div>
</div>
<div class="sect4">
<h5 id="_iterating_over_entities">4.3.5.10. Iterating over entities</h5>
<div class="paragraph">
<p>The Dob also provides a way of iterating over all instances of a certain entity type (including or excluding subclass instances). The way to do this differs slightly from language to language (the goal is to use the native iteration patters for each language).</p>
</div>
<div class="paragraph">
<p>Before looking at how this is done, a <strong>word of warning</strong>: Iterating over lots of instances can be quite time-consuming (e.g. imagine a system that can have 10000 vehicles, and every time an update occurs to one of them, a badly written application iterates over all of them), so in cases where an application wants to do it frequently it is preferable to maintain some kind of lookup table instead, using entity subscriptions. Or maybe using a better algorithm for choosing instance numbers, so that the iteration can be avoided.</p>
</div>
<div class="paragraph">
<p>Iterating over all Vehicles (including subclasses) in C++:</p>
</div>
<div class="listingblock">
<div class="title">Iterating over entities in C++</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">for</span> <span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityIterator</span> <span class="n">it</span> <span class="o">=</span> <span class="n">m_connection</span><span class="p">.</span><span class="n">GetEntityIterator</span>
         <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span><span class="nb">true</span><span class="p">);</span>
     <span class="n">it</span> <span class="o">!=</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityIterator</span><span class="p">();</span> <span class="o">++</span><span class="n">it</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">with</span> <span class="n">it</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Dereferencing <code>it</code> will give an entity proxy.</p>
</div>
<div class="paragraph">
<p>Note that the default constructor for EntityIterator creates an "end" iterator, pointing "one past" the last instance. This is a pattern that was inspired by the <code>std::filesystem</code> directory iterators.</p>
</div>
<div class="paragraph">
<p>Iterating over all Vehicles (including subclasses) in C#:</p>
</div>
<div class="listingblock">
<div class="title">Iterating over entities in C#</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">foreach</span> <span class="p">(</span><span class="n">Safir</span><span class="p">.</span><span class="n">Dob</span><span class="p">.</span><span class="n">EntityProxy</span> <span class="n">entityProxy</span> <span class="n">in</span>
         <span class="n">m_connection</span><span class="p">.</span><span class="n">GetEntityEnumerator</span>
            <span class="p">(</span><span class="n">Capabilties</span><span class="p">.</span><span class="n">Vehicles</span><span class="p">.</span><span class="n">Vehicle</span><span class="p">.</span><span class="n">ClassTypeId</span><span class="p">,</span><span class="nb">true</span><span class="p">))</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">with</span> <span class="n">entityProxy</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An aside: In this case it is not necessary to explicitly call <code>Dispose</code> or somehow use <code>using</code>, since that is taken care of by the loop itself.</p>
</div>
</div>
<div class="sect4">
<h5 id="_sending_entity_requests">4.3.5.11. Sending entity requests</h5>
<div class="paragraph">
<p>To be able to send requests on entities it is necessary to implement the <code>Requestor</code> consumer interface, just like when sending service requests (so have a look at that section, because that example will not be repeated here&#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>There are four methods in the Dob connection object that are used for sending requests on entities; two variants of <code>CreateRequest</code>, one <code>UpdateRequest</code> and one <code>DeleteRequest</code>. All these methods take (among other things) a Requestor so that the Dob has somewhere to send the response.</p>
</div>
<div class="paragraph">
<p>All the request methods return a unique RequestId to allow the Requestor to know which response was generated by which request in the <code>OnResponse</code> callback.</p>
</div>
<div class="listingblock">
<div class="title">Sending an update request.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">request</span> <span class="o">=</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">Create</span><span class="p">();</span>

 <span class="p">...</span> <span class="n">set</span> <span class="n">fields</span> <span class="n">in</span> <span class="n">request</span> <span class="p">...</span>

<span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">RequestId</span> <span class="n">reqId</span> <span class="o">=</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">UpdateRequest</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">myVehicleInstance</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the handler has processed the request it sends a response back telling the sender the status of the request. The Dob sends this response to the OnResponse callback in the Requestor interface. If the response was successful then the change of the entity is also sent if the requestor has a subscription. There is no predetermined order between the response and subscription messages and no assumptions should be made on what is received first.</p>
</div>
<div class="paragraph">
<p>If, for some reason, no response is sent from the owner then a time-out reply will be generated to ensure that the sender of the request always receives a response.</p>
</div>
<div class="listingblock">
<div class="title">Handling the OnResponse callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnResponse</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseProxy</span> <span class="n">responseProxy</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">responseProxy</span><span class="p">.</span><span class="n">IsSuccess</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="p">....</span> <span class="n">handle</span> <span class="n">success</span> <span class="n">response</span><span class="p">,</span> <span class="n">maybe</span> <span class="p">...</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="p">...</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">error</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_some_notes_on_the_createrequest_methods">4.3.5.12. Some notes on the CreateRequest methods</h5>
<div class="paragraph">
<p>There are two variants of the <code>CreateRequest</code> method in the Dob connection class:</p>
</div>
<div class="listingblock">
<div class="title">The two variants of CreateRequest</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">RequestId</span> <span class="n">CreateRequest</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityPtr</span><span class="o">&amp;</span>               <span class="n">request</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>   <span class="n">handlerId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Requestor</span><span class="o">*</span> <span class="k">const</span>               <span class="n">requestor</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

<span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">RequestId</span> <span class="n">CreateRequest</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityPtr</span><span class="o">&amp;</span>              <span class="n">request</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">InstanceId</span><span class="o">&amp;</span> <span class="n">instanceId</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>  <span class="n">handlerId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Requestor</span><span class="o">*</span> <span class="k">const</span>              <span class="n">requestor</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The second one is (obviously, since it contains an InstanceId parameter) only possible to use when the handler uses <code>RequestorDecidesInstanceId</code>, but contrary to what might be expected the first one can be used for <strong>both</strong> types of handlers. If the handler is <code>RequestorDecidesInstanceId</code> an instance id will be randomly generated. This behaviour can be used when the requestor doesn&#8217;t care what instance id gets generated.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="persistence">4.3.6. Entity Persistence</h4>
<div class="paragraph">
<p>The Dob has an area of functionality known as <em>injections</em>, that allows entities to be
injected from an <em>external source</em>. The most common use for this is <em>persistence</em>, which
is what this section describes.  The purpose of persistence is to make entity instances
survive an application or system restart.</p>
</div>
<div class="paragraph">
<p>This functionality is configured using the properties Safir.Dob.InjectionProperty and
Safir.Dob.InjectionOverrideProperty. The possible values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>None</code></p>
</li>
<li>
<p><code>SynchronousVolatile</code></p>
</li>
<li>
<p><code>SynchronousPermanent</code></p>
</li>
<li>
<p><code>Injectable</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>None</code> is the default, where nothing is remembered since the previous registration. The
other values deserve their own subsections (although <code>Injectable</code> will not be described
in this chapter, but in <a href="#systems_of_systems">Systems of Systems <sup>adv</sup></a>).</p>
</div>
<div class="paragraph">
<p>But first a word on why they&#8217;re called <em>synchronous</em>; Persistence injections are known as
synchronous injections since they will always occur synchronously, at application startup
(or rather, when registration occurs), whereas the last kind of injection can occur
asynchronously throughout the lifetime of an entity instance.</p>
</div>
<div class="sect4">
<h5 id="_synchronousvolatile">4.3.6.1. SynchronousVolatile</h5>
<div class="paragraph">
<p><code>SynchronousVolatile</code> persistence is useful to make entities survive when an application restarts, but when the whole system does not. For example if an application crashes and is restarted automatically, or, in a system with redundant nodes, a node is shut down and the applications restarted on another node.</p>
</div>
<div class="paragraph">
<p>When an entity handler is unregistered, without the entity instances being explicitly deleted, the instances owned by that handler are kept in shared memory (they stay in the system as <em>ghosts</em>). When an application later registers an <em>injection handler</em> (see <a href="#using_persistence">Using persistence</a>) with the same handler id, it will be handed all the ghosts of the previous handler (the ghosts will be <em>injected</em>), and will be given the choice of whether to revive them or not.</p>
</div>
<div class="paragraph">
<p>If the whole system (all nodes) is restarted at the same time the ghosts will be lost, hence the "volatile"-part of the name.</p>
</div>
<div class="paragraph">
<p>Note: The ghosts are distributed to all nodes, including restarting ones, so that the resurrection may take place in any node, "old" or new.</p>
</div>
<div class="paragraph">
<p>Note: If you explicitly delete instances before unregistering a handler there will be no ghosts. It is only instances that "die from other causes" that become ghosts&#8230;&#8203;</p>
</div>
</div>
<div class="sect4">
<h5 id="_synchronouspermanent">4.3.6.2. SynchronousPermanent</h5>
<div class="paragraph">
<p><code>SynchronousPermanent</code> persistence works exactly the same way as <code>SynchronousVolatile</code> persistence, except that the ghosts are stored on disk, so that they survive whole system restarts. Hence the "permanent" part of the name.</p>
</div>
<div class="paragraph">
<p>In a system with <code>SynchronousPermanent</code> persistence all entities marked as <code>SynchronousPermanent</code> are stored to disk (files or a database) by the persistence service (provided by dope_main), and when a system restart occurs the first thing that is done is that Dope recreates all stored entities as ghosts in the system, so that when applications start they will be handed the ghosts to resurrect, just as in the <code>SynchronousVolatile</code> case.</p>
</div>
<div class="paragraph">
<p>As you&#8217;ve probably understood <code>SynchronousPermanent</code> persistence is really <em>just</em> <code>SynchronousVolatile</code> persistence <em>plus</em> the permanent storage of ghosts.</p>
</div>
</div>
<div class="sect4">
<h5 id="waiting_for_persistence">4.3.6.3. Waiting for persistence data</h5>
<div class="paragraph">
<p>When starting a system with persistence the Dob does not allow connections to be opened until the persistent instances have been distributed to all nodes. So when your application is allowed to start you are guaranteed to have persistent data available.</p>
</div>
</div>
<div class="sect4">
<h5 id="using_persistence">4.3.6.4. Using persistence</h5>
<div class="paragraph">
<p>If you just want entities to survive a system restart it is very easy to do. This section describes how to do this in the easiest possible way, but if you want more control and understanding over what is going on you probably want to read <a href="#advanced_persistence">Understanding persistence <sup>adv</sup></a>.</p>
</div>
<div class="paragraph">
<p>Instead of inheriting from <code>Safir::Dob::EntityHandler</code> you must inherit from <code>Safir::Dob::EntityHandlerInjection</code>. This will give you an additional four callbacks, which <em>you can leave empty</em>. If you&#8217;re using C++ you don&#8217;t even have to create empty callback bodies, since the base class has empty default implementations.</p>
</div>
<div class="paragraph">
<p>You need to configure the Dob to persist your entity, and that is done by creating a dom-file for your class that specifies that permanent persistence is to be used:</p>
</div>
<div class="listingblock">
<div class="title">Permanent persistence dom file</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;propertyMapping</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
                 <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property&gt;</span>Safir.Dob.InjectionProperty<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;class&gt;</span>Capabilties.Vehicles.Vehicle<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;memberMapping&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;propertyMember&gt;</span>Injection<span class="nt">&lt;/propertyMember&gt;</span>
            <span class="nt">&lt;value&gt;</span>SynchronousPermanent<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;/memberMapping&gt;</span>
<span class="nt">&lt;/propertyMapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The file must be named on the form &lt;class name&gt;-&lt;property name&gt;.dom, e.g. <code>Capabilties.Vehicles.Vehicle-Safir.Dob.InjectionProperty.dom</code>, and placed in the same directory as the dou file for Vehicle.</p>
</div>
<div class="paragraph">
<p>Assuming that your Dob is configured to support persistence (this is the default behaviour, see also <a href="#persistence_config">Persistence config</a>), your created entities should now survive system restarts.</p>
</div>
<div class="paragraph">
<p>When you have registered your handler, it will become the owner of the entities that were persisted.</p>
</div>
<div class="paragraph">
<p>If you want to understand what is going on, please read the next section, <a href="#advanced_persistence">Understanding persistence <sup>adv</sup></a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="advanced_persistence">4.3.6.5. Understanding persistence <sup>adv</sup></h5>
<div class="paragraph">
<p>To use persistence (of the volatile or permanent kind) there is a different consumer interface to implement, <code>Safir.Dob.EntityHandlerInjection</code>. This consumer has four additional callbacks, <code>OnInjectedNewEntity</code>, <code>OnInjectedUpdatedEntity</code>, <code>OnInjectedDeletedEntity</code> and <code>OnInitialInjectionsDone</code>. The middle two of these are only used for asynchronous injections (i.e. the kind that uses deltas over a radio, as described above), so the only ones you might have to do anything in are <code>OnInjectedNewEntity</code> and <code>OnInitialInjectionsDone</code>.</p>
</div>
<div class="paragraph">
<p>In C++ all the four <em>Injection callbacks</em> have an empty default implementation. This is not possible in C# or Java since their interfaces cannot have default implementations of any kind. This means that in C++ you don&#8217;t have to override these callbacks if you don&#8217;t want to do anything inside of them. For this example we assume that there is something that we need to do in these callbacks (but since this is a C++ example we only need to override the two callbacks that are actually used for persistent entities).</p>
</div>
<div class="listingblock">
<div class="title">Injection entity handler class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleHandler</span> <span class="o">:</span>
    <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityHandlerInjection</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">OnCreateRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnUpdateRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnDeleteRequest</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">EntityRequestProxy</span> <span class="n">entityRequestProxy</span><span class="p">,</span>
          <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">ResponseSenderPtr</span>        <span class="n">responseSender</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnRevokedRegistration</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>     <span class="n">typeId</span><span class="p">,</span>
          <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span> <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnInjectedNewEntity</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">InjectedEntityProxy</span> <span class="n">injectedEntityProxy</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnInitialInjectionsDone</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>     <span class="n">typeId</span><span class="p">,</span>
          <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span> <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">};</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The first four overrides are of course the same as when registering an entity handler without persistence or injection support (see <a href="#registering_entity_handler">Registering an entity handler</a>). I won&#8217;t mention them again in this section, as they work exactly the same.</p>
</div>
<div class="paragraph">
<p>The handler is registered by calling <code>RegisterEntityHandlerInjection</code>, which has the same signature as <code>RegisterEntityHandler</code> except that it takes an EntityHandlerInjection instead of an EntityHandler as its fourth argument.</p>
</div>
<div class="listingblock">
<div class="title">Registering an injection entity handler</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">RegisterEntityHandlerInjection</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="p">(),</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">InstanceIdPolicy</span><span class="o">::</span><span class="n">HandlerDecidesInstanceId</span><span class="p">,</span>
     <span class="k">this</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When this call is complete the Dob will call <code>OnInjectedNewEntity</code> for every entity instance that has been persisted using the specified <code>HandlerId</code> (this last bit is important, <em>persisted objects remember the HandlerId it was created by, and can only be resurrected by the that HandlerId</em>). Doing nothing in the callback means that the <em>injection is accepted</em>, i.e. the application has approved the data and the entity can be created (before this it is not visible to other applications, it is a <em>ghost</em>). If the application wishes to reject the instance, it can call <code>Connection::Delete(&#8230;&#8203;)</code> which will cause the persisted entity not to become a "real" entity, and to be deleted from persistence storage.</p>
</div>
<div class="paragraph">
<p>A not so common case is when the application accepts the injected instance but there are some data in the instance that it wants to change before the instance is resurrected. In this case the application can call <code>Connection::SetAll(&#8230;&#8203;)</code> in the <code>OnInjectedNewEntity</code> callback.</p>
</div>
<div class="paragraph">
<p>Once all persisted instances have been accepted or rejected by the application the <code>OnInitialInjectionsDone</code> will be called. This signals that all persistent objects for a certain handler have been injected. Again, you don&#8217;t have to do anything in the callback.</p>
</div>
<div class="paragraph">
<p>(The &#8220;you don&#8217;t have to do anything&#8221; bit is the reason why the strategy described in <a href="#using_persistence">Using persistence</a> works so well.)</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> In most cases it shouldn&#8217;t be necessary to check the data coming in through persistence injections. After all, it is data that has already been checked by an earlier incarnation of your application! If it was good then it should be good now.</p>
</div>
<div class="paragraph">
<p>For our Vehicle example, let&#8217;s assume that the vehicle handler application has to keep an internal instance lookup table (again, it shouldn&#8217;t keep all the vehicle data internally, but it might be necessary to have lookup tables to quickly know which instance to <code>Read</code>, to get at the data). In this case we will want to add instances to the tables in <code>OnInjectedNewEntity</code> and maybe update some status in <code>OnInitialInjectionsDone</code>.</p>
</div>
<div class="listingblock">
<div class="title">Handling the OnInjectedNewEntity callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnInjectedNewEntity</span>
     <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">InjectedEntityProxy</span> <span class="n">injectedEntityProxy</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">VehiclePtr</span> <span class="n">vehicle</span> <span class="o">=</span>
        <span class="n">std</span><span class="o">::</span><span class="n">static_pointer_cast</span><span class="o">&lt;</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">&gt;</span>
            <span class="p">(</span><span class="n">injectedEntityProxy</span><span class="p">.</span><span class="n">GetInjection</span><span class="p">());</span>

    <span class="n">m_myLookupTable</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">vehicle</span><span class="o">-&gt;</span><span class="n">Callsign</span><span class="p">(),</span>
                        <span class="n">injectedEntityProxy</span><span class="p">.</span><span class="n">GetEntityId</span><span class="p">());</span>

    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="k">else</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Handling the OnInitialInjectionsDone callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleSubscriber</span><span class="o">::</span><span class="n">OnInitialInjectionsDone</span>
     <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span> <span class="n">typeId</span><span class="p">,</span>
      <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span> <span class="n">handlerId</span><span class="p">);</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">wcout</span>
        <span class="o">&lt;&lt;</span> <span class="s">"Woohoo! I've got all my persisted entity instances"</span>
        <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you need to create a dom file as described in <a href="#using_persistence">Using persistence</a>, and then you are ready to go.</p>
</div>
<div class="paragraph">
<p><a href="#persistence_sequence_diagram">Sequence diagram for persistent entity</a> shows this mechanism as a sequence diagram (note that the <code>Open</code> call from <code>MyEntityHandlerInjection</code> blocks until the PersistenceService has signalled that the persistence data is ready, as described in <a href="#waiting_for_persistence">Waiting for persistence data</a>).</p>
</div>
<div id="persistence_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/persistence_sequence_diagram.png"><img src="images/persistence_sequence_diagram.png" alt="Persistence Sequence Diagram"></a>
</div>
<div class="title">Figure 9. Sequence diagram for persistent entity</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="handler_registration_subscription">4.3.7. Handler registration subscriptions</h4>
<div class="paragraph">
<p>It is possible to subscribe to the registration of entity and service handlers through the <code>SubscribeRegistration</code> method on the Dob connection object.
This is useful to be able to monitor the status of other applications in the system. E.g. is the application that handles this type of objects started and working?</p>
</div>
<div class="paragraph">
<p>The application needs a class that implements the <code>Safir::Dob::RegistrationSubscriber</code> consumer interface.</p>
</div>
<div class="listingblock">
<div class="title">Registration subscriber class declaration</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">class</span> <span class="nc">VehicleRegistrationSubscriber</span> <span class="o">:</span>
    <span class="k">public</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">RegistrationSubscriber</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">OnRegistered</span>
        <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>      <span class="n">typeId</span><span class="p">,</span>
         <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>  <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">OnUnregistered</span>
         <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>      <span class="n">typeId</span><span class="p">,</span>
          <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>  <span class="n">handlerId</span><span class="p">)</span> <span class="k">override</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then start the subscription (remember that you can do this on a service handler too!):</p>
</div>
<div class="listingblock">
<div class="title">Starting a registration subscription</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">m_connection</span><span class="p">.</span><span class="n">SubscribeRegistration</span>
    <span class="p">(</span><span class="n">Capabilities</span><span class="o">::</span><span class="n">Vehicles</span><span class="o">::</span><span class="n">Vehicle</span><span class="o">::</span><span class="n">ClassTypeId</span><span class="p">,</span>
     <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">::</span><span class="n">ALL_HANDLERS</span><span class="p">,</span>
     <span class="nb">true</span><span class="p">,</span> <span class="c1">//includeSubclasses</span>
     <span class="nb">true</span><span class="p">,</span> <span class="c1">//restartSubscription</span>
     <span class="k">this</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the use of <code>ALL_HANDLERS</code> above, that means that we&#8217;re subscribing to the registration of all handlers for the specified type, rather than a specific handler, and since we&#8217;ve also specified <code>includeSubclasses</code> we will also get a subscription response if a subclass of Vehicle gets registered.</p>
</div>
<div class="paragraph">
<p>When someone registers an entity handler or a service handler the Dob will notify the application of this through a call to the <code>OnRegistered</code> method. (Note that the function has a TypeId and HandlerId as parameters and if the implementation of the interface is used for several different classes then these can be inspected to ascertain how to handle the information).</p>
</div>
<div class="listingblock">
<div class="title">Handling the OnRegistered callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleRegistrationSubscriber</span><span class="o">::</span><span class="n">OnRegistered</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>      <span class="n">typeId</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>  <span class="n">handlerId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">useful</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For entity handler registration subscriptions the <code>OnRegistered</code> callback is called immediately when the registration is made (either when the <code>RegisterEntity&#8230;&#8203;</code> call is made or when a pending registration is completed), <em>not</em> after <code>OnInitialInjectionsDone</code> is called. Conceptually the handler is registered before the entity instances are injected.</p>
</div>
<div class="paragraph">
<p>When a service or entity handler is unregistered the Dob will notify the application of this through a call to <code>OnUnregistered</code>. (A handler is unregistered when the owning application unregisters the handler or the application dies).</p>
</div>
<div class="listingblock">
<div class="title">Handling the OnUnregistered callback</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">VehicleRegistrationSubscriber</span><span class="o">::</span><span class="n">OnUnregistered</span>
    <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">TypeId</span>      <span class="n">typeId</span><span class="p">,</span>
     <span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">Typesystem</span><span class="o">::</span><span class="n">HandlerId</span><span class="o">&amp;</span>  <span class="n">handlerId</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span> <span class="k">do</span> <span class="n">something</span> <span class="n">useful</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a registration goes down and up &#8220;very quickly&#8221;, the subscriber is guaranteed to get first an OnUnregistered and then an OnRegistered callback. I.e. registration subscribers are guaranteed to be notified of the intermediate unregistrations, as opposed entity subscribers, who are not guaranteed to get told if an entity is deleted and then recreated immediately.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="aspects">4.4. Aspects</h3>
<div class="paragraph">
<p>Aspects are used to reduce the size of the Connection classes and header files, and to be able to classify peripheral or esoteric functionality as just that.</p>
</div>
<div class="paragraph">
<p>Currently there are three different aspects:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>ConnectionAspectMisc</em></dt>
<dd>
<p>Contains miscellaneous functionality, such as GetConnectionName, SimulateOverflow etc.</p>
</dd>
<dt class="hdlist1"><em>ConnectionAspectPostpone</em></dt>
<dd>
<p>Contains functionality for postponing callbacks.</p>
</dd>
<dt class="hdlist1"><em>ConnectionAspectInjector</em></dt>
<dd>
<p>Contains functionality needed for injectors, for example the persistence service.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="postpone">4.5. Postponing callbacks</h3>
<div class="paragraph">
<p>Sometimes it is not possible to handle a certain callback "right away", either due to an overflow from the Dob, or due to some external circumstance. For just this situation the Dob provides functionality to delay, or <em>postpone</em>, a certain callback for a certain type until some criteria is fulfilled.</p>
</div>
<div class="paragraph">
<p>Calling <code>Postpone</code> (can be found in the ConnectionAspectPostpone aspect) in a callback will cause the data that caused the callback to be kept (e.g. a message or request will be kept in the in-queue, or an entity subscription update will be held back) until either an overflow situation is resolved or the application calls <code>ResumePostponed</code>.</p>
</div>
<div class="paragraph">
<p>Note that postponed callbacks are always resumed when an overflowed queue is no longer full, so every time <code>OnNotMessageOverflow</code> or <code>OnNotRequestOverflow</code> is called an internal call to ResumePostponed is made.</p>
</div>
<div class="paragraph">
<p>A couple of examples are in place to make this clearer:</p>
</div>
<div class="paragraph">
<p>An application is required to send a request to some other application for every entity update (<code>OnUpdatedEntity</code>) that it receives through its entity subscription. If a lot of entities are updated "quickly" the application would soon get an overflow when sending the requests (remember that there is a limited maximum number of outstanding requests, the default is 10). The correct way of solving this (as opposed to an incorrect way, which would entail creating an infinite queue internally in the application) is to call Postpone when an overflow exception is caught. This will cause the Dob to not call OnUpdatedEntity again for any instance of the subscribed entity (and its subclasses) until the request out queue is no longer full. Once the request out queue is not full all the postponed entity updates will be received.</p>
</div>
<div class="paragraph">
<p>Another application is required to send some data to an external interface (e.g. a TCP link to some external computer/application) every time a request is received. If the external link overflows or goes down temporarily the application can no longer handle the requests, but it might be the wrong thing to just send an error response and letting the requestor handle the problem. Instead the application can call Postpone, and can then go on to handling other duties, until it detects that the external link is working again when it would call ResumePostponed, which causes the waiting requests to be dispatched (note of course that if it takes too long the request is likely to time out).</p>
</div>
</div>
<div class="sect2">
<h3 id="interpreting_change_flags">4.6. Interpreting change flags</h3>
<div class="paragraph">
<p>The change flags described in <a href="#change_flags">Change flags</a> are used by the Dob distribution mechanism to ensure that components can communicate meaning as well as content. This use is slightly different in the different mechanisms. But the aim is for the change flags to mean what you would expect them to mean.</p>
</div>
<div class="sect3">
<h4 id="_messages_3">4.6.1. Messages</h4>
<div class="paragraph">
<p>Change flags are sent unchanged from a sender to all receivers. In a received message a change flag signifies something that the sender has changed, or wants the receiver to do. A member whose change flag is not set is something that the sender does not care about.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entity_subscriptions">4.6.2. Entity subscriptions</h4>
<div class="paragraph">
<p>Upon receiving an entity subscription callback the application can ask the Dob to provide change information for the entity (using <code>GetEntityWithChangeInfo()</code> instead of <code>GetEntity()</code>). If <code>GetEntity</code> is used all change flags will be set to false, but when <code>GetEntityWithChangeInfo</code> is used the Dob will set the change flags to signal what has changed since the last subscription response.</p>
</div>
<div class="paragraph">
<p>So on the first subscription response (<code>OnNewEntity</code>) all change flags are set to true. On subsequent subscription responses for that instance (<code>OnUpdatedEntity</code>) only the members that have changed are marked as changed.</p>
</div>
<div class="paragraph">
<p>Note that this is guaranteed even if the subscriber misses an intermediate state, e.g. if the subscriber misses an entity update (if the owner updates faster than the subscriber can keep up with) all members <em>since the last update that the subscriber got</em> will have their change flags set.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requests_on_entities">4.6.3. Requests on entities</h4>
<div class="paragraph">
<p>Change flags are sent unchanged from a requestor to the entity handler. In a request a change flag signifies something that the requestor wants to change in the entity.</p>
</div>
<div class="paragraph">
<p>Any member that has a change flag set is a member that the requestor wants the entity handler to set in the entity.</p>
</div>
<div class="paragraph">
<p>If a change flag is set on a member that is null that means that the requestor wants that member to be set to null. If the change flag is not set on a null member it means that the requestor does not want that member to be changed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_requests_on_services">4.6.4. Requests on services</h4>
<div class="paragraph">
<p>Change flags are sent unchanged from a requestor to the service provider. In a service request a change flag signifies something that is a part of the service request. Any member that is not changed in the request is something that the requestor does not care about.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="pending_registrations">4.7. Pending Registrations</h3>
<div class="paragraph">
<p>A pending registration means &#8220;I want to register this handler if there is no handler already. And if there is a handler already registered, I want to become the registerer when that one disappears.&#8221;</p>
</div>
<div class="paragraph">
<p>This functionality is to be used for applications that implement hot-standby and/or redundancy. I.e. the application is started in several nodes and if the active instance fails, another should become active instead. See <a href="#hot_standby">Hot-standby / Redundancy</a> for more information on how to implement hot-standby and redundancy.</p>
</div>
<div class="paragraph">
<p>To be able to do pending registration you need to implement the <code>ServiceHandlerPending</code> or <code>EntityHandlerPending</code> consumer interfaces. These add an additional callback <code>OnCompletedRegistration</code> which is used to tell the application that it has become the registerer of a handler.</p>
</div>
<div class="paragraph">
<p>To perform the pending registration you call <code>RegisterEntityHandlerPending</code> or <code>RegisterServiceHandlerPending</code>.</p>
</div>
<div class="paragraph">
<p>The <code>EntityHandlerPending</code> consumer has all the Injection callbacks, since it is unlikely to want hot-standby without wanting at least <code>SynchronousVolatile</code> persistence.</p>
</div>
</div>
<div class="sect2">
<h3 id="stop_orders">4.8. Stop orders</h3>
<div class="paragraph">
<p>Stop orders are used in Safir systems to allow the system to tell applications to shut down gracefully. A stop order is delivered to the application through the <code>OnStopOrder</code> callback on the <code>StopHandler</code> consumer interface that is supplied when opening a Dob connection.</p>
</div>
<div class="paragraph">
<p>The Dob will call the <code>OnStopOrder</code> callback when it has received a stop order for that application. These are sent by sending a <code>DeleteRequest</code> on the relevant instance of the Safir.Dob.ProcessInfo entity. Open Sate (see <a href="#sate">Sate</a>) and subscribe to Safir.Dob.ProcessInfo, find the instance that describes your application and then send a <code>DeleteRequest</code> on it, and your application will receive an <code>OnStopOrder</code> callback.</p>
</div>
<div class="paragraph">
<p>Upon receiving a stop order the application shall shut down gracefully.</p>
</div>
<div class="paragraph">
<p>When an application has several connections to the Dob, only one of them should supply a StopHandler. It is the handler of this connections responsibility to tell the other parts of the application to shut down gracefully. If several connections have stop handlers there may be race conditions, since there is no guaranteed order between which stop handler gets called first.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="safir_websocket">5. Safir WebSocket/JSON-RPC interface</h2>
<div class="sectionbody">
<div class="paragraph">
<p>From version 6.3 of Safir SDK Core, a JSON-RPC interface over WebSockets is provided as an alternative to the traditional language interfaces. The interface is an implementation of the JSON-RPC specification 2.0 (<a href="http://www.jsonrpc.org/specification" class="bare">http://www.jsonrpc.org/specification</a>) and uses WebSockets <a href="https://tools.ietf.org/html/rfc6455">(RFC 6455)</a> as carrier.
Most of the common Dob features are available such as subscribing to entities and messages, sending messages, sending and handling requests, registering as a handler of entities, and some typesystem operations.
If you are not familiair with JSON-RPC, It is strongly recomended to read the JSON-RPC 2.0 Specification. Its a simple protocol and the specification is short and easy to read, it won’t take more than about 10 minutes to read it.</p>
</div>
<div class="paragraph">
<p>The API is explained in full detail in <a href="#websocket_api_reference">Dob WebSocket/JSON-RPC API reference</a>, but basically the API consists of 3 types of messages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Requests - sent from client to server.</p>
</li>
<li>
<p>Responses - sent from server to client as a response to a request.</p>
</li>
<li>
<p>Notifications - sent from server to notify client when something happens.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The pros of using the WebSocket/JSON-RPC interface is that no runtime libraries has to be installed, and the interface is accessible from any language or platform that supports WebSockets. That makes Safir available almost everywhere including web browsers and mobile apps.</p>
</div>
<div class="paragraph">
<p>The cons are worse performance and that you don&#8217;t get access to the most advanced features. The programming model may also be a bit awkward in some situations.</p>
</div>
<div class="paragraph">
<p>The functioality described above is provided by the executable <em>safir_websocket</em>. It has a configuration file Safir.Websocket.Parameters.dou where the ip address and port for the server is set.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">6. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core has two different configuration mechanisms, one for basic system settings, using ini-files, and one for service level settings, using dou-parameters.</p>
</div>
<div class="paragraph">
<p>The reason that we need two mechanisms is that the dou-parameters are not available for the lower level parts of the Safir SDK Core, and we need some way of configuring these. So we use ini-files for such things as where lock files should be kept, how logging should work, and where to actually look for dou-files.</p>
</div>
<div class="paragraph">
<p>This chapter aims to describe the most important of all the things that can be configured in Safir SDK Core. There are many more things that can be configured, and you&#8217;re encouraged to have a look in the parameter dou-files, which should contain descriptions of what the parameters do.</p>
</div>
<div class="sect2">
<h3 id="_basic_system_settings">6.1. Basic system settings</h3>
<div class="paragraph">
<p>The basic system settings consist of three ini files: <em>locations.ini</em>, <em>logging.ini</em>, and <em>typesystem.ini</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>locations.ini - locations of low level files and directories, e.g. lock file and crash dump directories.</p>
</li>
<li>
<p>logging.ini - settings for system logging and debug logging.</p>
</li>
<li>
<p>typesystem.ini - typesystem configuration.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The system will look for these configuration files in several places, which allows them to be kept separate or together with the rest of the Safir SDK Core files. The following locations are checked, and the first configuration found will be used:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><strong>Linux</strong></dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>/etc/safir-sdk-core/ - system-wide configuration</p>
</li>
<li>
<p>~/.config/safir-sdk-core/ - user configuration</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1"><strong>Windows</strong></dt>
<dd>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>CSIDL_COMMON_APPDATA</em>\safir-sdk-core\config\ - system-wide configuration</p>
</li>
<li>
<p><em>CSIDL_LOCAL_APPDATA</em>\safir-sdk-core\config\ - user configuration</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On Windows 10 <em>CSIDL_COMMON_APPDATA</em> is <code>C:\ProgramData</code> and <em>CSIDL_LOCAL_APPDATA</em> is <code>%USERPROFILE%\AppData\Local</code> by default. See <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/bb762494%28v=vs.85%29.aspx">MSDN documentation</a> for more information about CSIDLs.</p>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The reason for checking for the system-wide configuration before checking for a user
configuration is a security measure. It will ensure that an unpriviliged user cannot
insert their own configuration files, thereby modifying an installed system. If the load
order was reversed an unpriviliged user could just put ini-files in his configuration
directory and thereby completely change the behaviour of the system.</p>
</div>
<div class="paragraph">
<p>The Safir SDK Core installation packages will only provide system-wide configuration
files. If you wish to load the configuration from the user configuration instead you will
have to remove the system-wide configuration manually after installing Safir SDK Core.</p>
</div>
<div class="sect3">
<h4 id="locations_ini">6.1.1. locations.ini</h4>
<div class="paragraph">
<p><em>locations.ini</em> contains three parameters:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">lock_file_directory</dt>
<dd>
<p>To ensure correct platform independent initialization of some system-wide resources
(e.g. shared memory) Safir SDK Core uses lock files. This parameter lets us know where we
should keep them.</p>
</dd>
<dt class="hdlist1">crash_dump_directory</dt>
<dd>
<p>Controls where the crash reporting library (see <a href="#crash_reporting">Crash Reporting</a>) should write the
dump files.</p>
</dd>
<dt class="hdlist1">ipc_endpoints_directory</dt>
<dd>
<p>Specifies where in the filesystem node internal ipc endpoints should be
stored. Applicable for Linux only.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="logging_ini">6.1.2. logging.ini</h4>
<div class="paragraph">
<p><em>logging.ini</em> has two sections, <em>SystemLog</em> and <em>LowLevelLog</em>. The LowLevelLog section contains parameters that control the logs for an internal logging and debugging facility, and you should never really need to touch these parameters, unless one of the Safir SDK Core developers have asked you to. The SystemLog section, however, contains parameters of greater interest, since they control the way Safir Logging works:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">native_logging</dt>
<dd>
<p>Controls whether or not logs are sent to the native, platform specific, logging mechanism.</p>
</dd>
<dt class="hdlist1">send_to_syslog_server</dt>
<dd>
<p>Controls whether or not logs are formatted by the Safir Log mechanism and sent to a syslog server using UDP datagrams.</p>
</dd>
<dt class="hdlist1">syslog_server_address</dt>
<dd>
<p>IP address for the syslog server.</p>
</dd>
<dt class="hdlist1">syslog_server_port</dt>
<dd>
<p>UDP Port for the syslog server.</p>
</dd>
<dt class="hdlist1">replace_newline_with_space</dt>
<dd>
<p>Controls whether or not a newline in the log message is replaced with a space.</p>
</dd>
<dt class="hdlist1">show_safir_instance</dt>
<dd>
<p>Show the current SAFIR_INSTANCE in syslog reports. Useful when running multiple nodes on
one computer (see <a href="#multiple-nodes-on-one-computer">Multiple nodes on one computer</a>)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>See <a href="#safir_logging">Safir Logging</a> for more information on what "native" and "syslog" means, and how
to use and configure the logging functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="typesystem_ini">6.1.3. typesystem.ini</h4>
<div class="paragraph">
<p><em>typesystem.ini</em> is a little bit more involved, so let&#8217;s start with an example:</p>
</div>
<div class="listingblock">
<div class="title">Example typesystem.ini</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="ini"><span class="c">; Number of megabytes of shared memory that will be allocated by dots kernel.
</span><span class="py">dots_shared_memory_size</span><span class="p">=</span><span class="s">10</span>

<span class="c">; Comma separated list of default directories to look for dou files in.
</span><span class="py">dou_search_path</span><span class="p">=</span><span class="s">/usr/share/safir-sdk-core/dou</span>

<span class="c">; Comma separated search path for safir_generated-xxx-java.jar files.
</span><span class="py">java_search_path</span><span class="p">=</span><span class="s">/usr/share/java/safir-sdk-core</span>

<span class="nn">[Core]</span>
<span class="c">; This section contains the information needed to load the safir_generated-Core-xxx
;   libraries and its dou files.
</span><span class="py">kind</span><span class="p">=</span><span class="s">library</span>
<span class="py">dependencies</span><span class="p">=</span>

<span class="nn">[OverrideExample]</span>
<span class="c">; This section provides a parameter override that will only be used on a node with
;   SAFIR_INSTANCE set to 1.
; It uses a custom directory for dou/dom files, rather than using the dou_search_path above.
</span><span class="py">kind</span><span class="p">=</span><span class="s">override</span>
<span class="py">dou_directory</span><span class="p">=</span><span class="s">/path/to/files</span>
<span class="py">safir_instance</span><span class="p">=</span><span class="s">1</span>

<span class="nn">[LibraryExample]</span>
<span class="c">; This section contains the information needed to load the
;   safir_generated-LibraryExample-xxx libraries and its dou files.
</span><span class="py">kind</span><span class="p">=</span><span class="s">library</span>
<span class="py">dependencies</span><span class="p">=</span><span class="s">Core ; it has a dependency on one or more dou files in Core.</span>
<span class="c">; No dou_directory is specified, so the dou files will be looked for under
;   dou_search_path/LibraryExample
; No safir_instance is specified, so the section will apply to all nodes on the computer.
</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The file contains a general section, followed by any number of <code>[sections]</code>, each of
which can be one of two kinds, a <em>parameter override</em> or a <em>library module</em>.</p>
</div>
<div class="sect4">
<h5 id="_general_section">6.1.3.1. General section</h5>
<div class="paragraph">
<p>The general section contains parameters that affect the typesystem itself, or all of
sections in the rest of the file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">dots_shared_memory_size</dt>
<dd>
<p>Specifies the size of shared memory allocated for the typesystem. The default value is
big enough for most systems, but if the typesystem contains a very large number of types
it may be necessary to increase this value. More info on shared memory can be found in
<a href="#memory_config">Shared Memory config</a></p>
</dd>
<dt class="hdlist1">dou_search_path</dt>
<dd>
<p>Comma separated list of default directories to look for dou files in. The typesystem will
look for dou files for each module described in a section by appending the section name
to each of the entries in this variable.</p>
</dd>
<dt class="hdlist1">java_search_path</dt>
<dd>
<p>Comma separated list of directores to look for safir_generated jar files in. If a
safir_generated-xxx-java.jar file cannot be found in the java class path the typesystem
will look in each of the directories specified in this variable.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_library_module_sections">6.1.3.2. Library module sections</h5>
<div class="paragraph">
<p>A library section specifies a set of dou files and the safir_generated binaries generated
from them that should be loaded by the typesystem at startup. The section name must be
the name that was specified when building the module (see &lt;&lt;code-generation).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">kind</dt>
<dd>
<p>Mandatory. Use value <em>library</em> to make a library module section.</p>
</dd>
<dt class="hdlist1">dependencies</dt>
<dd>
<p>Mandatory, but can be empty. A comma-separated list of modules that dou files in this
module depend on. This information is needed by dobmake to resolve references inside dou
files.</p>
</dd>
<dt class="hdlist1">dou_directory</dt>
<dd>
<p>Optional. Specifies the directory to load dou files from. If this is not specified the
<code>dou_search_path</code> in the general section will be used to find the dou files.</p>
</dd>
<dt class="hdlist1">cpp_library_location</dt>
<dd>
<p>Optional. Location of the cpp binaries generated by dobmake. If this is not specified the
library loader configuration in the operating system will be used instead.</p>
</dd>
<dt class="hdlist1">java_jar_location</dt>
<dd>
<p>Optional. Location of the java binaries generated by dobmake. If this is not specified
the <code>java_search_path</code> in the general section and the java class path will be used
instead.</p>
</dd>
<dt class="hdlist1">dotnet_assembly_location</dt>
<dd>
<p>Optional. Location of the dotnet binaries generated by dobmake. If this is not specified the
dotnet runtime library loader will be used instead.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_parameter_override_sections">6.1.3.3. Parameter override sections</h5>
<div class="paragraph">
<p>A parameter override section specifies a set of dou files that should be loaded instead
of the default ones included in a library module.  For example, this can be used to
override parameters or string or array lengths without having to change the files that
are in the Safir SDK Core installation, keeping project-specific changes separate
from the Safir SDK Core defaults.</p>
</div>
<div class="paragraph">
<p>In the above example there is one parameter override section. If, for example, the
OverrideExample dou_directory contains a Safir.Dob.NodeParameters.dou file (which is also
in the Core dou_directory) the file from the OverrideExample dou_directory will be used.</p>
</div>
<div class="paragraph">
<p>If a file is found in multiple places, the <em>last one</em> found will be the one used.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">kind</dt>
<dd>
<p>Mandatory. Use value <em>override</em> to make a parameter override section.</p>
</dd>
<dt class="hdlist1">dou_directory</dt>
<dd>
<p>Directory containing dou files to load for this parameter override.</p>
</dd>
<dt class="hdlist1">safir_instance</dt>
<dd>
<p>Optional integer value. If specified the section will only be applied to the node with
that <code>SAFIR_INSTANCE</code> number. For more info on running multiple nodes on one computer,
see <a href="#multiple-nodes-on-one-computer">Multiple nodes on one computer</a>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The name of parameter override sections are not used for anything in the system, so they
only need to be unique.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="special_variables">6.1.4. Environment and special variable expansion</h4>
<div class="paragraph">
<p>Since the configuration files need to be able to refer to system directories they also support environment variable expansion. E.g. <code>$(HOME)</code> expands to the value of the <code>HOME</code> environment variable.</p>
</div>
<div class="paragraph">
<p>On Windows platforms we also support the <em>CSIDL</em> values mentioned above, since Windows does not guarantee that there are always environment variables that correspond to them. For example the %PROGRAMDATA% environment variable is not guaranteed to be set or to point to the same directory as <em>CSIDL_COMMON_APPDATA</em>. So the configuration files support <em>special variables</em> as well as environment variables. E.g. <code>@{SPECIAL_VARIABLE}</code> will be expanded to the value of that variable (note that the syntax is different from the environment variable syntax).</p>
</div>
<div class="paragraph">
<p>The supported special variables are listed in <a href="#windows_special_variables">Special Variables on Windows</a>. We also provide aliases that use the Windows Known Folder naming.</p>
</div>
<table id="windows_special_variables" class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 9. Special Variables on Windows</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">CSIDL name</th>
<th class="tableblock halign-left valign-top">Windows Known Folder "alias"</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_APPDATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_RoamingAppData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_LOCAL_APPDATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_LocalAppData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_COMMON_APPDATA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_ProgramData</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_MYDOCUMENTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_Documents</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_COMMON_DOCUMENTS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_PublicDocuments</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_PROGRAM_FILES</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_ProgramFiles</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSIDL_PROGRAM_FILESX86</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FOLDERID_ProgramFilesX86</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are two more links that contain useful information about Windows paths, CSIDLs, and Windows Known Folders.: "<a href="https://techcommunity.microsoft.com/t5/windows-blog-archive/where-should-i-write-program-data-instead-of-program-files/ba-p/228513">Where Should I Write Program Data&#8230;&#8203;?</a>" and "<a href="http://patrickablog.azurewebsites.net/index.php/2010/03/18/where-should-i-store-my-data-and-configuration-files-if-i-target-multiple-os-versions/">Where Should I Store my Data and Config&#8230;&#8203;?</a>".</p>
</div>
<div class="paragraph">
<p>There is currently two special variables that are available on both Linux and Windows. They are described in <a href="#common_special_variables">Common Special Variables</a>, below.</p>
</div>
<table id="common_special_variables" class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 10. Common Special Variables</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Special Variable</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/tmp on Linux and TEMP or TMP environment variable on Windows.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAFIR_INSTANCE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The value of the environment variable SAFIR_INSTANCE, or "0" if that variable is not defined.</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_network_config">6.2. Network config</h3>
<div class="paragraph">
<p>A Safir SDK Core system can consist of one or more nodes running on one or more
computers. This allows division of responsibility between multiple server nodes, or
running HMI and business logic on different computers.</p>
</div>
<div class="paragraph">
<p>To be able to configure a networked system properly a basic understanding of how
Safir SDK Core nodes communicate is needed.</p>
</div>
<div class="sect3">
<h4 id="light-nodes">6.2.1. Full nodes and Light nodes</h4>
<div class="paragraph">
<p>There are two basic kinds of nodes in a Safir SDK Core system, <em>Full nodes</em> and <em>Light
nodes</em>. The two kinds of nodes have different features, and will fulfill different roles
in a system.</p>
</div>
<div class="paragraph">
<p>In short Full nodes have access to all distribution mechanism features, but need to have
full network connectivity at all times, whereas light nodes only have partial access to
the distribution mechanisms, but in exchange can have more flexibility with network
connectivity.</p>
</div>
<div class="paragraph">
<p>For some types of systems it may make sense to use only Full nodes, whereas for others it
may make sense to use a mix of full and light nodes. If a system consists of one or more
servers and a set of clients, it may be useful to make the clients into light nodes. The
clients will then be able to connect and disconnect from the rest of the system in a more
flexible way.</p>
</div>
<div class="sect4">
<h5 id="_details_on_light_nodes">6.2.1.1. Details on Light nodes</h5>
<div class="paragraph">
<p>The properties of a Light node are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can only register handlers for services that are marked as <em>Local</em> or <em>Limited</em> (see <a href="#distribution-scope">Distribution scope</a>)</p>
</li>
<li>
<p>Can only register handlers for entities that are marked as Local or Limited.</p>
</li>
<li>
<p>Can only own instances of entity types that are marked as Local or Limited.</p>
</li>
<li>
<p>Can subscribe to everything.</p>
</li>
<li>
<p>Will only receive messages, requests and entity instances from full nodes, not other light nodes.</p>
</li>
<li>
<p>Can send messages, that will reach full nodes, but not other light nodes.</p>
</li>
<li>
<p>A light node can be disconnected from a system, and then be reconnected at a later
time, without having to be restarted.</p>
</li>
<li>
<p>A light node can be disconnected from one system and connected to another system,
without having to be restarted.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A light node that is disconnected from a system is known as a <em>detached</em> light node, and
when it is connected it is known as an <em>attached</em> node. These statuses are reflected in
the <code>Safir.Dob.NodeInfo</code> entity.</p>
</div>
<div class="paragraph">
<p>Light nodes never communicate directly with each other, so there is no need for them to
be able to reach each other on the network. Light nodes do however need to be able to
reach all full nodes.</p>
</div>
<div class="paragraph">
<p>A side effect of this is that light nodes may not be aware of each other at all. For
example, looking at the <code>Safir.Dob.NodeInfo</code> entity on one light node will not show
instances for all nodes, but only for the light node itself and all the full nodes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_light_node_detachattach_behaviour">6.2.1.2. Light node detach/attach behaviour</h5>
<div class="paragraph">
<p>There are two ways that a detached light node can behave. Either it can wipe all
registrations and entities, and essentially become &#8220;blank&#8221;, or it can keep all
registrations and entities, but as read-only. This latter mode of course disallows
all requests (except to handlers on the same node).</p>
</div>
<div class="paragraph">
<p>The keep mode is useful for allowing a user on a disconnected light node to still look at
the last received state of all entities.</p>
</div>
<div class="paragraph">
<p>This behaviour is configured using the <code>KeepStateWhileDetached</code> parameter, as described
in <a href="#node-type-parameters">Node Type Parameters</a>.</p>
</div>
<div class="paragraph">
<p>When a detached node in keep mode reattaches to the same system that it was attached to
previously it will update its state to the state of the system. So instances that no
longer exist or handlers that no longer are registered will get removed, and new
instances and registrations will be added. Subscribers on the light node will be updated
accordingly.</p>
</div>
<div class="paragraph">
<p>If a detached light node in keep mode attaches to another system (or the same system, but
restarted) it will also get resynchronized, so that it reaches a correct state. But of
course in this case all instances and registrations from the old system will get deleted
first.</p>
</div>
<div class="paragraph">
<p>Since a light node in non-keep mode will get cleared of all instances and registrations
when it detaches, the resynchronization when attaching/reattaching is just a matter of
sending the current system state to the light node.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_safir_sdk_core_networking">6.2.2. Safir SDK Core networking</h4>
<div class="paragraph">
<p>Safir SDK Core nodes can communicate using  <em>UDP Unicast</em> and <em>UDP Multicast</em>. Multicast
communication means that a single packet sent from one node can be received by multiple
nodes, whereas unicast packets are only sent to one node.</p>
</div>
<div class="paragraph">
<p>For networks that support it, multicast is a lot more efficient if there are many
nodes. For example an entity update can be performed using only one packet, whereas in a
system using unicast one packet per node is needed. On the other hand, using multicast is
not an option on all networks.</p>
</div>
<div class="paragraph">
<p>Regardless of whether multicast is used or not, all nodes must be reachable using
unicast, since things that only need to be sent to one node is sent using unicast.  A
system can also mix nodes that are reached with multicast with nodes that are reached
with unicast.</p>
</div>
<div class="paragraph">
<p>The nodes communicate with each other over two channels, the <em>control channel</em> and the
<em>data channel</em>. Each of these channels is a separate stream of UDP packets over a
separate set of ports.</p>
</div>
<div class="paragraph">
<p>All these things, the control and data channel ports and multicast/unicast communication,
need to be configured. Some things are configured as part of each node&#8217;s <em>Node Type</em>, and
some are configured for each individual node.</p>
</div>
<div class="paragraph">
<p>To clarify how all this relates to <em>Full</em> and <em>Light</em> nodes, all full nodes need to be able
to reach each other as per the above requirements. Light nodes do not need to be able to
reach each other, but they need to be able to reach all full nodes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_node_configuration">6.2.3. Node configuration</h4>
<div class="paragraph">
<p>Each node in a Safir SDK Core system belongs to one and only one <em>Node Type</em>. Each node
type has a number of parameters that control how nodes belonging to it communicate with
other nodes. The node types are configured in the NodeTypes parameter in
Safir.Dob.NodeParameters.dou. The parameters for each node type are listed in
<a href="#node-type-parameters">Node Type Parameters</a>.</p>
</div>
<table id="node-type-parameters" class="tableblock frame-ends grid-all" style="width: 80%;">
<caption class="title">Table 11. Node Type Parameters</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the node type</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MulticastAddressControl</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast address and port used for the control channel for nodes of this type. An
empty string indicates that nodes of this type can&#8217;t be reached via multicast.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MulticastAddressData</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multicast address and port used for the data channel for nodes of this type. An empty
string indicates that nodes of this type can&#8217;t be reached via multicast.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HeartbeatInterval</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How often shall heartbeats/keepalives be sent.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaxLostHeartbeats</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many lost heartbeats before marking nodes of this type as dead.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SlidingWindowSize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">How many messages that can be sent on the network at the same time when communicating with other nodes. This value has a valid range between 1 and 20. Setting this value to 1 means that every message must be acknowledged from all receivers before continuing sending the next message. If this value is set to 20, it means that it is allowed to send at most 20 messages at the same time before waiting for acknowledgements from the receivers. On a stable network with decent speed it is recommended to use the maximum value (20).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">AckRequestThreshold</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of sent messages that are still unacknowledged, before the sender will explicitly request acknowledgements from the receivers. The valid range for this value is between 1 and SlidingWindowSize. For small values on SlidingWindowSize it is recommended to set AckRequestThreshold=SlidingWindowSize. For SlidingWindowSize close to the maximum value (20), it is recommended to set this value to about half the SlidingWindowSize.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RetryTimeout</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Time to wait for acknowledgement before sending the same message again to nodes of this type. This parameter is a sequence of time values where the first value is used as time limit before the first retransmission is made, the second value is used as time limit before the second retransmission an so on. The last value in the sequence is used for any forthcoming retransmissions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">RequiredForStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, a node of this type can start a system of its own. A node with a node
type where this parameter is set to false will never start a system of its own, it
just waits for a system to join.
If IsLightNode is set true this value must be false or it can be omitted. I.e a light node can never be required for start.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IsLightNode</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, nodes of this node type are light nodes. See <a href="#light-nodes">Full nodes and Light nodes</a> for more information.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">KeepStateWhileDetached</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This parameter only has effect if IsLightNode is true.
If this value is true, all Entities owned by connections on remote nodes are kept in read-only mode. Any requests will result in an error response.
If this value is false, all Entities owned by connection on remote nodes are unregistered and deleted.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Each node has to be configured individually, to know which node type it belongs to,
etc. This is done in done in the <code>Safir.Dob.ThisNodeParameters.dou</code> file, which therefore
must be different on all nodes (or use environment variables in the parameters, as
described in <a href="#environment_parameters">Environment variables in parameters</a>).</p>
</div>
<table id="this-node-parameters" class="tableblock frame-ends grid-all" style="width: 70%;">
<caption class="title">Table 12. This Node Parameters</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter Name</th>
<th class="tableblock halign-left valign-top">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the node. This is only used for presentation purposes, and is not used for any
logic. No checks are made to ensure that the node name is unique, since in fact it
doesn&#8217;t need to be unique.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NodeType</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node type for this node.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ControlAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unicast address and port of the control channel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DataAddress</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unicast address and port of the data channel.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Seeds</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of addresses and ports of the control channel of the seed nodes. Seed nodes are explained in <a href="#node-discovery">Node discovery and system start</a>.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The addresses are on the format <code>address:port</code>, where the address can be an IP address or
a DNS-resolvable address.</p>
</div>
<div class="paragraph">
<p><code>ControlAddress</code> and <code>DataAddress</code> are used to identify which local network interface
that we should bind to. Wildcards can be used to match parts of an address,
e.g. "192.168.1.*" will make Safir SDK Core use the first network interface on that
subnet that it can find on the local machine. On Linux it is also possible to specify a
network interface explicitly, for example "eth0:20000", meaning use port 20000 on
whatever ip address eth0 is using. On Windows there is no such feature, currently.</p>
</div>
<div class="paragraph">
<p>If no matching interface can be found retries will be made for the interval specified in
Safir.Dob.NodeParameters.LocalInterfaceTimeout.</p>
</div>
<div class="paragraph">
<p>There is a command line utility <code>safir_resolver</code> (used to be called
communication_resolver) that can be used to check what an address or interface name will
resolve to. Use the <code>-l</code> flag to resolve local addresses and interfaces.</p>
</div>
</div>
<div class="sect3">
<h4 id="node-discovery">6.2.4. Node discovery and system start</h4>
<div class="paragraph">
<p>A newly started node will, as a first step, try to find and contact other nodes. The
mechanism used to achieve this is called <em>node discovery</em>.</p>
</div>
<div class="paragraph">
<p>The second step is to either start a new system or, in case the node is in contact with
nodes from an already started system, to join an existing system.</p>
</div>
<div class="sect4">
<h5 id="_node_discovery">6.2.4.1. Node discovery</h5>
<div class="paragraph">
<p>The node discovery mechanism is used by individual nodes to find and establish
connections to other nodes. Once a node finds one other node in a system it will find
all other nodes in the system, and all the other nodes will find it.</p>
</div>
<div class="paragraph">
<p>This process is initiated by setting up <em>seeds</em>. Each node can have a list of addresses
that it will try to connect to. These addresses are known as seed addresses. A seed
address is simply the address of another node&#8217;s control channel, as configured in
<code>Safir.Dob.ThisNodeParameters.ControlAddress</code>.</p>
</div>
<div class="paragraph">
<p>A simple way to use this in a Client/Server system is to have all nodes list all the
server nodes' addresses in their seed list. This way, when any node starts, it will
attempt to connect to all servers, which will then tell it about all other clients.</p>
</div>
</div>
<div class="sect4">
<h5 id="system-start">6.2.4.2. System start</h5>
<div class="paragraph">
<p>A system, or more precisely, all nodes that are part of a specific system start, are identified by a unique
incarnation id.</p>
</div>
<div class="paragraph">
<p>The main purpose of the incarnation mechanism is to guarantee that an &#8220;old&#8221; node cannot join a newly started system.
Before a node joins a system it checks that the system incarnation id is not found in a locally kept &#8220;blacklist&#8221;
of old incarnation ids. The typical scenario is when restarting a system consisting of several nodes.
Without this mechanism a node that happens to survive the system restart could be included in the restarted system,
resulting in a mix of old and new data.</p>
</div>
<div class="paragraph">
<p>When a node starts it will wait for a certain amount of time to see if there is an
existing system with a non-blacklisted incarnation id to join on the network.</p>
</div>
<div class="paragraph">
<p>If no existing system is discovered during this time the node will act differently
depending on the specified value of <code>RequiredForStart</code> for the nodes node type. If
RequiredForStart is true the node will start a system of its own, possibly together with
other newly started nodes. If RequiredForStart is false the node will <em>not</em> start a
system of its own, it just waits for a system to join.</p>
</div>
<div class="paragraph">
<p>For example, in a client/server configuration, seeded as described above, setting
RequiredForStart to false for nodes of type Client, and to true for nodes of type Server,
will prevent clients from starting and forming multiple system on their own without a
server. Note that this applies only to the start phase, if clients lose contact with the
server in an already started system you can end up with a system that consists only of
client nodes.</p>
</div>
<div class="paragraph">
<p>Note that the &#8220;AloneTimeout&#8221; is calculated to be the maximum value of 2 *
MaxLostHeartbeats * HeartbeatInterval for all node types. One upshot of this is that if
you configure one node type to have very large values for these parameters then the
system will appear slow to start. But this is all to be expected, since the reason for
setting large values is that a node type has bad connectivity, and then we may need a
long time to discover it.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="multiple-nodes-on-one-computer">6.2.5. Multiple nodes on one computer</h4>
<div class="paragraph">
<p>As hinted at before it is in fact possible to run multiple Dob nodes on a single computer
(this is a new feature in Safir SDK Core 6.0). The way that the nodes are distinguished
from each other is by setting the environment variable <code>SAFIR_INSTANCE</code>. All processes
that have the same value of SAFIR_INSTANCE will form one node.</p>
</div>
<div class="paragraph">
<p>So, for example, you can start two instances of <code>safir_control</code>, one with SAFIR_INSTANCE
set to 0, and one with it set to 1. When you then start an application, with
SAFIR_INSTANCE set to 1 it will be part of the second safir_control instance. Remember
that it is possible to specify parameter overrides that are only loaded for certain
values of SAFIR_INSTANCE, as described in <a href="#typesystem_ini">typesystem.ini</a>.</p>
</div>
<div class="paragraph">
<p>If you want the nodes to talk to each other you will need to set up seeding, as described
above, but it is of course possible to run two completely separate and different systems.</p>
</div>
</div>
<div class="sect3">
<h4 id="distribution-scope">6.2.6. Distribution scope</h4>
<div class="paragraph">
<p>Normal entities, entity and service registrations and messages are sent to all nodes in a
system. It is, however, possible to change this behaviour by configuring a type&#8217;s
&#8220;Distribution Scope&#8221; to be either <code>Local</code> or <code>Limited</code>.</p>
</div>
<div class="sect4">
<h5 id="_local_types">6.2.6.1. Local types</h5>
<div class="paragraph">
<p><em>Local types</em> are object types that are not sent over the network.</p>
</div>
<div class="paragraph">
<p>For some entities, services and messages it is not desirable to have them sent over the
network at all. These are known as local types. Things like settings for an operator
on one operator console or other things that only apply to the current node like which
object is selected in the map are typically Local objects.</p>
</div>
<div class="paragraph">
<p>An object is specified as Local by mapping the <code>Safir.Dob.DistributionScopeProperty</code> to
it, with the value "Local" as DistributionScope, using a dom file.</p>
</div>
<div class="listingblock">
<div class="title">Specifying that an object is local.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;propertyMapping</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
                 <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property&gt;</span>Safir.Dob.DistributionScopeProperty<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;class&gt;</span>Capabilities.Selection<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;memberMapping&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;propertyMember&gt;</span>DistributionScope<span class="nt">&lt;/propertyMember&gt;</span>
            <span class="nt">&lt;value&gt;</span>Local<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;/memberMapping&gt;</span>
<span class="nt">&lt;/propertyMapping&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="limited-types">6.2.6.2. Limited Types</h5>
<div class="paragraph">
<p>Light nodes (as described in <a href="#light-nodes">Full nodes and Light nodes</a>) are only able to be given their extra
flexibility by giving up the ability to own &#8220;normal&#8221; types. Instead they are given the
ability to own <em>Limited types</em>, that have a number of limitations put upon them.  The
limitations are there to ensure that a light node can reattach to a system after it has
been detached.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A limited type can have no persistence, i.e. it has neither Volatile, Permanent or Injectable persistence.</p>
</li>
<li>
<p>Pending registrations of a limited type is not allowed.</p>
</li>
<li>
<p>Overregistration of a limited type is considered a programming or configuration error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you have multiple handlers of the same limited type you need to make sure to have
unique handler ids for each of them. There is no guarantee that overregistrations will be
detected and reported, although some effort is made.</p>
</div>
<div class="paragraph">
<p>An object is specified as Limited by mapping the <code>Safir.Dob.DistributionScopeProperty</code> to
it, with the value "Limited" as DistributionScope, using a dom file.</p>
</div>
<div class="listingblock">
<div class="title">Specifying that an object is limited.</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;propertyMapping</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
                 <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;property&gt;</span>Safir.Dob.DistributionScopeProperty<span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;class&gt;</span>Capabilities.ClientStatus<span class="nt">&lt;/class&gt;</span>
    <span class="nt">&lt;memberMapping&gt;</span>
        <span class="nt">&lt;member&gt;</span>
            <span class="nt">&lt;propertyMember&gt;</span>DistributionScope<span class="nt">&lt;/propertyMember&gt;</span>
            <span class="nt">&lt;value&gt;</span>Limited<span class="nt">&lt;/value&gt;</span>
        <span class="nt">&lt;/member&gt;</span>
    <span class="nt">&lt;/memberMapping&gt;</span>
<span class="nt">&lt;/propertyMapping&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="persistence_config">6.3. Persistence config</h3>
<div class="paragraph">
<p>The persistence service, provided by the <code>dope_main</code> executable has a few different features that might be good to know about. It has three <em>backends</em>, one that does nothing, one that persists entities to files, and one that persists them to a database.</p>
</div>
<div class="paragraph">
<p>A few relevant parameters for the persistence service, apart from the ones described in <a href="#using_persistence">Using persistence</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Safir.Dob.PersistenceParameters.Backend</em></dt>
<dd>
<p>Which backend should be used, <em>None</em>, <em>Odbc</em> database or <em>File</em>.</p>
</dd>
<dt class="hdlist1"><em>Safir.Dob.PersistenceParameters.FileStoragePath</em></dt>
<dd>
<p>The path where files are stored if the file backend is chosen. Obviously dope_main needs
write permissions here. Remember that you can use environment variables and special
variables here, as described in <a href="#environment_parameters">Environment variables in parameters</a>.</p>
</dd>
<dt class="hdlist1"><em>Safir.Dob.PersistenceParameters.OdbcStorageConnectString</em></dt>
<dd>
<p>The connection string to use to connect to the database.</p>
</dd>
<dt class="hdlist1"><em>Safir.Dob.PersistenceParameters.StandaloneMode</em></dt>
<dd>
<p>This parameter allows enabling deprecated functionality. Please don&#8217;t do it!</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The default behaviour is that an entity is written to external storage as soon as it is updated, which, for frequently updated entities, might generate a lot of writes to external storage.</p>
</div>
<div class="paragraph">
<p>The &#8220;Persistence Throttling&#8221; mechanism can be used to limit the number of writes for instances of a certain entity type. The throttling mechanism is applied by mapping the property <code>Safir.Dob.PersistenceThrottlingProperty</code> to it. An entity instance will be written no more often than given by the property value <code>WritePeriod</code>.</p>
</div>
<div class="paragraph">
<p>There is more information about the persistence service in <a href="#persistence_service">The persistence service</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="request_timeout_config">6.4. Request timeouts config</h3>
<div class="paragraph">
<p>Timeouts are defined using the properties Safir.Dob.RequestTimeoutProperty and Safir.Dob.RequestTimeoutOverrideProperty. If no response have been received when the timeout occurs, the Dob itself sends a timeout response to the Requestor. If the missing response arrives after this, it is just ignored. I.e., the Dob guarantees that the requestor will receive one, and only one, response. See also <a href="#request_timeouts">Request timeouts</a>.</p>
</div>
<div class="paragraph">
<p>The default timeout for service requests is 7 seconds and for entity requests 2 seconds, and these can be changed by changing the timeout properties on the <code>Safir.Dob.Entity</code> and <code>Safir.Dob.Service</code> classes.</p>
</div>
<div class="paragraph">
<p>Note that the RequestTimeoutProperty is inherited, whereas the RequestTimeoutOverrideProperty is not inherited, so setting a RequestTimeoutProperty on a class will cause all derived classes to get the same timeouts. The Override-property can be used when this is not the desired behaviour, or for making an exception on one level of an inheritance "tree".</p>
</div>
</div>
<div class="sect2">
<h3 id="queue_lengths">6.5. Queue lengths config</h3>
<div class="paragraph">
<p>By default all the length of the in and out queues of messages and requests is 10. The queue lengths can be customized by changing the parameter <code>Safir.Dob.QueueParameters.QueueRules</code>.</p>
</div>
<div class="paragraph">
<p>The QueueRules parameter is an array of <code>Safir.Dob.QueueRule</code> items, each containing one rule to apply to the queue lengths. An example is shown below.</p>
</div>
<div class="listingblock">
<div class="title">A queue length parameterization</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="xml"><span class="cp">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span>
<span class="nt">&lt;class</span> <span class="na">xmlns=</span><span class="s">"urn:safir-dots-unit"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;name&gt;</span>Safir.Dob.QueueParameters<span class="nt">&lt;/name&gt;</span>
  <span class="nt">&lt;baseClass&gt;</span>Safir.Dob.Parametrization<span class="nt">&lt;/baseClass&gt;</span>
  <span class="nt">&lt;parameters&gt;</span>
    <span class="nt">&lt;parameter&gt;</span>
        <span class="nt">&lt;name&gt;</span>QueueRules<span class="nt">&lt;/name&gt;&lt;type&gt;</span>Safir.Dob.QueueRule<span class="nt">&lt;/type&gt;</span>
        <span class="nt">&lt;array&gt;</span>
            <span class="c">&lt;!-- The first array item is the default queue lengths.
            It matches all connection names. --&gt;</span>
            <span class="nt">&lt;Safir.Dob.QueueRule&gt;</span>
                <span class="nt">&lt;MessageInQueueCapacity&gt;</span>10<span class="nt">&lt;/MessageInQueueCapacity&gt;</span>
                <span class="nt">&lt;MessageOutQueueCapacity&gt;</span>10<span class="nt">&lt;/MessageOutQueueCapacity&gt;</span>
                <span class="nt">&lt;RequestInQueueCapacity&gt;</span>10<span class="nt">&lt;/RequestInQueueCapacity&gt;</span>
                <span class="nt">&lt;RequestOutQueueCapacity&gt;</span>10<span class="nt">&lt;/RequestOutQueueCapacity&gt;</span>
            <span class="nt">&lt;/Safir.Dob.QueueRule&gt;</span>
            <span class="c">&lt;!-- let connections with 'long' in their connection names
            have longer message in queues and request out queues. --&gt;</span>
            <span class="nt">&lt;Safir.Dob.QueueRule&gt;</span>
                <span class="nt">&lt;ConnectionNameRegex&gt;</span>long<span class="nt">&lt;/ConnectionNameRegex&gt;</span>
                <span class="nt">&lt;MessageInQueueCapacity&gt;</span>20<span class="nt">&lt;/MessageInQueueCapacity&gt;</span>
                <span class="nt">&lt;RequestOutQueueCapacity&gt;</span>50<span class="nt">&lt;/RequestOutQueueCapacity&gt;</span>
            <span class="nt">&lt;/Safir.Dob.QueueRule&gt;</span>
            <span class="c">&lt;!-- let connections with at least one capital letter in their
            connection name have longer message out queues. --&gt;</span>
            <span class="nt">&lt;Safir.Dob.QueueRule&gt;</span>
                <span class="nt">&lt;ConnectionNameRegex&gt;</span>[A-Z]+<span class="nt">&lt;/ConnectionNameRegex&gt;</span>
                <span class="nt">&lt;MessageOutQueueCapacity&gt;</span>300<span class="nt">&lt;/MessageOutQueueCapacity&gt;</span>
            <span class="nt">&lt;/Safir.Dob.QueueRule&gt;</span>
        <span class="nt">&lt;/array&gt;</span>
    <span class="nt">&lt;/parameter&gt;</span>
  <span class="nt">&lt;/parameters&gt;</span>
<span class="nt">&lt;/class&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When a new connection is opened the rules are scanned from top to bottom, and the <em>maximum values</em> of all rules where the ConnectionName member matches are used. No ConnectionName in a rule means "match all". It is important to have one rule, like the first one in the example above, that provide default values. Finding no match causes undefined behavior.</p>
</div>
<div class="paragraph">
<p>Here are some example connection names and their resulting queue lengths:</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 70%;">
<colgroup>
<col style="width: 40%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
<col style="width: 15%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Connection Name</th>
<th class="tableblock halign-left valign-top">MsgInQ</th>
<th class="tableblock halign-left valign-top">MsgOutQ</th>
<th class="tableblock halign-left valign-top">ReqInQ</th>
<th class="tableblock halign-left valign-top">ReqOutQ</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">my_connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">my_long_connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">My_Connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">my_long_Connection</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">20</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">10</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">50</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
Before deciding to change the queue lengths you should have read and understood <a href="#overflow_handling">Overflow handling</a>, <a href="#request_timeouts">Request timeouts</a>, and the two items on overflows in <a href="#faq">FAQ</a>. It is important to understand what effects, other than just increasing memory use, this may have on your system.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="memory_config">6.6. Shared Memory config</h3>
<div class="paragraph">
<p>The Dob has two parameters that control the amount of shared memory used, one that
controls the amount of memory available for the typesystem (the internal tables for all
types, and all parameters), and one that controls the amount of memory available for the
distribution mechanism.</p>
</div>
<div class="paragraph">
<p>The parameter that controls the typesystem memory can be found in the file
<code>typesystem.ini</code>, as described in <a href="#typesystem_ini">typesystem.ini</a>. The amount of memory that the
typesystem needs is completely static, i.e. it does not change at all during runtime, so
if you have been able to start <code>safir_control</code> you know that you have enough memory allocated
for the typesystem.</p>
</div>
<div class="paragraph">
<p>The parameter that controls the shared memory used by the distribution mechanism is
called <code>SharedMemorySize</code> and can be found in Safir.Dob.NodeParameters.dou. Knowing what
value to set <code>SharedMemorySize</code> to is trickier since the memory usage varies over time,
but one approach is to run the system and monitor the memory usage, for example using
<em>dobexplorer</em>, which is described in <a href="#dobexplorer">Dobexplorer</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_memory_levels_and_graceful_degradation">6.7. Memory levels and graceful degradation</h3>
<div class="paragraph">
<p>To ensure optimal performance and avoid potential issues related to memory exhaustion,
Safir SDK Core implements five different memory levels, namely: <em>Normal</em>, <em>Warning</em>,
<em>Low</em>, <em>VeryLow</em>, and <em>ExtremelyLow</em>. These memory levels are parameterized in the
<code>Safir.Dob.NodeParameters.SharedMemoryLevels</code> parameter.</p>
</div>
<div class="paragraph">
<p>The memory levels in the Safir SDK Core&#8217;s distribution mechanism are designed to enable
graceful degradation in resource-constrained environments. When memory consumption gets
to the Low level and beyond, the system is able take precautionary measures to prevent
critical failures by adapting its behavior and prioritizing essential operations and
giving operators a chance to reduce memory usage before actual fatal memory allocation
failures occur.</p>
</div>
<div class="paragraph">
<p>The five memory levels and their descriptions are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>Normal</em></dt>
<dd>
<p>Everything works as normal.</p>
</dd>
<dt class="hdlist1"><em>Warning</em></dt>
<dd>
<p>Everything continues to work as normal, but system operators should be alerted to the
fact that memory is running low. Warnings are logged to the syslog. Default threshold is 20%.</p>
</dd>
<dt class="hdlist1"><em>Low</em></dt>
<dd>
<p>In the Low memory level, the system restricts operations that allocate new object
instances. Default threshold is 15%.</p>
</dd>
<dt class="hdlist1"><em>VeryLow</em></dt>
<dd>
<p>In the VeryLow memory level, the system restricts operations that modify existing object
instances or potentially lock instances in memory. Default threshold is 8%.</p>
</dd>
<dt class="hdlist1"><em>ExtremelyLow</em></dt>
<dd>
<p>This is the most severe memory level, indicating an extremely constrained environment. At
this point, the system attempts to forbid all operations, even those that just cause
temporary shared memory allocation. Default threshold is 3%.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>If your system is designed in a way that makes it likely that it will reach these memory
levels it is recommended to have a component that monitors the memory levels and issues
UI alerts to the operators when the warning level and beyond are reached.</p>
</div>
<div class="sect3">
<h4 id="_forbidden_operations_at_severe_memory_levels">6.7.1. Forbidden operations at severe memory levels</h4>
<div class="paragraph">
<p>At the Warning, Low, and VeryLow memory levels, Safir SDK Core imposes restrictions on
certain operations to prevent memory exhaustion and prioritize essential tasks. When one
of these operations are performed when they are not allowed a
<code>Safir.Dob.LowMemoryException</code> will be thrown. The table below outlines the operations
that become forbidden at each of the memory levels:</p>
</div>
<table id="forbidden_operations" class="tableblock frame-ends grid-all" style="width: 95%;">
<caption class="title">Table 13. Operations that <em>become</em> forbidden at each memory level</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 15%;">
<col style="width: 28%;">
<col style="width: 25%;">
<col style="width: 12%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Memory Level</th>
<th class="tableblock halign-left valign-top">Connections</th>
<th class="tableblock halign-left valign-top">Entities</th>
<th class="tableblock halign-left valign-top">Services</th>
<th class="tableblock halign-left valign-top">Messages</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal, Warning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Low</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Create new instance</strong><br>
Inject</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">VeryLow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Open</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register<br>
Register Pending<br>
Subscribe<br>
Subscribe Registration<br>
Unregister<br>
<strong>Read</strong><br>
<strong>Update existing instance</strong><br>
<strong>Delete existing instance</strong><br>
Create iterator<br>
GetNumberOfInstances<br>
Inject Deletion</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Register<br>
Register Pending<br>
Subscribe Registration<br>
Unregister<br></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ExtremelyLow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">-</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CreateRequest<br>
UpdateRequest<br>
DeleteRequest<br>
SendResponse<br>
Unsubscribe Registration<br>
Unsubscribe Entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SendRequest<br>
SendResponse<br>
Unsubscribe Registration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Subscribe<br>
Send</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The four operations highlighted in bold can be moved to VeryLow or ExtremelyLow for a
specific entity type by defining <code>LowMemoryOperationsAllowedProperty</code> (which can be
overridden using <code>LowMemoryOperationsAllowedOverrideProperty</code>) on that type. That
property has a member <code>DisallowAtLevel</code>, which if it is set to VeryLow will move the
<em>Create new instance</em> operation down to the VeryLow level, and if set to ExtremelyLow
will move all four operations down to the ExtremelyLow level. Any other values for
DisallowAtLevel are illegal. Great care should be taken to only use this facility for
types that are set rarely and are small, since this introduces a risk of increasing
memory usage even higher when it is already high.</p>
</div>
<div class="sect4">
<h5 id="_some_notes_on_why_things_are_where_they_are_in_the_table_above">6.7.1.1. Some notes on why things are where they are in the table above</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">GetNumberOfInstances at VeryLow?</dt>
<dd>
<p>GetNumberOfInstances uses entity iterators under the hood, so it gets forbidden along with the iterators.</p>
</dd>
<dt class="hdlist1">Entity iteration and Read at VeryLow?</dt>
<dd>
<p>These operations hold references to things in shared memory until the caller releases them.</p>
</dd>
<dt class="hdlist1">Unregister at VeryLow?</dt>
<dd>
<p>An unregistration can cause a whole bunch of entity instances to be deleted, which may cause the
creation of a lot of ghost entities, which means shared memory allocations.</p>
</dd>
<dt class="hdlist1">Read affected by LowMemoryOperationsAllowedProperty?</dt>
<dd>
<p>SetChanges uses Read internally, so the implementation became a lot simpler by moving that too.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_api_for_getting_current_memory_level">6.7.2. API for getting current memory level</h4>
<div class="paragraph">
<p><code>Safir.Dob.ConnectionAspectMisc</code> contains functions that are useful for monitoring the
shared memory:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>GetSharedMemoryLevel</code></dt>
<dd>
<p>Gives you the current shared memory level on the current node.</p>
</dd>
<dt class="hdlist1"><code>GetSharedMemoryUsage</code></dt>
<dd>
<p>Gives you the current shared memory usage in bytes on the current node.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_testing_application_memory_handling">6.7.3. Testing application memory handling</h4>
<div class="paragraph">
<p><code>safir_memory_allocator</code> can be used to generate fake memory pressure on a node. For
example the commands</p>
</div>
<div class="listingblock">
<div class="content">
<pre>safir_memory_allocator --allocate Low
safir_memory_allocator --deallocate</pre>
</div>
</div>
<div class="paragraph">
<p>will allocate shared memory until the system reaches the Low level, and deallocate all
memory allocated by this tool, respectively.</p>
</div>
<div class="paragraph">
<p>Run <code>safir_memory_allocator --help</code> for more information.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="safir_logging">7. Safir Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core has a mechanism, Safir Log, designed to make it simpler for applications to generate and send log messages according to the widely adopted <em>Syslog</em> protocol <a href="http://www.ietf.org/rfc/rfc3164.txt">RFC 3164</a>.</p>
</div>
<div class="paragraph">
<p>Safir Log provides an easy-to-use interface that allows an application to create and send logs by a simple function call, specifying a severity and a message. The framework will do the neccessary formatting and transmission over UDP as is specified in RFC 3164.</p>
</div>
<div class="paragraph">
<p>It is also possible to configure Safir Log so that the logs are sent to a native, platform specific, logging mechanism. In practice, this could be of use on the Windows platform to send logs to the Windows Event Log and on Linux to send the logs directly to the <code>syslog(&#8230;&#8203;)</code> interface instead of using UDP messages.</p>
</div>
<div class="listingblock">
<div class="title">Example, sending a log message using C++</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="cp">#include</span> <span class="cpf">&lt;Safir/Logging/Log.h&gt;</span><span class="cp">
</span>
<span class="n">Safir</span><span class="o">::</span><span class="n">Logging</span><span class="o">::</span><span class="n">SendSystemLog</span><span class="p">(</span><span class="n">Safir</span><span class="o">::</span><span class="n">Logging</span><span class="o">::</span><span class="n">Error</span><span class="p">,</span> <span class="s">L"This is an error log!"</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that Safir SDK Core only provides the functionality related to the sending side for syslog messages. In order to collect and view the log messages a syslog server is needed. Such a server can range from a simple program listening for UDP packets and dumping the result on standard output, to more sophisticated solutions that support filtering, writing logs do disk or database and provide advanced search and report generation functionality. A syslog daemon is included in most Linux distributions and for Windows there are several third-party syslog servers.</p>
</div>
<div class="sect2">
<h3 id="_logging_guidelines">7.1. Logging guidelines</h3>
<div class="paragraph">
<p>This section provides some guidelines that, when applied, will help you make your application behave like a "good citizen" in the syslog ecosystem.</p>
</div>
<div class="paragraph">
<p>First of all we recommend that you establish project/product specific logging guidelines so that the separate parts that form your system exhibit a consistent logging behaviour.</p>
</div>
<div class="paragraph">
<p>Syslog is a "one-liner" oriented protocol. This, and the fact that syslog servers are known to handle messages differently regarding new lines, means that we recommend that you try to make your logs one-liners. When put together, the one-liner logs from your application should form a coherent narrative.</p>
</div>
<div class="sect3">
<h4 id="_facility_and_severity">7.1.1. Facility and Severity</h4>
<div class="paragraph">
<p>A syslog message has a Priority value (PRI) that is a representation of both the Facility and the Severity of the message. PRI is used by syslog deamons to filter and redirect logs but is normally not shown in the log output. Therefore, compose the log message text so that it is clear and understandable without the facility and severity context.</p>
</div>
<div class="paragraph">
<p>The Safir Log mechanism uses facility code 1 (user-level messages) for all syslog messages and it is not a parameter visible in the interface.</p>
</div>
<div class="paragraph">
<p>The severity level must be set by the application. RFC 3164 has a brief description of the interpretation of the severity level but doesn&#8217;t really give any detailed advice. To summarize: higher severity levels imply that action from support/tech staff is more urgent, than for lower levels. In practice it isn&#8217;t always obvious what severity level to use. This is especially true for code in libraries/platforms where there usually is no knowledge of the characteristics of the calling application. One could argue that libraries should refrain from generating logs at all and instead inform the using application that an error has occurred, so that it can take appropriate action. Since Safir SDK Core does not adhere to this rule itself we leave this as something to consider during library design.</p>
</div>
<div class="paragraph">
<p>The system design in terms of redundancy might also affect the choosen severity level. For example, it might be appropriate for a system built and configured so that there is a standby application/node "taking over" in case of failure, to use severity level Error instead of Emergency for a given event.</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 14. Syslog severity levels</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">RFC 3164 Severity Level</th>
<th class="tableblock halign-left valign-top">RFC 3164 Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Emergency</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System is unusable.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alert</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Action must be taken immediately.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Critical</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Critical conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Warning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Warning conditions.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notice</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal but significant condition.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational messages.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debug-level messages.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Here are some recommendations regarding wich severity level to use for some typical classes of errors and events found in Safir systems.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Fatal error</dt>
<dd>
<p>This type of error includes static conditions that must be fulfilled to be able to start/continue executing the program, for example missing static resources or invalid configuration. It also includes programming errors, that is, errors of assert-type. In these cases send a Safir Log with severity in the range Critical to Emergency and then exit the program with an error code (i.e. a non-zero exit code).</p>
</dd>
<dt class="hdlist1">Non-fatal error</dt>
<dd>
<p>This type of error indicates that an error is detected but the program can continue to execute. An example would be the reception of a message from an external system in an invalid format. In this case send a Safir Log with severity Error. Normally the program continues to execute, possibly in a degraded state.</p>
</dd>
<dt class="hdlist1">Dynamic Resource</dt>
<dd>
<p>A dynamic resource is defined as a resource that is not guaranteed to be available at the time the program starts and/or a resource that can "come and go" during program execution. Send a Safir Log with severity Error to report that the resource is missing. When the resource has been acquired a Safir Log with severity Informational should be sent. Note that since it is "ok" for a dynamic resource to be temporarily missing, an Error log should be sent only after a reasonably number of retries to acquire it.</p>
</dd>
<dt class="hdlist1">Warning log</dt>
<dd>
<p>Use severity Warning for events that indicates that an error will occur if action is not taken, e.g. a disk is almost full.</p>
</dd>
<dt class="hdlist1">Informational/Debug log</dt>
<dd>
<p>For events of type Informational use the most appropriate of the severity Notice or Informational. Although it is possible to send debug logs using the Safir Log mechanism directly have a look Tracer and Backdoor functionality (see <a href="#debugging_support">Debugging support</a>) for a more powerful interface for debug logging.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_safir_logging_configuration">7.2. Safir Logging configuration</h3>
<div class="paragraph">
<p>The configuration of Safir Logging is located in the file <code>logging.ini</code> (see <a href="#configuration">Configuration</a>) and contains parameters that determine where the log messages are sent and how newlines in log messages should be handled.</p>
</div>
</div>
<div class="sect2">
<h3 id="_safir_logging_on_windows">7.3. Safir Logging on Windows</h3>
<div class="paragraph">
<p>Windows doesn&#8217;t have built-in support for receiving syslog messages. However, you can find third-party syslog servers that target the Windows platform, both commercial and freely distributed. One example is Kiwi Syslog Server (<a href="http://www.kiwisyslog.com" class="bare">http://www.kiwisyslog.com</a>), but others are available.</p>
</div>
<div class="paragraph">
<p>To enable logging using syslog on Windows, the parameter <code>send_to_syslog_server</code> shall be set to true and the parameters <code>syslog_server_address</code> and <code>syslog_server_port</code> shall be set to appropriate values.</p>
</div>
<div class="sect3">
<h4 id="windows_native_logging">7.3.1. Windows Event Log</h4>
<div class="paragraph">
<p>Safir Log also provides a way of writing syslog messages to the Windows Event Log. To enable this, set the parameter <code>native_logging</code> to true.</p>
</div>
<div class="paragraph">
<p>For native logging the event source will be set to "Safir" and the severity level parameter is mapped to a corresponding Windows Event Log Type according to:</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 15. Mapping severity level to Windows event type</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">RFC 3164 Severity Level</th>
<th class="tableblock halign-left valign-top">Windows Event Log Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Emergency, Alert, Critical, Error</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Warning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Warning</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notice, Informational, Debug</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Information</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_safir_logging_on_linux">7.4. Safir Logging on Linux</h3>
<div class="paragraph">
<p>The recommended configuration on Linux is to have the system configured for native logging which means that Safir Log will use the Linux system call <code>syslog(&#8230;&#8203;)</code> for generating logs. If you want the logs sent to a remote syslog server you can configure your local sysloc daemon to forward the logs.</p>
</div>
<div class="paragraph">
<p>Most Linux distributions come with a built-in syslog deamon capable of receiving and handling syslog messages, and many distributions make it possible to switch syslog daemon, in case you are not happy with the default. Refer to the documentation of your distribution for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="_porting_guidelines">7.5. Porting guidelines</h3>
<div class="paragraph">
<p>The logging interface provided by Safir SDK Core before version 4.5 (aka Software Reporting or SwReports) is now deprecated and will be removed in some future version of the SDK. This section provides some guidelines when porting old code to use the new interface provided by Safir Log.</p>
</div>
<div class="paragraph">
<p>As already mentioned, syslog has a bias towards one-liner messages which means that it could be a good idea to try to reduce the message text to contain just the most essential information.</p>
</div>
<div class="paragraph">
<p>The following table shows the recommended mapping between the report types used by Software Reporting and syslog severity level.</p>
</div>
<table class="tableblock frame-ends grid-none" style="width: 70%;">
<caption class="title">Table 16. Recommended mapping of Software Reporting types to syslog severity level</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Software Reporting</th>
<th class="tableblock halign-left valign-top">Recommended Syslog Severity Level</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fatal Error Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Emergency, Alert or Critical</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource Report, missing resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource Report, acquried resource</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Informational</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Program Info Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Debug</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Programming Error Report</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Emergency, Alert or Critical</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="node_control">8. Node control</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A Safir system consists of one ore more Safir nodes that execute on one or more computers. A single computer can host several Safir nodes, see <a href="#multiple-nodes-on-one-computer">Multiple nodes on one computer</a>.</p>
</div>
<div class="paragraph">
<p>Safir SDK Core provides a GUI application, Node Control, that presents information about the nodes that constitute the system. The GUI can also be used to execute Safir node stop and computer shutdown/reboot of individual nodes or the complete system, see <a href="#stop">Stop</a>.</p>
</div>
<div class="paragraph">
<p>There is also a simple command line tool that can be used to execute different stop orders.</p>
</div>
<div class="sect2">
<h3 id="_node_control_gui">8.1. Node Control GUI</h3>
<div class="paragraph">
<p>To start the Node Control GUI run <code>safir_control_gui</code>.</p>
</div>
<div class="paragraph">
<p>In order to get system information, the GUI needs another program, <code>safir_status</code>. This program act as a gateway to the lower parts and exposes a Dob interface that is used by the GUI to control the nodes.</p>
</div>
<div class="paragraph">
<p><code>safir_control_gui</code> communicates with the local <code>safir_status</code> program which means that both programs must execute on the same node. However, it is perfectly ok to start these programs on all (or a subset) of the nodes that constitue the system. The Node Control GUI on any node can be used to view the status of the complete system as well as to stop a specific node or all nodes.</p>
</div>
<div class="paragraph">
<p><a href="#node_control_overview">Node Control screen shot</a> shows a system with 3 nodes. In this case all three Safir nodes run on the local computer using the loopback address. The node that is highlighted in green is the node that the gui is connected to (i.e. the local node). The circled-L symbol shows that the node is a light node. The State column shows whether a light node is <em>Detached</em> or <em>Attached</em> to the system. Full nodes always have state <em>Normal</em>.</p>
</div>
<div class="paragraph">
<p>For an explanation of what full and light nodes are, see <a href="#light-nodes">Full nodes and Light nodes</a>.</p>
</div>
<div id="node_control_overview" class="imageblock">
<div class="content">
<a class="image" href="images/node_control.png"><img src="images/node_control.png" alt="Node Control Screen shot"></a>
</div>
<div class="title">Figure 10. Node Control screen shot</div>
</div>
<div class="paragraph">
<p>The Reboot and Shutdown buttons will only be enabled if the parameters <code>Safir.Control.Parameters.RebootCommand</code> and <code>Safir.Control.Parameters.ShutdownCommand</code> are set to something useful.</p>
</div>
</div>
<div class="sect2">
<h3 id="_command_line_tool">8.2. Command Line Tool</h3>
<div class="paragraph">
<p><code>safir_control_cli</code> is a simple command line tool that can be used to execute different stop orders. This tool doesn&#8217;t require the <code>safir_status</code> program to be started. Type <code>safir_control_cli --help</code> for the available command line options.</p>
</div>
</div>
<div class="sect2">
<h3 id="_start">8.3. Start</h3>
<div class="paragraph">
<p>The Dob is started by running the executable <code>safir_control</code>. This program will in turn start the executable that is the real framework workhorse, <code>dose_main</code>.</p>
</div>
<div class="paragraph">
<p>How and when <code>safir_control</code> is started is outside the control of Safir SDK Core. For example, the program can be started by a script at computer start-up or manually in a terminal window.</p>
</div>
<div class="sect3">
<h4 id="_why_isnt_there_any_support_for_start_of_applications">8.3.1. Why isn&#8217;t there any support for start of applications?</h4>
<div class="paragraph">
<p>You may wonder why there isn&#8217;t any support for starting applications. The answer is that there are plans for this but as of today this is not implemented.</p>
</div>
<div class="paragraph">
<p>The application start mechanism will - when it has been implemented - provide
functionality along these lines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Let you configure which applications to start on different nodes.</p>
</li>
<li>
<p>Monitor applications.</p>
</li>
<li>
<p>Show application status (fully functional, degraded etc.)</p>
</li>
<li>
<p>Start of applications on fallback nodes in case of application failure.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="stop">8.4. Stop</h3>
<div class="paragraph">
<p>Safir SDK Core provides functionality to stop a specific node or to stop the complete Safir system.</p>
</div>
<div class="paragraph">
<p>After a Safir node is stopped there is an option to perform a computer shutdown or reboot.</p>
</div>
<div class="paragraph">
<p>&#8216;Stop&#8217; is used in this description as a generic term for any of these stop mechanisms.</p>
</div>
<div class="sect3">
<h4 id="_safir_node_stop">8.4.1. Safir node stop</h4>
<div class="paragraph">
<p>Stop of a specific Safir node will stop all safir-related processes in a controlled fashion. At stop, <code>dose_main</code> will send stop orders to all applications that have a dob connection (see <a href="#stop_orders">Stop orders</a>) which means that all application programs will be stopped as well. Note that an application might for some reason (by design or because of a bug) ignore a stop order so there is no absolute guarantee that all applications are stopped.</p>
</div>
</div>
<div class="sect3">
<h4 id="_safir_system_stop">8.4.2. Safir system stop</h4>
<div class="paragraph">
<p>A Safir system stop, that is, an order to stop all nodes that constitute a Safir system, triggers a write to
the &#8220;incarnation blacklist&#8221; mechanism, see <a href="#system-start">System start</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_shutdown">8.4.3. Shutdown</h4>
<div class="paragraph">
<p>Safir SDK Core provides a mechanism to execute an optional computer shutdown after the Safir node is stopped.</p>
</div>
<div class="paragraph">
<p>Since the command to execute a computer shutdown is tightly coupled to the operating system and also in many cases involves setting specific arguments, the actual shutdown command is specified by the parameter ShutdownCommand found in Safir.Dob.NodeParameters.</p>
</div>
<div class="paragraph">
<p>For example, <code>/usr/bin/shutdown --poweroff now</code> for Linux or <code>C:\\WINDOWS\\System32\\shutdown /s /t 0</code> for Windows, could be used as shutdown command. The command must be given as an absolute path. Note that it might be necessary to make additional configurations outside Safir, like setting permissions, to be able to run the command.</p>
</div>
<div class="paragraph">
<p>Note that a shutdown initiated by this mechanism will implicitly execute a Safir node stop before the shutdown command, which means that the Safir programs will be stopped in a controlled fashion before the computer is shutdown.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reboot">8.4.4. Reboot</h4>
<div class="paragraph">
<p>Much like the shutdown command Safir SDK Core also provides a mechanism to reboot the computer where a safir node is running.</p>
</div>
<div class="paragraph">
<p>The reboot command is specified by the parameter RebootCommand found in Safir.Dob.NodeParameters.</p>
</div>
<div class="paragraph">
<p>Example of a reboot command for Linux: <code>/usr/bin/shutdown --reboot now</code>, or for Windows: <code>C:\\WINDOWS\\System32\\shutdown /r /t 0</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="debugging_support">9. Debugging support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core provides support for applications to have a "back door" to make it possible to interactively enquire about the status of an application or to turn on and off debug logging. It also provides an interface that makes it easy to add debug trace logging to applications.</p>
</div>
<div class="sect2">
<h3 id="_the_bd_backdoor_command">9.1. The bd (backdoor) command</h3>
<div class="paragraph">
<p>The SDK defines a Dob message, Safir.Application.Backdoor to be used to send debugging
commands to applications. Backdoor commands can either be sent using Sate (see <a href="#sate">Sate</a>),
or by the command-line program "bd" (use "<code>bd -h</code>" to get info on usage).</p>
</div>
<div class="paragraph">
<p>There are some predefined backdoor commands that applications should handle:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Ping:</strong> When receiving this command the application should send a Safir Log (at Debug severity) that indicates that it is alive.</p>
</li>
<li>
<p><strong>Help:</strong> When receiving this command the application should send a Safir Log (at Debug severity) that contains a listing of the supported backdoor commands.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Backdoor commands are Dob messages and are therefore sent to all subscribers. This means that applications have to check whether or not a backdoor message is addressed to them before acting on them. The SDK provides two classes, <code>Safir.Application.BackdoorKeeper</code> and <code>Safir.Application.Backdoor</code>, that simplifies the handling of backdoor commands. The classes provide this functionality:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Setup of subscriptions for backdoor command messages.</p>
</li>
<li>
<p>Checking of whether or not a backdoor command is to be handled by this application.</p>
</li>
<li>
<p>Automatic answers to Ping commands.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Output from an application as a response to a backdoor command should be through a system log, preferrably at Debug level (see <a href="#safir_logging">Safir Logging</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="_tracer">9.2. Tracer</h3>
<div class="paragraph">
<p>The Tracer is intended to be used for developer/integration logging inside applications. It should never be used as the sole target for logging errors, since the output can only be viewed by developers. A common way to use trace logging is to log "significant events" or other points of interest, so that the developer can find out what his component is doing when running on a test system or when running in a situation when it is not desirable or possible to halt execution with a debugger.</p>
</div>
<div class="paragraph">
<p>The interface to the trace logging functionality is a class named <code>Safir.Application.Tracer</code> and a class named <code>Safir.Application.TracerBackdoor</code>.</p>
</div>
<div class="paragraph">
<p>Tracer objects are used to send logs to the Safir Log, and the TracerBackdoor is used to turn the different Tracers on and off. The Tracer class has no Dob dependencies itself, but the TracerBackdoor uses the Backdoor functionality, as described above.</p>
</div>
<div class="sect3">
<h4 id="_how_to_use">9.2.1. How to use</h4>
<div class="paragraph">
<p>The main goal of the Tracer class is for it to be as easy to use as possible, and that its usage should be as close to the languages own text input/output-syntax as possible.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Instantiate the Tracer class in each of the classes/packages where you want to use trace logging. Each instantiation requires a "prefix" which is used to enable and disable the logging from each tracer instantiation (described below). Several Tracer instances can use the same prefix, and will then all be enabled/disabled by the same command.</p>
</li>
<li>
<p>Log to the tracer-instance (in this example the instance is called "debug"):</p>
<div class="ulist">
<ul>
<li>
<p><strong>C++</strong></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">debug</span> <span class="o">&lt;&lt;</span> <span class="s">"Testing logging "</span> <span class="o">&lt;&lt;</span> <span class="n">myFloat</span> <span class="o">&lt;&lt;</span> <span class="s">", "</span> <span class="o">&lt;&lt;</span> <span class="n">myInt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>C#</strong></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="n">debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Testing logging {0}, {1}"</span><span class="p">,</span> <span class="n">myFloat</span><span class="p">,</span> <span class="n">myInt</span><span class="p">);</span></code></pre>
</div>
</div>
</li>
<li>
<p><strong>Java</strong></p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="java"><span class="n">debug</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Testing logging "</span> <span class="o">+</span> <span class="n">myFloat</span> <span class="o">+</span> <span class="s">", "</span> <span class="o">+</span> <span class="n">myInt</span><span class="o">);</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Call <code>Safir::Application::TracerBackdoor::Start(connection)</code> just after your program has opened its main Dob connection.</p>
</li>
<li>
<p>Call <code>Safir::Application::TracerBackdoor::Stop()</code> when your application is shutting down.</p>
</li>
<li>
<p>Enable and disable the logging by using the "bd" command. Send "&lt;prefix&gt; on" to turn on the logging of a prefix (also try "help" to see what prefixes are registered and what their current states are). To do this, type "bd -c myconnection myprefix on" in a command line window (if you skip the "-c myconnection" bit all applications in the system will receive the command, which may have undesired consequences).</p>
<div class="ulist">
<ul>
<li>
<p>It is possible to turn on/off all prefixes by sending "all on" to your application.</p>
</li>
<li>
<p>It is possible to turn on/off prefixes immediately from the start of an application by setting the environment variable FORCE_LOG to one or several "&lt;prefix&gt;" or "all". This is useful to be able to have logging on by default or for logging the startup behaviour of an application. See <a href="#force_log">The FORCE_LOG environment variable</a> for a few hints on how this feature can be used.</p>
</li>
<li>
<p>Trace log output will be sent to the Safir Log.</p>
</li>
<li>
<p>Log output is also sent to the applications standard output (its console).</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_expression_expansion">9.2.1.1. Expression expansion</h5>
<div class="paragraph">
<p>The checking of whether a prefix is enabled happens in slightly different ways in the different languages, which means that depending on how you use the logger you may pay for string expansion or you may not.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In C++ the check is made once for every "&lt;&lt;", but since the check is inlined it can be considered cheap. Floats and suchlike are not expanded into strings until after the check has "been successful", so it is ok to log most stuff using lines like</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">debug</span> <span class="o">&lt;&lt;</span> <span class="s">"Testing logging "</span> <span class="o">&lt;&lt;</span> <span class="n">myFloat</span> <span class="o">&lt;&lt;</span> <span class="s">", "</span> <span class="o">&lt;&lt;</span> <span class="n">myInt</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>In C# the check is made for every <code>Write</code> or <code>WriteLine</code> call, which means that if you log using the form</p>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="n">debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Hello "</span> <span class="p">+</span> <span class="m">123.098</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>the whole string expansion will be performed before the check is made. It is better to use the form</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="n">debug</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Hello {0}"</span><span class="p">,</span> <span class="m">123.098</span><span class="p">);</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>since the string expansion will not be performed until the check has passed.</p>
</div>
</li>
<li>
<p>In Java the check is made for every <code>print</code> or <code>println</code> call that is made. The tracer supports the <code>printf(&#8230;&#8203;)</code> functions that will give the similar functionality as C# described above. Check out the documentation for javas <code>PrintWriter</code> to find out how to use this syntax.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sometimes you might have something that is expensive to calculate in your logs, for example something like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="n">debug</span> <span class="o">&lt;&lt;</span> <span class="s">"Average: "</span> <span class="o">&lt;&lt;</span> <span class="n">ExpensiveAverageCalculation</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>where the expensive function will be called every time the statement executed whether or not the prefix is enabled. In this situation it is better to check whether logging is enabled using <code>debug.IsEnabled()</code> before doing the logging, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">IsEnabled</span><span class="p">())</span>
<span class="p">{</span>
    <span class="n">debug</span> <span class="o">&lt;&lt;</span> <span class="s">"Average: "</span> <span class="o">&lt;&lt;</span> <span class="n">ExpensiveAverageCalculation</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This applies to all languages, even if this example was in C++.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="force_log">9.2.2. The FORCE_LOG environment variable</h4>
<div class="paragraph">
<p>There are a few different ways that the FORCE_LOG environment variable can be used.</p>
</div>
<div class="paragraph">
<p>The first is, naturally, to set the environment variable in the System Properties &#8594; Environment Variables dialog (in Windows), or in your .bashrc file (for Unix bash shell users). This has the sometimes unfortunate side effect of turning on the selected prefixes for all applications, which can be a problem if several applications use the same prefix, or if you set FORCE_LOG to "all" which will mean that all applications will log everything.</p>
</div>
<div class="paragraph">
<p>The second way is to start your program from the command line: First run <code>set FORCE_LOG="something somethingelse"</code> (Windows again, unix bash shell users do <code>export FORCE_LOG=&#8230;&#8203;</code>), and then run your application from the command line. Now only your application will be run with those settings. This same way can of course be used in a script.</p>
</div>
<div class="paragraph">
<p>Lastly, if you want to run your program from the Visual Studio debugger with trace logging on by default, there is support for that too. Under Project Settings &#8594; Debugging &#8594; Environment it is possible to set environment variables. So set FORCE_LOG="all" there to get your program to start with all logging enabled. Also make sure that "Merge Environment" is set to Yes, or your program (and the libraries it depends on) will not be able to read other environment variables.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_tracer_without_a_dob_connection">9.2.3. Using the Tracer without a Dob connection</h4>
<div class="paragraph">
<p>The Tracer class itself does not use the Dob in any way, it is only the TracerBackdoor that uses the Dob, which means that it is possible to use the Tracer functionality in an application that does not have a Dob connection, or to use it when the connection is not open. Of course, since this means that the TracerBackdoor cannot be used, it is not possible to use the backdoor command to control the logging. But it is still possible to use the FORCE_LOG functionality to enable logging.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tracer_faq">9.2.4. Tracer FAQ</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">How does flushing work?</dt>
<dd>
<p>The Tracer logs to both standard output and to Safir Logging. Flushing is handled differently in these two mechanisms, which means that they will behave slightly differently. Standard output is flushed as it is normally done in each language, e.g. on <code>std::flush</code> and <code>std::endl</code> in C++, and Safir Logging is flushed on each newline.</p>
</dd>
<dt class="hdlist1">How does the Tracer use Windows Native Logging?</dt>
<dd>
<p>When Native logging is enabled on Windows systems (see <a href="#windows_native_logging">Windows Event Log</a>) the Tracer will <em>only</em> log to standard output, and not to Safir Logging. This is by design, since the Windows Event Log is not suited for tracer-style logs.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_changes_from_previous_tracer_versions">9.2.5. Changes from previous Tracer versions</h4>
<div class="paragraph">
<p>The way that the Tracer works changed quite a lot with the introduction of the Safir Logging mechanism in Safir SDK Core version 4.5. The interface has only minor changes, but the behaviour behind the scenes has changed significantly.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Starting the TracerBackdoor</dt>
<dd>
<p>Previously the TracerBackdoor was started automatically with a separate thread and connection, but now the TracerBackdoor has to be started explicitly, and on an existing connection. This means that you have to add Start and Stop calls in your applications.</p>
</dd>
<dt class="hdlist1">Setting Program Name</dt>
<dd>
<p>Previously it has been necessary to tell the Tracer what the name of the program is for it to be able to use a sensible connection name. Since the Tracer no longer has a connection of its own this is no longer necessary. Hence the <code>SetProgramName(&#8230;&#8203;)</code> function has been removed. If your applications used this function you have to remove those calls. This also means that you now cannot address your application using "bd -c &lt;executable name&gt;", but instead have to use the connection name that the TracerBackdoor was started with.</p>
</dd>
<dt class="hdlist1">Buffering and flushing</dt>
<dd>
<p>Previously logged data was flushed to the old logging mechanism after 0.5 seconds. The new flushing behaviour is described above. You don&#8217;t have to change your application in any way, just expect the new behaviour when using the Tracer.</p>
</dd>
<dt class="hdlist1">Prefixes and when to start logging</dt>
<dd>
<p>Previously there were some rules on how and when to instantiate and use Tracers and prefixes. This is now much more straightforward: Instantiate the Tracers when and where you want to, and use them when and where you want to.</p>
</dd>
<dt class="hdlist1">Extra threads and connections</dt>
<dd>
<p>Old versions of the Tracer would start a background thread and open a connection in that thread. This led to some sometimes unwanted side-effects. The Tracer no longer has this background thread (instead you have to start the TracerBackdoor on one of your connections). No changes are needed to your applications.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence_service">10. The persistence service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The persistence service is provided by the executable <code>dope_main</code>, which performs the storing of the entities to files on disk or to a database (configuration is described in <a href="#persistence_config">Persistence config</a>).</p>
</div>
<div class="sect2">
<h3 id="_converting_persisted_entities_to_and_from_xml">10.1. Converting persisted entities to and from XML</h3>
<div class="paragraph">
<p>Regardless of whether the database or file backend is used the entities are stored in
binary format (blobs). There is a tool <code>dope_bin2xml</code> (run with --help to get some brief
help) that converts the binary blobs into xml, which is easier to read or manipulate. The
xml is placed in the xmldata column of the database, or in a file with .xml as extension
(the binaries are removed when this is done, so that there will be only one source of
persistence data when starting the persistence service next time).</p>
</div>
<div class="paragraph">
<p>When the persistence service starts, it first looks for xml data, and only when that is
not found does it look for binary data.</p>
</div>
<div class="paragraph">
<p>This means that it is possible to run dope_bin2xml, edit the xml data, and then start the
system to get the edited data presented as persistent data.</p>
</div>
<div class="sect3">
<h4 id="_preserving_persisted_data_when_objects_change">10.1.1. Preserving persisted data when objects change</h4>
<div class="paragraph">
<p>The blob to/from xml mechanism also allows for a solution to a common problem:</p>
</div>
<div class="paragraph">
<p>When a dou file is changed in certain ways (a member is added or removed, or members are
reordered) any old stored binary persistent data becomes unusable. But loading stored
data in xml format is much more "compatible" with respect to dou-file changes, so if you
run dope_bin2xml, then change the dou-files and rerun dobmake, and then start the system
you are much more likely to have usable data in the persistent entities.</p>
</div>
<div class="paragraph">
<p>This works with adding members, or changing array lengths, but not with removing or
renaming members (unless they are <em>null</em> in the persisted data, in which case they are
not present in the xml). Of course if your persistent data is valuable, you can always
edit the xml "by hand" to keep it. Just remember to do dope_bin2xml <em>before</em> you change
your Dob object definitions.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_redundancy">10.2. Redundancy</h3>
<div class="paragraph">
<p>The persistence service has support for redundancy.</p>
</div>
<div class="paragraph">
<p>To enable redundant persistent storage you need to configure your system in the following
way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure the persistence storage to point out a shared network storage like a shared
disk/NAS or a database/database cluster.</p>
</li>
<li>
<p>Start dope_main in 2 or more nodes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The dope_main that starts first become the active one, and the other ones starts in a
standby mode. If the node running the active dope_main goes down, one of the standby
instances is activated and the persistence service will continue to run.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_database_persistence">10.3. Configuring database persistence</h3>
<div class="paragraph">
<p>A complete guide to configuring databases is far outside the scope of this document, but some hints are in place.</p>
</div>
<div class="paragraph">
<p>Safir SDK Core currently has tested support for <em>PostgreSQL</em>, <em>MySQL/MariaDB</em>, <em>Microsoft SQL
Server</em> and <em>Mimer SQL</em>. Since dope_main uses ODBC for database communication it is
likely that it can be used with other databases as well.</p>
</div>
<div class="paragraph">
<p>As part of the installation Safir SDK Core provides examples of database installation
scripts. These can be found in the in <code>/usr/share/safir-sdk-core/db</code> on Linux and in
<code>C:\Program Files\Safir SDK Core\db</code> on Windows. Also provided is a README.txt file for
each database, that gives some information about how to run the script. These scripts are
far from complete or fool-proof, so you are expected to read them and adapt them to your
needs.</p>
</div>
<div class="paragraph">
<p>Some common features of the scripts are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Database name</dt>
<dd>
<p>The database that the script creates will be called <code>dope_db</code>.</p>
</dd>
<dt class="hdlist1">User name</dt>
<dd>
<p>The user name that will be granted access to the persistence database will be <code>dopeuser</code>.</p>
</dd>
<dt class="hdlist1">Password</dt>
<dd>
<p>The password of the user will be <code>dopeuser</code></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In the case of Microsoft SQL Server no password will be set, as it is assumed that a
login for <code>dopeuser</code> has already been created in the database.</p>
</div>
<div class="paragraph">
<p>You will probably want to modify at least the password.</p>
</div>
<div class="sect3">
<h4 id="_connection_strings">10.3.1. Connection strings</h4>
<div class="paragraph">
<p>dope_main connects to the database you have configured with a connection string. These
differ slightly between different databases, and also we require that you set certain
options in them to get correct handling of Unicode code points in the xml data.</p>
</div>
<div class="paragraph">
<p>Some databases also appear to be sensitive to casing in the connection string, and others
are not.</p>
</div>
<div class="paragraph">
<p>Here are some examples of connection strings for the different databases, taken from our
test suite in its Windows configuration. Also listed are any required connection string
options, without which something bad will happen (usually what will happen is that
Unicode strings and dope_bin2xml will fail on Windows).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">PostgreSQL</dt>
<dd>
<p><code>DRIVER=\{PostgreSQL UNICODE(x64)\};Server=localhost;ByteaAsLongVarBinary=1;LFConversion=0;Database=dope_db;Uid=dopeuser;Pwd=dopeuser</code>
+
Required options: <strong>ByteaAsLongVarBinary=1;LFConversion=0</strong></p>
</dd>
<dt class="hdlist1">MySQL/MariaDB</dt>
<dd>
<p><code>DRIVER=\{MariaDB ODBC 2.0 Driver\};Server=localhost;charset=utf8;Database=dope_db;Uid=dopeuser;Pwd=dopeuser</code>
+
Required options: <strong>charset=utf8</strong></p>
</dd>
<dt class="hdlist1">Microsoft SQL Server</dt>
<dd>
<p><code>Driver=\{SQL Server\};Server=localhost\SQLEXPRESS;Database=dope_db;Uid=dopeuser;Pwd=dopeuser</code>
+
Required options: None</p>
</dd>
<dt class="hdlist1">Mimer</dt>
<dd>
<p><code>Driver={MIMER};Protocol=tcp;Node=localhost;Database=dope_db;Uid=dopeuser;Pwd=dopeuser</code>
+
Required options: None</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note that the Microsoft SQL Server connection string above implies that we&#8217;re using mixed
mode authentication, which is something you might not want to do. Change accordingly.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_utilities">11. Utilities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core contains a few utilities to simplify some things.</p>
</div>
<div class="sect2">
<h3 id="_sending_many_requests">11.1. Sending many requests</h3>
<div class="paragraph">
<p>Although the Dob allows you to have several outstanding requests at a time (see also <a href="#queue_lengths">Queue lengths config</a>) it is sometimes desirable to be able to send off a bunch of requests and just get a summary of how it all went. Safir SDK Core provides a service for exactly this, Safir.Utilities.ForEach.</p>
</div>
<div class="paragraph">
<p>Foreach provides three Services:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Safir.Utilities.DeleteAllRequest</dt>
<dd>
<p>The purpose of this service is to delete all instances of a given entity. This comes handy if you want to delete entities without knowing their instanceId, e.g. for cleaning up.</p>
</dd>
<dt class="hdlist1">Safir.Utilities.DeleteRequest</dt>
<dd>
<p>The purpose of this service is to delete a specified set of entities (fill an array with EntityIds).</p>
</dd>
<dt class="hdlist1">Safir.Utilities.UpdateRequest</dt>
<dd>
<p>The purpose of this service is to update a bunch of entities accordingly to a template object. E.g. if you want to set a flag on a large number of entities you provide a template request and a list of EntityIds that you want the request applied to.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>For each service you can choose which type of answer you want. <em>Immediate</em>, <em>Brief</em> or <em>Full</em>. <em>Immediate</em> means that you don&#8217;t care if the operations are successful or not and you get this response immediately before all outstanding requests are finished. Brief waits for all operations to be finished before sending a response back. This information includes a summary of successful, non-successful and total operations. Full response is like Brief but you also get every single response from each operation in an array in the response.</p>
</div>
<div class="paragraph">
<p>The foreach service is provided by the "foreach" executable, which needs to be running for the foreach requests to be serviced.</p>
</div>
</div>
<div class="sect2">
<h3 id="dispatcher_classes">11.2. Asio and Ace Dispatchers</h3>
<div class="paragraph">
<p>For applications written in C++ and using Boost.Asio or ACE the classes <code>Safir.Utilities.AsioDispatcher</code> and <code>Safir.Utilities.AceDispatcher</code> provide <code>Dispatcher</code> classes that performs the thread switch and call to <code>Dispatch</code> as described in <a href="#dispatching">Dispatching</a>.</p>
</div>
<div class="paragraph">
<p>Just instantiate the <code>AsioDispatcher</code> or <code>AceDispatcher</code> passing it your io_service or ACE_Reactor, and pass a pointer to the instance to your connection when calling <code>Open</code>, and you&#8217;re done. The dispatcher will now perform the thread switch through the io_service/reactor main loop using <code>post</code>/<code>notify</code>.</p>
</div>
<div class="paragraph">
<p>The ACE dispatcher is deprecated as of Safir SDK Core 6.0 and will be removed in a future
release. Since it is a header-only class you can make a copy of it to your own project if
you need to keep it around after it has been removed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_time">11.3. Time</h3>
<div class="paragraph">
<p>Under the namespace <code>Safir.Time</code> there are a few classes that provide functionality for obtaining the current time (both local and UTC) and converting it to and from various formats.</p>
</div>
<div class="paragraph">
<p>The time library also has support for loading an external library at runtime which could provide a higher accuracy time. The full Safir SDK provides such a library, which provides a much higher accuracy multi-node synchronised clock than NTP can provide on both GNU/Linux or Windows based systems. For more information on this, contact Saab AB (contact information at <a href="http://www.saabgroup.com" class="bare">http://www.saabgroup.com</a>).</p>
</div>
</div>
<div class="sect2">
<h3 id="crash_reporting">11.4. Crash Reporting</h3>
<div class="paragraph">
<p>Safir SDK Core includes a crash reporting library, google-breakpad (<a href="http://code.google.com/p/google-breakpad/" class="bare">http://code.google.com/p/google-breakpad/</a>). The crash reporting library can be used to generate dumps when applications crash (e.g. access violation or segmentation fault). The dumps contain, among other things, general system information, the call stack for each thread and the list of loaded modules. A dump file, together with symbolic debugging information, can be used to identify where in the software the crash occurred.</p>
</div>
<div class="sect3">
<h4 id="_enabling_the_crash_reporter">11.4.1. Enabling the Crash Reporter</h4>
<div class="paragraph">
<p>To use the crash reporter you need to initiate it in your application. The initiation should occur as early in your program as possible.</p>
</div>
<div class="paragraph">
<p>For example, in C++ you would do something like this:</p>
</div>
<div class="listingblock">
<div class="title">Initializing crash reporting in C++ using RAII object</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">Safir</span><span class="o">::</span><span class="n">Application</span><span class="o">::</span><span class="n">ScopedCrashReporter</span> <span class="n">crashReporter</span><span class="p">;</span>
    <span class="p">...</span> <span class="n">run</span> <span class="n">your</span> <span class="n">application</span> <span class="p">...</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CrashReporterStarter</code> class is an RAII class, which means that it is equivalent to doing the following:</p>
</div>
<div class="listingblock">
<div class="title">Initializing and stopping crash reporter in C++ manually</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">Safir</span><span class="o">::</span><span class="n">Application</span><span class="o">::</span><span class="n">CrashReporter</span><span class="o">::</span><span class="n">Start</span><span class="p">();</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="n">run</span> <span class="n">your</span> <span class="n">application</span> <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">all</span> <span class="n">exceptions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="n">handle</span> <span class="n">your</span> <span class="n">exceptions</span> <span class="p">...</span>
    <span class="p">}</span>
    <span class="n">Safir</span><span class="o">::</span><span class="n">Application</span><span class="o">::</span><span class="n">CrashReporter</span><span class="o">::</span><span class="n">Stop</span><span class="p">()</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Initializing and stopping crash reporting in C#</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="csharp"><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Safir</span><span class="p">.</span><span class="n">Application</span><span class="p">.</span><span class="n">CrashReporter</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="n">run</span> <span class="n">your</span> <span class="n">application</span> <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">...</span> <span class="n">handle</span> <span class="n">your</span> <span class="n">exceptions</span> <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="n">Safir</span><span class="p">.</span><span class="n">Application</span><span class="p">.</span><span class="n">CrashReporter</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Java has its own crash handler, so the Crash Reporter should not be used there, and there is no interface to start it.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
In previous versions (older than 4.5) of Safir SDK Core the Crash Reporter was started with a call to <code>Safir::SwReports::SwReport::EnableCrashReporting()</code> and stopped with a call to <code>Safir::SwReports::SwReport::Stop()</code>. This was changed due to the introduction of Safir Logging and the changes in the Tracer.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_requirements_for_using_crash_dumps">11.4.2. Requirements for using crash dumps</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">Build release builds with debug info enabled</dt>
<dd>
<p>You need to make sure that you build your application with debug information enabled, even when building release builds. If you are using CMake you can use the RelWithDebInfo configuration, which produces release binaries but with debug information.</p>
</dd>
<dt class="hdlist1">Archive the debug information</dt>
<dd>
<p>When using Visual Studio you need to archive the generated .pdb file for every .dll or .exe you build. For GCC builds you can use the <code>strip</code> tool to separate the debug information from the binaries. The debug information shall generally not be shipped with a released product, but must be kept for it to be possible to analyze crash dumps.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_analyzing_a_crash_dump">11.4.3. Analyzing a crash dump</h4>
<div class="paragraph">
<p>When an application crashes in a way that is caught by the crash reporter a dump file will be placed in the crash dump directory (see <a href="#locations_ini">locations.ini</a>) with a rather cryptic name (a lot of digits followed by .dmp). Apart from generating this dump file the crash reporter will attempt to log an error to the Safir Log and to standard output that a crash has happened.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re using Visual Studio you can just open the .dmp file and if you&#8217;ve got all the debug information and binaries available you will then see the call stack and be able to inspect the state of the application.
On Linux, you can use gdb to analyze the .dmp files, although you will have to convert the dumps to a core file using the minidump-2-core tool that you can find online (for example <a href="https://firefox-source-docs.mozilla.org/contributing/debugging/debugging_a_minidump.html#using-minidump-2-core-on-linux">here</a> as of this writing).
For more information about how to use the dump files please see the Google Breakpad website at <a href="http://code.google.com/p/google-breakpad/" class="bare">http://code.google.com/p/google-breakpad/</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_design_considerations">12. Application Design Considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section discusses some things that you need to be aware of when designing systems and applications.</p>
</div>
<div class="sect2">
<h3 id="overflow_handling">12.1. Overflow handling</h3>
<div class="paragraph">
<p>The correct way of managing overflow is to use the designated functions telling the caller when it is ok to perform the action again.</p>
</div>
<div class="paragraph">
<p>For example, if you get an overflow when sending a message (and that message should then be retried according to your application requirements/design) you can do something like this:</p>
</div>
<div class="listingblock">
<div class="title">Handling OverflowException</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="k">try</span>
<span class="p">{</span>
    <span class="n">m_connection</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">myMessage</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">OverflowException</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">m_unsentMessage</span> <span class="o">=</span> <span class="n">myMessage</span><span class="p">;</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then handle resending like this:</p>
</div>
<div class="listingblock">
<div class="title">Resending messages in OnNotMessageOverflow</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="c++"><span class="kt">void</span> <span class="n">MyMessageSender</span><span class="o">::</span><span class="n">OnNotMessageOverflow</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">m_connection</span><span class="p">.</span><span class="n">Send</span><span class="p">(</span><span class="n">m_unsentMessage</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
        <span class="n">m_unsentMessage</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span> <span class="c1">//set the message to NULL</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Safir</span><span class="o">::</span><span class="n">Dob</span><span class="o">::</span><span class="n">OverflowException</span> <span class="o">&amp;</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//don't do anything. We will be called again later</span>
        <span class="c1">//to resume sending the messages that have not yet been sent.</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It might be tempting to use a list to keep the unsent messages in, but beware! The Dob design tries very hard to restrict queue sizes to be able to handle graceful degradation, don&#8217;t ruin it by introducing infinite queues in your application! There might be cases when a queue of a <em>limited size</em> may be applicable.</p>
</div>
<div class="paragraph">
<p>Note that the retry policy of your application <em>must</em> be part of the requirements and design of the system and your application.</p>
</div>
<div class="paragraph">
<p>Another way to handle overflows, which applies if the message or request is sent as a result of a Dob subscription or request, is to use Postpone (see <a href="#postpone">Postponing callbacks</a>). And in the case of operator requests you probably want a tellback to ask the operator to press the button again a little bit later.</p>
</div>
<div class="paragraph">
<p>There is a little bit more info on this in <a href="#faq">FAQ</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="request_timeouts">12.2. Request timeouts</h3>
<div class="paragraph">
<p>As has been mentioned in <a href="#request_timeout_config">Request timeouts config</a> and <a href="#service_overview">Services</a> a request can result in a timeout response if the handler does not manage to handle the request in a timely fashion. It is very important to note that a timeout means that a request <em>may still be processed</em>!</p>
</div>
<div class="paragraph">
<p>The reason for this is that the handler may have started to process the request, but while it is being processed the timeout expires, so a timeout response is sent to the request sender. The response that the handler sends is discarded.</p>
</div>
<div class="paragraph">
<p>This means that a sender may retry sending the request, so handlers should be prepared to receive duplicate requests.</p>
</div>
<div class="paragraph">
<p>Note that this behaviour applies to both service requests and entity requests.</p>
</div>
</div>
<div class="sect2">
<h3 id="_type_system_freedoms">12.3. Type system freedoms</h3>
<div class="paragraph">
<p>Since Messages, Entities, Items, and Services all inherits from Object, and it is possible to have members of the type Object, it is also possible to have Services as members in Items. And Entities as Service members etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_exceptions">12.4. Handling exceptions</h3>
<div class="paragraph">
<p>There are two base classes for exceptions. <code>Safir.Dob.Typesystem.FundamentalException</code> and <code>Safir.Dob.Typesystem.Exception</code>.
Exceptions should be handled by the caller, but in most situations, FundamentalExceptions should not.</p>
</div>
<div class="paragraph">
<p>In most cases a FundamentalException is to be treated as an indication that there is a programming error in your application. You should never add code that tries to handle your own programming errors. It is better if the application just dies, instead of limping along, better to detect the crash, fix and restart the application.</p>
</div>
<div class="paragraph">
<p>In some rare cases catching a FundamentalException could be justified. However, a FundamentalException of type <code>Safir.Dob.Typesystem.SoftwareViolationException</code> should never be handled by an application. Let it propagate up to your main loop where you report the error and exit the program.</p>
</div>
<div class="sect3">
<h4 id="_exceptions_in_callbacks">12.4.1. Exceptions in callbacks</h4>
<div class="paragraph">
<p>Letting an exception propagate out of a callback may cause your connection to the Dob to be corrupted in strange ways. You may loose messages, requests and entity subscription responses if you try to continue execution after this has occurred.</p>
</div>
<div class="paragraph">
<p>So catch all "expected" exceptions in the callbacks.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_handling_onrevokedregistration">12.5. Handling OnRevokedRegistration</h3>
<div class="paragraph">
<p>For most applications a call to <code>OnRevokedRegistration</code> is completely unexpected. Unless your system uses overregistration as a feature getting this callback is a sign of an error, and the following is a recommendation on what to do in this case:</p>
</div>
<div class="paragraph">
<p>Send a Safir Log (severity Critical) that you have lost the registration. Make the report state clearly that a registration was lost, along with the type and the handler id. Then terminate the application.</p>
</div>
<div class="paragraph">
<p>The Rationale for this is that this probably happened due to a configuration error, or because someone is playing around with Sate (see <a href="#sate">Sate</a>), so you want to tell whoever may be interested that the system is probably not working correctly now.</p>
</div>
<div class="paragraph">
<p>The application should terminate, since it is no longer functioning correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_set_or_delete_an_entity_before_oninitialinjectionsdone_is_received">12.6. Set or Delete an entity before OnInitialInjectionsDone is received</h3>
<div class="paragraph">
<p>The basic rule is that an application that handles persistent entity types should wait for the callback OnIntialInjectonsDone before trying to set or delete any entity. (This callback signals that all ghosts have been injected). To get this to work the application has to distribute the "ok-to-set-entity" status to its different parts which, for some application designs, could be a hassle. An alternative in this case is to actually catch the GhostExistsException. (This is the exception you get when trying to set or delete an entity instance for which there is a ghost that hasn&#8217;t been delivered yet).</p>
</div>
</div>
<div class="sect2">
<h3 id="multithreading">12.7. Multithreading</h3>
<div class="paragraph">
<p>A connection can only be used from within one thread at a time. The queues and other
states associated with a connection are not thread safe, for simplicity and
efficiency.</p>
</div>
</div>
<div class="sect2">
<h3 id="hot_standby">12.8. Hot-standby / Redundancy</h3>
<div class="paragraph">
<p>Using a combination of persistence and pending registrations (see <a href="#persistence">Entity Persistence</a> and <a href="#pending_registrations">Pending Registrations</a>, respectively) will let you support hot-standby and redundancy.</p>
</div>
<div class="paragraph">
<p>For an application to support redundancy the idea is that it is started in (at least) two instances, most likely on different computers in the system. At startup one is chosen as <em>active</em>, and the other(s) become <em>passive</em>. If the active instance fails (e.g. the application or the computer crashes, or the computer is shut down for maintenance) the Dob will detect that that computer has gone down, or that the application has crashed, and will tell one of the passive instances to become active.</p>
</div>
<div class="paragraph">
<p>To accomplish this, all the entities that the active instance maintained must be marked as persistent (at least volatile persistence), and one of the handlers, the "main" handler, must be registered using <code>RegisterEntityHandlerPending</code>.</p>
</div>
<div class="paragraph">
<p>When the <code>OnCompletedRegistration</code> callback is invoked for the main handler, the rest of the handlers should be registered in the normal way (using overregistration) guaranteeing that one instance of the application has registered all handlers it is supposed to.</p>
</div>
<div class="paragraph">
<p>The first time the application instances start, one of the instances will be given the registration of the main handler (through a call to <code>OnCompletedRegistration</code>, which will lead it to register the other handlers as well. It will then receive any persisted entities through the <code>OnInjectedNewEntity</code>. When this instance terminates (due to a crash or something else) the Dob will detect that and call <code>OnCompletedRegistration</code> on the other application instance, that will register the other handlers and receive the persisted entities. This will seamlessly cause the entity instances to move from one owner to another.</p>
</div>
<div class="paragraph">
<p><a href="#redundancy_sequence_diagram">Sequence diagram for redundant entity handlers</a> describes this as a sequence diagram, albeit without showing the part about registering the other handlers, since that would clutter up the diagram needlessly.</p>
</div>
<div id="redundancy_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/redundancy_sequence_diagram.png"><img src="images/redundancy_sequence_diagram.png" alt="Redundancy Sequence Diagram"></a>
</div>
<div class="title">Figure 11. Sequence diagram for redundant entity handlers</div>
</div>
<div class="paragraph">
<p>Note that applications subscribing to the entities that are redundancy-handled <em>may</em> see the entity instances as deleted for a short while, since in reality the handler was unregistered for a short while.</p>
</div>
</div>
<div class="sect2">
<h3 id="_entity_reference_gotchas">12.9. Entity reference gotchas</h3>
<div class="paragraph">
<p>When using entities that are linked to each other through EntityId members there are a few things that you need to remember/handle in both the application that produces the entities and the applications that use them.</p>
</div>
<div class="paragraph">
<p>Applications that own the entities must make sure that no <em>orphans</em> are left behind, and that incorrect dangling references are avoided. An example of orphaned entites is shown in <a href="#orphan_example">Entities that may cause orphans.</a>, where an entity uses another entity, a Location, to represent its position. If the entity is updated with a new location you must determine whether the old location is to be kept or not, to avoid cluttering the system with orphaned locations.</p>
</div>
<div id="orphan_example" class="imageblock">
<div class="content">
<a class="image" href="images/orphan_object.png"><img src="images/orphan_object.png" alt="Entities that may cause orphans"></a>
</div>
<div class="title">Figure 12. Entities that may cause orphans.</div>
</div>
<div class="paragraph">
<p>For applications that use the entities that contain associations you need to be aware that the Dob does not guarantee the order in which entities are delivered to subscribers, and that while you&#8217;re handling a subscription an associated entity may be removed, before you&#8217;ve managed to Read it.</p>
</div>
<div class="paragraph">
<p>There is no surefire way to handle all these cases, it must be decided on a case by case basis, but a first recommendation is to only subscribe to the "main" entities, and do Reads or temporary subscriptions to get the referred entities.</p>
</div>
<div class="paragraph">
<p>This also applies to applications that handle asynchronous injections, as described in <a href="#systems_of_systems">Systems of Systems <sup>adv</sup></a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="systems_of_systems">13. Systems of Systems <sup>adv</sup></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter contains information about how to write applications that support <em>Systems of Systems</em>, i.e. a number of Dob-systems communicating over some other media, using <em>asynchronous injections</em>.</p>
</div>
<div class="paragraph">
<p>The Dob itself relies on high reliability and high bandwidth LAN connections for its communication between nodes. Asynchronous injections makes it possible to create an application that links together multiple systems like this using a medium with low connectivity and low bandwidth (e.g. a legacy radio), or a medium with high bandwidth but non-optimal connectivity (e.g. the internet).</p>
</div>
<div class="paragraph">
<p>A complete description of how to build a system with asynchronous injections, or how to create an <em>injector</em>, i.e. an application that performs the injections, is outside the scope if this document, which will concentrate on how to write applications that can handle injections. If you&#8217;re interested in more information on this than this document provides, please get in touch with us.</p>
</div>
<div class="paragraph">
<p>But, we need a little bit of background to be able to understand the rest of this chapter:</p>
</div>
<div class="paragraph">
<p>To save on bandwidth injections are sent as <em>deltas</em> over the network. Since some data may reach one system long before it reaches the others (might have been out of radio contact) all data is timestamped, and upon injection the data is merged using these timestamps, to ensure that all the "latest" data is what is used in all systems.</p>
</div>
<div class="paragraph">
<p>In a system of systems with low connectivity it is also possible that the same entity is being updated while the network is down, and the timestamps are also used to work out which data is the latest.</p>
</div>
<div class="sect2">
<h3 id="_injectable_entities">13.1. Injectable entities</h3>
<div class="paragraph">
<p>An entity is configured to be <em>Injectable</em> using the same configuration mechanism as persistence, as described in <a href="#persistence">Entity Persistence</a>, but using the <code>Injectable</code> persistence type. Entities marked as <code>Injectable</code> will have the behaviour of <code>SynchronousPermanent</code> (and thus also of <code>SynchronousVolatile</code>) entities, with the added functionality that injections can occur throughout the lifetime of an entity, not just at registration-time.</p>
</div>
</div>
<div class="sect2">
<h3 id="asynchronous_injections">13.2. Asynchronous Injections</h3>
<div class="paragraph">
<p>Asynchronous Injections are the kind of injection that can occur throughout the lifetime of an entity. The other use of injections is Persistence, as described in <a href="#persistence">Entity Persistence</a>, can only occur at <em>registration time</em>.</p>
</div>
<div class="paragraph">
<p>The first thing to mention is that if a type is marked as <em>Injectable</em> its instances will be persisted, just as if it was marked as <code>SynchronousPermanent</code>. Note, however, that it is not the persistence service, dope_main, that performs the persistence in this case, but the <em>injector</em>, but this should be completely transparent for the user.</p>
</div>
<div class="sect3">
<h4 id="_using_asynchronous_injections">13.2.1. Using asynchronous injections</h4>
<div class="paragraph">
<p>For an entity to support asynchronous injections, it must have the Safir.Dob.InjectionProperty mapped with a value of "Injectable", and the application must register it using <code>RegisterEntityHandlerInjection</code> and an entity handler that implements the <code>EntityHandlerInjection</code> consumer interface.</p>
</div>
<div class="paragraph">
<p>The <code>EntityHandlerInjection</code> consumer interface has, as described in <a href="#advanced_persistence">Understanding persistence <sup>adv</sup></a>, four callbacks more than the EntityHandler consumer interface: <code>OnInjectedNewEntity</code>, <code>OnInjectedUpdatedEntity</code>, <code>OnInjectedDeletedEntity</code> and <code>OnInitialInjectionsDone</code>. These are the circumstances that the callbacks are invoked (the sequence is shown in <a href="#injection_sequence_diagram">Injection sequence diagram</a>):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>OnInjectedNewEntity</code></dt>
<dd>
<div class="ulist">
<ul>
<li>
<p>Immediately after registration for each persisted entity instance, just as for types marked for persistence.</p>
</li>
<li>
<p>Any time during the lifetime of an application if a <em>new instance is injected</em> by the injector.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>OnInjectedUpdatedEntity</code></dt>
<dd>
<p>When the injector injects some changes into an existing entity instance.</p>
</dd>
<dt class="hdlist1"><code>OnInjectedDeletedEntity</code></dt>
<dd>
<p>When the injector injects a delete. I.e. the instance is deleted on another system.</p>
</dd>
<dt class="hdlist1"><code>OnInitialInjectionsDone</code></dt>
<dd>
<p>After all persisted entity instances have been resurrected or rejected by an <code>OnInjectedNewEntity</code> callback.</p>
</dd>
</dl>
</div>
<div id="injection_sequence_diagram" class="imageblock">
<div class="content">
<a class="image" href="images/injection_sequence_diagram.png"><img src="images/injection_sequence_diagram.png" alt="Injection Sequence Diagram"></a>
</div>
<div class="title">Figure 13. Injection sequence diagram</div>
</div>
<div class="paragraph">
<p>Note that it is not possible to tell the difference between the two kinds of calls to <code>OnInjectedNewEntity</code>, and in fact both new and old (i.e. persisted and injected) data can be mixed (i.e. timestamp merged) in a call to <code>OnInjectedNewEntity</code>.</p>
</div>
<div class="paragraph">
<p>When an application receives one of the injection callbacks it can either accept the injection, by just returning, or it can say that the injection is not complete (i.e. all deltas that are needed to make an entity that makes sense have not arrived yet) by calling <code>IncompleteInjectionState</code> (see <a href="#incomplete_injection_state">IncompleteInjectionState</a>) or it can explicitly delete the entity. What is important to note is that if the entity is deleted is that that will cause the delete to be sent to other systems (by the injector), so delete may not be a good idea.</p>
</div>
<div class="paragraph">
<p>For injections to work correctly it is important that applications use <code>SetChanges</code> instead of <code>SetAll</code> when modifying entities. This is because <code>SetChanges</code> will use the change flags to work out which members should have the new and updated timestamp. In fact <em>always</em> prefer <code>SetChanges</code> to <code>SetAll</code>, it makes more sense w.r.t. change flags even in entities that are not injectable, and it will probably make it easier to add the possibility of handling injections at a later time to your application.</p>
</div>
</div>
<div class="sect3">
<h4 id="timestamp_merge">13.2.2. Timestamp merges</h4>
<div class="paragraph">
<p>Each top-level member (note that it is <em>only</em> the top-level members, not members in items or individual array items) have a timestamp that is used to determine which bits of information is "newest".</p>
</div>
<div class="paragraph">
<p><strong>Note:</strong> This fact gives constraints on the design of objects that are to be used with asynchronous injections. They will probably have to be quite "shallow".</p>
</div>
<div class="paragraph">
<p>The timestamps are based on a normal concept of time, but have an additional feature to make them better adjusted to use when the clocks on different systems (in a system of systems) "drift": When updating an entity instance the time used for timestamps is the maximum of "my own time" and "the highest time I&#8217;ve seen from other systems, plus one". This solves problems in systems with wildly diverging system times. (The timestamps can be thought of as Lamport timestamps, but with the always moving along with the UTC time, not only when there is an event.)</p>
</div>
<div class="paragraph">
<p>An example of how timestamp merges work is probably the best way to explain the algorithm:</p>
</div>
<div class="paragraph">
<p>In <a href="#ts_merge_1">Timestamp merge, initial entity</a> an application owns an entity (and has done a single <code>SetChanges</code> at time 100). The entity has been reflected to other systems by the Injector.</p>
</div>
<table id="ts_merge_1" class="tableblock frame-ends grid-all" style="width: 40%;">
<caption class="title">Table 17. Timestamp merge, initial entity</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 35%;">
<col style="width: 35%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Foo</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>On another system (at time 110) the application does a <code>SetChanges</code> with Member 0 set to "hello" and Member 1 set to "33". This will cause the injector on "our" system to make the injection shown in <a href="#ts_merge_2">Timestamp merge, first injection</a>.</p>
</div>
<table id="ts_merge_2" class="tableblock frame-ends grid-all" style="width: 50%;">
<caption class="title">Table 18. Timestamp merge, first injection</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">IsChanged</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>110</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>hello</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>110</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>33</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This will be merged with the current entity (again, on "our" system) into the object in <a href="#ts_merge_3">Timestamp merge, merged object</a>.</p>
</div>
<table id="ts_merge_3" class="tableblock frame-ends grid-all" style="width: 50%;">
<caption class="title">Table 19. Timestamp merge, merged object</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">IsChanged</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>110</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>hello</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>110</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>33</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This merged object will be presented to the application through a call to <code>OnInjectedUpdatedEntity</code> with the change flags set as indicated, and if the application accepts that injection (by just returning) the entity instance shown in <a href="#ts_merge_4">Timestamp merge, resultant entity</a> will be set in the Dob (and shown to subscribers or readers).</p>
</div>
<table id="ts_merge_4" class="tableblock frame-ends grid-all" style="width: 40%;">
<caption class="title">Table 20. Timestamp merge, resultant entity</caption>
<colgroup>
<col style="width: 34%;">
<col style="width: 33%;">
<col style="width: 33%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hello</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>While all this was happening, a third system (at time 105) the application did a SetChanges with Member 0 set to "Lemon" and Member 3 set to "Curry". On our system the injector will then do the injection shown in <a href="#ts_merge_5">Timestamp merge, another injection</a> (but note that this delta arrives to our system after the 110-delta).</p>
</div>
<table id="ts_merge_5" class="tableblock frame-ends grid-all" style="width: 50%;">
<caption class="title">Table 21. Timestamp merge, another injection</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">IsChanged</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>105</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Lemon</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>Null</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>105</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Curry</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Which will be merged with the current entity to become the object shown in <a href="#ts_merge_6">Timestamp merge, second merge result</a></p>
</div>
<table id="ts_merge_6" class="tableblock frame-ends grid-all" style="width: 50%;">
<caption class="title">Table 22. Timestamp merge, second merge result</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Member</th>
<th class="tableblock halign-left valign-top">IsChanged</th>
<th class="tableblock halign-left valign-top">Timestamp</th>
<th class="tableblock halign-left valign-top">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hello</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">110</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">33</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">100</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bar</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>True</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>105</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Curry</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This object will be presented to the application and, if accepted, will be set into the Dob and shown to subscribers and readers.</p>
</div>
<div class="paragraph">
<p>At this stage all systems will have the exact same entity, since the timestamp merge is completely predictable, regardless of the order that the deltas arrive.</p>
</div>
</div>
<div class="sect3">
<h4 id="incomplete_injection_state">13.2.3. IncompleteInjectionState</h4>
<div class="paragraph">
<p>The method <code>IncompleteInjectionState</code> (can be found in the <code>ConnectionAspectPostpone</code> aspect) can be used if an application thinks that an asynchronous injection (in one of the injection callbacks) is missing some information which should be injected "soon". Since entities are updated as deltas it is possible that two deltas arrive in the "wrong order" (due to bad or low connectivity). The application may be able to detect this, and decide that it wants to wait for more entity information. A call to IncompleteInjectionState will cause the injection to be held back until another injection is received for the same instance, when the merged injections will be presented to the application again.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="contexts">14. Contexts <sup>adv</sup></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Dob makes it possible to have several "data universes" side by side. Such a universe is called a context.</p>
</div>
<div class="paragraph">
<p>The main principle is that there is no mixing of data (entities, messages etc) between different contexts.</p>
</div>
<div class="paragraph">
<p>It is possible to override the default no-mixing behaviour by marking a type as <em>ContextShared</em>, thereby making it visible in all contexts. (See below for a motivation and explanation of the ContextShared mechanism.)</p>
</div>
<div class="sect2">
<h3 id="_what_contexts_can_be_used_for">14.1. What contexts can be used for</h3>
<div class="paragraph">
<p>This description presumes that the context functionality is used to support different system modes (changing either the whole system mode, or just one operator console). However, note that from a Safir SDK perspective the context functionality is a general mechanism which can be used for any purpose.</p>
</div>
<div class="paragraph">
<p>The system modes that systems may want to support includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Normal - displaying real world data.</p>
</li>
<li>
<p>Replay - replaying data that was previously recorded in a Normal session.</p>
</li>
<li>
<p>Simulation - displaying data that is generated by simulators. Typically used for training.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here we will focus on Normal and Replay. Simulation should be possible to support with this design, but any recommendations how to implement Simulation using Safir are not included for now.</p>
</div>
<div class="paragraph">
<p>The safety issue is very important when mixing real data sessions and Replay sessions and the intention of the design is that it should be as difficult as possible to do things like "shoot a real gun at a replayed target".</p>
</div>
<div class="paragraph">
<p>Safir applications are usually classified as either Business applications or Presentation
applications (for simplicity we will refer to these as <em>Apps</em> and <em>GUIs</em> in the rest of
this chapter). The first type handles all business logic while the latter takes care of
all presentation of data in a GUI (see <a href="#example_applications">Example applications</a>). This section contains some
recommendations for how APPs and GUIs should use contexts to support Replay sessions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_design_principles">14.2. Design principles</h3>
<div class="paragraph">
<p>A Dob connection is always related to one, and only one, context. The context is given as parameter in the Open call. The contexts are numbered from 0 and upwards where 0 is used to identify the Normal context. Any data (except the ContextShared types, see below), such as entities, services and messages, produced by a connection, can only be seen by connections that is opened in the same context.</p>
</div>
<div class="paragraph">
<p>In a system that supports Replay there must be at least some data that is control data, i.e. some things that need to be displayed from the Normal context while we&#8217;re replaying. Typically this is the entities that control the Replay, software error reports, and a few more things. Fort example, a GUI that is showing a Replay session must be able to pick up changes to the Replay control entities, so that it will know when to switch out of Replay and back to Normal.</p>
</div>
<div class="paragraph">
<p>Forcing applications to have multiple Dob connections, one in context 0 for the control data, and one in the Replay context, and then dynamically working out which kind of data goes where, is considered a potential security risk. Therefore, Safir SDK Core has a concept of ContextShared types which eliminates the need to have parallel connections to different contexts.</p>
</div>
</div>
<div class="sect2">
<h3 id="_contextshared_types">14.3. ContextShared types</h3>
<div class="paragraph">
<p>A type could be marked as being visible in all contexts by mapping the ContextShared property to it. ContextShared types are typically control types, e.g. types used to control the system mode.</p>
</div>
<div class="paragraph">
<p>For example, an APP or GUI that is connected to context 0 can "see" all that goes on in context 0 and the ContextShared types. An APP or GUI that is connected to context 1 can "see" all that goes on in context 1 and the ContextShared types.</p>
</div>
<div class="paragraph">
<p>The following rules applies to ContextShared types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A ContextShared Message can only be sent from context 0.</p>
</li>
<li>
<p>A ContextShared Service can only be registered in context 0.</p>
</li>
<li>
<p>A ContextShared Entity can only be registered and set from context 0.</p>
</li>
<li>
<p>Requests on ContextShared Services and Entities can be done from any context.</p>
</li>
<li>
<p>ContextShared Messages, Entities and Registration can be subscribed to from any context.</p>
</li>
<li>
<p>It is possible to iterate over ContextShared Entities from any context.</p>
</li>
<li>
<p>In all other respects all contexts are equal, i.e. all Dob functionality is available in all contexts.</p>
</li>
<li>
<p>It is not possible to override the ContextShared property. Thus, types derived from a type with the ContextShared property will also be ContextShared.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These rules prevent a Replay application from accidentally (due to misconfiguration) replaying data that is configured to be ContextShared. If ContextShared types could be produced from any context nothing would stop the Replay application from over-registering a ContextShared entity and producing entity updates that may produce an inconsistent system leading to a number of security issues.</p>
</div>
<div class="paragraph">
<p>ContextShared types removes the need for GUIs to have connections to several contexts at once. Without ContextShared types GUIs would have to have one connection to context 0 that subscribes to the control entities, and one connection to the context that contains the data that it should currently be displaying. So the GUI would have two connections, and it would probably be easy to use the wrong connection, for example sending a "fire" request accidentally on the context 0 connection instead of on the Replay connection (where it would get ignored).</p>
</div>
<div class="paragraph">
<p>By introducing ContextShared types this same GUI will only have to have one connection to the Dob. It can subscribe to both the control entities and the data that it displays through the same connection. This makes it impossible for this GUI to send a request in the wrong context, since it only knows of one context at a time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_context_mechanism">14.4. Using the context mechanism</h3>
<div class="paragraph">
<p>This section contains some hints on how APPs and GUIs should be designed to support Replay in different kind of systems.</p>
</div>
<div class="sect3">
<h4 id="_terminology">14.4.1. Terminology</h4>
<div class="ulist">
<ul>
<li>
<p>Replay - the mode that a console is in while showing Replay data.</p>
</li>
<li>
<p>ReplayApp - the component that performs the Replay. Typically an application that reads from a database produced by a "recorder" application, and sets entities and sends messages as if they were owned/sent by the real applications.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_each_operator_console_has_one_mode_type_1">14.4.2. Each operator console has one mode (Type 1)</h4>
<div class="paragraph">
<p>This is a multinode system with one or more server nodes (that is running the APPs) and one or (probably) more operator consoles (running the GUIs). Each console can display either the Normal data, or one Replay session. Different consoles can be in different modes, and several consoles can display the same Replay session.</p>
</div>
<div class="paragraph">
<p>An elaborate example would be: Console 1 and 2 are in Normal mode, console 3 is replaying yesterdays recorded data at three times the speed, and console 4 and 5 is looking at the Replay of data from last week.</p>
</div>
<div class="paragraph">
<p>ReplayApp runs in one of the server nodes, and there is a GUI in each of the operator consoles that allow the operator to start a Replay session, or to "attach" to a Replay session that another operator is running. This results in changes to some control entities (owned by the ReplayApp) that reflect the mode of each console.</p>
</div>
<div class="paragraph">
<p>The APPs whose responsibility it is to maintain the Normal context data are not aware of any of the mode changes (the server nodes don&#8217;t switch modes), and they only connect to context 0.</p>
</div>
<div class="paragraph">
<p>GUIs that are meant to show Replay data must subscribe to the ReplayApp control entities, and when a mode change occurs they must reconnect to the Dob in the desired Replay context.</p>
</div>
<div class="paragraph">
<p>There might be some GUIs in the console that does not listen to the mode change, e.g. the GUI that shows alerts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_standalone_system_supporting_one_mode_type_2">14.4.3. StandAlone system supporting one mode (Type 2)</h4>
<div class="paragraph">
<p>Very similar to a Type 1 system. The only difference is that the APPs are running on the same node as the GUIs. A correct implemented APP or GUI will work without any modification in both a Type 1 and a Type 2 system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_extra_guis_showing_a_replay_session_type_3">14.4.4. Starting extra GUIs showing a Replay session (Type 3)</h4>
<div class="paragraph">
<p>In this kind of system Replay sessions are started in a new set of windows, enabling the user to look at both Normal and one or more Replay sessions at the same time. When a Replay session is started a new set of GUIs (either new instances of the ones that show Normal data, or special replay-GUIs) are started to show the Replay data.</p>
</div>
<div class="paragraph">
<p>In this case the GUIs don&#8217;t listen to the ReplayApp control entities. The GUIs that were started in the Normal context stay in that context. When the operator wants to start a Replay session the system will launch a new set of GUIs (either new instances of the Normal GUIs, or special replay-GUIs), telling them which context to connect to.</p>
</div>
<div class="paragraph">
<p>GUIs in this type of system must have a way of being told which context to connect to, and this could be either a command line parameter, or by setting an environment variable (the latter is probably better, since it makes it easy for plugins and libraries to get at the value, without having to pass around and parse the command reliably).</p>
</div>
</div>
<div class="sect3">
<h4 id="_several_replay_sessions_in_one_console_type_4">14.4.5. Several Replay sessions in one console (Type 4)</h4>
<div class="paragraph">
<p>In this kind of system the user interface shows replayed and real objects intermingled, allowing operations on all objects.</p>
</div>
<div class="paragraph">
<p>The GUIs in this type of system must connect to all contexts that are used on the console. The GUIs have many Dob connections, and they must be explicitly be written to be fully aware of which objects belong to which contexts, and what operations are legal on which objects, e.g. knowing that a track from context 3 (Replay) cannot be sent to the Fire service in context 0.</p>
</div>
<div class="paragraph">
<p>Although supported, this kind of system is usually considered dangerous, since the possibility for mistaking the nature of an object is high.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_app_design">14.5. APP design</h3>
<div class="paragraph">
<p>Almost all applications should only be aware of context 0. An obvious exception to this rule is the the ReplayApp itself.</p>
</div>
</div>
<div class="sect2">
<h3 id="_gui_design">14.6. GUI design</h3>
<div class="paragraph">
<p>In a Type 1 or Type 2 system a well behaved GUI should be designed according to the following rules:</p>
</div>
<div class="paragraph">
<p>All GUIs (that want to be able to show Replay data) must subscribe to a ContextShared entity that shows which context the console should "display".</p>
</div>
<div class="paragraph">
<p>When the GUI gets notified that the console is switching context it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Closes its current connection.</p>
</li>
<li>
<p>Opens the connection in the "new" context.</p>
</li>
<li>
<p>Tells all its "parts" to restart, i.e</p>
<div class="ulist">
<ul>
<li>
<p>Clear all internal state information.</p>
</li>
<li>
<p>Attach to the connection.</p>
</li>
<li>
<p>Set up subscriptions again (A GUI normally does not own entities, but if it does, registrations and creation of entities must be done again.)</p>
</li>
<li>
<p>Restart TracerBackdoor and any BackdoorKeepers (these use message subscriptions internally which are lost in connection Close).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The attach and subscription are the same actions that the GUI must take when it starts up the first time. What is very important when changing context (but not when starting for the first time) is the clearing of internal state information. Leaving any internal state information is a serious safety risk!</p>
</div>
<div class="paragraph">
<p>A ReplayApp will probably send error responses to all requests on entities it owns. Therefore, GUIs in Replay mode needs to disable buttons etc that would generate requests, or be able to ignore the error responses from the ReplayApp.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_support_and_tools">15. Test support and Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Safir SDK Core contains some tools that are useful for, among other things, application and system testing.</p>
</div>
<div class="sect2">
<h3 id="sate">15.1. Sate</h3>
<div class="paragraph">
<p>There is an application in Safir SDK Core, Sate (stands for <em>Safir Application Tester</em>), which is very useful for testing applications that use the Dob. In short it is a GUI application that allows you to perform most operations that the Dob provides interactively.</p>
</div>
<div class="paragraph">
<p>For example, you can set up a subscription to an entity, register entity handlers and set entity instances. You can subscribe to and send messages etc. This can be very useful for interacting with an application, for example before the real HMI is implemented fully, or pretending to be another application that your application communicates with.</p>
</div>
<div class="paragraph">
<p><a href="#sate_overview">Sate screen shot</a> shows Sate with the Safir.Application.BackdoorCommandMessage opened. All the Dob classes are listed in the left sidebar, where you can right-click to get operations you can do on the types. The right sidebar contains operations you can do on the object opened.</p>
</div>
<div id="sate_overview" class="imageblock">
<div class="content">
<a class="image" href="images/sate_overview.png"><img src="images/sate_overview.png" alt="Sate Screen shot"></a>
</div>
<div class="title">Figure 14. Sate screen shot</div>
</div>
<div class="paragraph">
<p>The lower left part is an "inbox", containing the most recent entity updates and requests, service requests and messages received. The lower right hand part shows a history of what "has happened", e.g. showing if a request has been successfully sent, etc.</p>
</div>
</div>
<div class="sect2">
<h3 id="dobexplorer">15.2. Dobexplorer</h3>
<div class="paragraph">
<p>Dobexplorer is a tool that is primarily meant for the developers of the Dob, but it has some features that are useful for users of the Safir SDK Core too. New features are added to dobexplorer as they are needed by the Dob developers.</p>
</div>
<div class="paragraph">
<p><a href="#dobexplorer_memory">Dobexplorer showing a graph of memory usage.</a> shows dobexplorer displaying a graph of the shared memory usage of the Dob. (The amount of memory available is configured in Safir.Dob.NodeParameters, where you also have to look to find out what 100% means.)</p>
</div>
<div id="dobexplorer_memory" class="imageblock">
<div class="content">
<a class="image" href="images/dobexplorer_memory.png"><img src="images/dobexplorer_memory.png" alt="Dobexplorer showing memory usage"></a>
</div>
<div class="title">Figure 15. Dobexplorer showing a graph of memory usage.</div>
</div>
<div class="paragraph">
<p><a href="#dobexplorer_nodes">Dobexplorer showing node statuses.</a> shows dobexplorer displaying a table of the node statuses of a multinode system.</p>
</div>
<div id="dobexplorer_nodes" class="imageblock">
<div class="content">
<a class="image" href="images/dobexplorer_nodes.png"><img src="images/dobexplorer_nodes.png" alt="Dobexplorer showing node statuses"></a>
</div>
<div class="title">Figure 16. Dobexplorer showing node statuses.</div>
</div>
</div>
<div class="sect2">
<h3 id="_entity_viewer">15.3. Entity Viewer</h3>
<div class="paragraph">
<p>The <code>safir_entity_viewer</code> tool is provided as a way to quickly show many instances of one entity, in a table form.</p>
</div>
<div id="entity_viewer" class="imageblock">
<div class="content">
<a class="image" href="images/entity_viewer.png"><img src="images/entity_viewer.png" alt="Entity Viewer Screen shot"></a>
</div>
<div class="title">Figure 17. Entity Viewer screen shot</div>
</div>
</div>
<div class="sect2">
<h3 id="_tool_launcher">15.4. Tool Launcher</h3>
<div class="paragraph">
<p>The <code>safir_tool_launcher</code> tool is useful for launching the different debug tools of Safir SDK Core. Especially useful when there are several nodes running on the same computer (see <a href="#multiple-nodes-on-one-computer">Multiple nodes on one computer</a>)), as it is possible to specify which SAFIR_INSTANCE the launched tool should connect to.</p>
</div>
<div id="tool_launcher" class="imageblock">
<div class="content">
<a class="image" href="images/tool_launcher.png"><img src="images/tool_launcher.png" alt="Tool Launcher Screen shot"></a>
</div>
<div class="title">Figure 18. Tool Launcher screen shot</div>
</div>
</div>
<div class="sect2">
<h3 id="_dots_configuration_check">15.5. dots_configuration_check</h3>
<div class="paragraph">
<p><code>dots_configuration_check</code> is a command line tool that can be used to quickly validate
any set of dou-files without having to run dobmake. It can also be used to look into the
typesystem and retrieve information like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Is the typesystem already loaded by another application.</p>
</li>
<li>
<p>Get type name that belongs to a specific typeId or vice versa.</p>
</li>
<li>
<p>Get parameter values.</p>
</li>
<li>
<p>Make a complete textual output of the loaded typesystem.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By typing "<code>dots_configuration_check --help</code>" all available options are displayed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_more_help">16. More help</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apart from this document there are other sources for help.</p>
</div>
<div class="sect2">
<h3 id="_doxygen_help">16.1. Doxygen help</h3>
<div class="paragraph">
<p>All the language interfaces have comments that can be used to generate documentation (doxygen for C++, javadoc for Java, etc).</p>
</div>
<div class="paragraph">
<p>The generated doxygen documentation is included in the installation packages, and is located
under /usr/share/doc/safir-sdk-core on Linux and under the Start Menu in Windows.</p>
</div>
<div class="paragraph">
<p><em>Use this documentation! It is the place where interface details are explained!</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_asking_questions_and_reporting_bugs">16.2. Asking questions and reporting bugs</h3>
<div class="paragraph">
<p>Questions can be sent directly to us using the contact form or by asking a question in
our Google+ Community. Links to both can be found at <a href="http://safirsdkcore.com" class="bare">http://safirsdkcore.com</a>.</p>
</div>
<div class="paragraph">
<p>Bug reports can either be sent directly to us, or by creating an issue on our GitHub page
<a href="https://github.com/SafirSDK/safir-sdk-core/issues" class="bare">https://github.com/SafirSDK/safir-sdk-core/issues</a>. When you report a bug, please
include as much information as possible, e.g. version information and platform
information. If you experience a crash in any part of Safir SDK Core, please include any
crash dumps that were created.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_applications">Appendix A: Example applications</h2>
<div class="sectionbody">
<div class="sidebarblock">
<div class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>This section mentions <em>VehicleDb</em> several times. This application has in fact been
removed, since Safir SDK Core no longer contains an ODBC wrapper. This section in the
documentation has not been reworked, though.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Along with the Safir SDK Core you should have received some example applications that show how to create a small application that will give you a starting point for your own applications. This appendix explains what these example applications intend to do, and why they were designed the way they were. These examples are also used in the Safir SDK training courses, so if you&#8217;ve attended one of them you will be in familiar territory.</p>
</div>
<div class="paragraph">
<p>The example applications form a very small and simple Safir system. They may execute on one single node or be spread out on different nodes.
Since the Dob provides interfaces in several different languages, the example applications are also provided in different languages.</p>
</div>
<div class="sect2">
<h3 id="_some_background">A.1. Some background</h3>
<div class="paragraph">
<p>The basic design tenets of Safir systems is the separation of business logic from GUI, and of breaking up responsibilities into several applications that each solve a small part of the problem.</p>
</div>
<div class="paragraph">
<p>So Safir systems usually consist of a number of applications that execute on different computers (nodes), and they are classified as either <em>Business applications</em> or <em>Presentation applications</em>. The first type handles all business logic – calculation, communication, request processing etc – while the latter takes care of all presentation of data in a GUI. This is shown in <a href="#logic-separation">Separation of logic from GUI</a>.</p>
</div>
<div class="paragraph">
<p>The applications may execute on the same or different nodes, this is in fact one of the features of Safir SDK, that a developer can run everything on his development-machine, but when the system is deployed to the real or test environment the applications are run on multiple machines, completely transparently to the applications.</p>
</div>
<div id="logic-separation" class="imageblock">
<div class="content">
<a class="image" href="images/separation_tenet.png"><img src="images/separation_tenet.png" alt="Separation tenet"></a>
</div>
<div class="title">Figure 19. Separation of logic from GUI</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_example_problem">A.2. The (example) problem</h3>
<div class="paragraph">
<p>The fictive problem is that we need a system that can give us an overview of a number of manually created vehicles. We also want some services associated with the vehicles.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Presentation of information</dt>
<dd>
<p>The vehicle objects shall be distributed to all system nodes with real-time requirements. The critical information about a vehicle (position and speed) shall be presented in a table (applies to all vehicles) and in a detailed window (applies to a selected vehicle). It shall be possible to edit some of the vehicle information. All changes shall immediately be reflected on all nodes.</p>
<div class="paragraph">
<p>In addition to the real-time requirements, it shall be possible to store and retrieve some information about a vehicle in a database. This information is not real-time critical and is only to be available upon request (i.e. it is not automatically distributed to all nodes).</p>
</div>
</dd>
<dt class="hdlist1">Capacity warning</dt>
<dd>
<p>If the number of created vehicles in the system reaches a parameter-specified limit, we want some kind of warning to be sent to all presentation nodes.</p>
</dd>
<dt class="hdlist1">Speed difference calculation</dt>
<dd>
<p>It shall be possible to calculate the difference between the speed for a selected vehicle and a given speed. We want to be able to use this calculation algorithm to all objects that have a speed – not only vehicles.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_the_solution">A.3. The solution</h3>
<div class="paragraph">
<p>The problem is solved by the following applications:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">VehicleApp</dt>
<dd>
<p>A Safir business application that is the owner of all vehicle objects. It is designed to execute on one server node and has no GUI.</p>
</dd>
<dt class="hdlist1">VehicleMmi</dt>
<dd>
<p>A Safir presentation application that presents all vehicle information in a GUI. It is designed to execute on any number of presentation nodes.</p>
</dd>
<dt class="hdlist1">VehicleDb</dt>
<dd>
<p>A Safir database application that on request interacts with a database through the (now deprecated) Safir ODBC database interface. It is designed to execute on one server node that also runs the ODBC database.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A deployment of the applications is shown in <a href="#vehicle-deployment">Deployment of the Vehicle system</a> where the applications execute on one standalone node, but they could just as well execute on different nodes.</p>
</div>
<div id="vehicle-deployment" class="imageblock">
<div class="content">
<a class="image" href="images/vehicle_deployment.png"><img src="images/vehicle_deployment.png" alt="Vehicle system deployment"></a>
</div>
<div class="title">Figure 20. Deployment of the Vehicle system</div>
</div>
</div>
<div class="sect2">
<h3 id="_vehicleapp_business_application">A.4. VehicleApp - Business Application</h3>
<div class="paragraph">
<p>This application exists in the languages C++ and C#.</p>
</div>
<div class="paragraph">
<p>VehicleApp is the business application in the system. It is the owner of all vehicle entity instances and is therefore the only application with right to create, update and delete vehicle instances. Other applications may send vehicle object requests but it is VehicleApps responsibility to check the requests and perform the changes.</p>
</div>
<div class="paragraph">
<p>The vehicle information is modelled as global Dob entities, which will ensure that all object updates are distributed on all nodes with real-time requirements.</p>
</div>
<div class="paragraph">
<p>To be an owner of vehicle objects, VehicleApp uses the Dob interface <code>EntityHandlerInjection</code>. This means the following things:
- The application will not be a pending owner, i.e. it will override any current owners.
- The application will allow injections from other systems and from the persistency service.</p>
</div>
<div class="paragraph">
<p>VehicleApp handles and responds to create, update and delete requests in the implementation of the interface <code>EntityHandlerInjection</code>. The registration is also performed here.</p>
</div>
<div class="paragraph">
<p>To send a warning when the number of vehicle parameters is reached, a <code>Message</code> is used. To send a message, no registration is required, but the Dob interface <code>MessageSender</code> has to implemented.</p>
</div>
<div class="sect3">
<h4 id="_dou_files">A.4.1. Dou-files</h4>
<div class="paragraph">
<p>The following dou files are provided with VehicleApp. For details, see the corresponding dou file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Capabilities.Vehicles.Vehicle</code></dt>
<dd>
<p>Definition of a vehicle object. This data will be distributed in the system.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.VehicleCategoryCode</code></dt>
<dd>
<p>Enumeration of vehicle category codes.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.Vehicle-Safir.Dob.InjectionProperty</code></dt>
<dd>
<p>Mapping that denotes the kind of injection. The vehicle object is SynchronousVolatile, which means that vehicle objects survives an application but not a Dob restart. No injections of vehicle objects from external systems will take place.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.VehicleMsg</code></dt>
<dd>
<p>Definition of message that is sent when the number of created vehicle objects reaches the limit specified in VehicleParameters.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.CalculateSpeedDifference</code></dt>
<dd>
<p>Definition of a service that calculates the speed difference between a vehicle object speed and a given speed. A property is used to obtain the speed from the vehicle object.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.CalculateSpeedDifferenceResponse</code></dt>
<dd>
<p>Definition of the speed difference service response.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.SpeedObjectProperty</code></dt>
<dd>
<p>Definition of the speed property.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.Vehicle-Capabilities.SpeedObjectProperty</code></dt>
<dd>
<p>Mapping of the speed property onto the speed member of the vehicle class.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.VehicleParameters</code></dt>
<dd>
<p>Definition of vehicle parameters.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_internal_design">A.4.2. Internal Design</h4>
<div class="paragraph">
<p><a href="#vehicleapp-class-diagram">VehicleApp class diagram</a> shows the classes of the C++ version of VehicleApp and the most important Dob classes and consumer interfaces that they use.</p>
</div>
<div id="vehicleapp-class-diagram" class="imageblock">
<div class="content">
<a class="image" href="images/vehicleapp_class_diagram.png"><img src="images/vehicleapp_class_diagram.png" alt="Class Diagram"></a>
</div>
<div class="title">Figure 21. VehicleApp class diagram</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">App</dt>
<dd>
<p>Main class. Called by the Dob on application stop. Contains the main Dob connection.</p>
</dd>
<dt class="hdlist1">EntityHandler</dt>
<dd>
<p>Registers ownership of the vehicle class and receives all vehicle object requests and injections.</p>
</dd>
<dt class="hdlist1">ServerHandler</dt>
<dd>
<p>Registers ownership of the speed difference service and receives all service requests.</p>
</dd>
<dt class="hdlist1">MessageSender</dt>
<dd>
<p>Sends message when number of vehicle objects has reached the limit specified through a parameter.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_vehiclemmi_presentation_application">A.5. VehicleMmi - Presentation Application</h3>
<div class="paragraph">
<p>This application exists in two variants, one in C++ with the Qt widget set and one in C# using WinForms.</p>
</div>
<div class="paragraph">
<p>VehicleMmi is the presentation application in the system. It subscribes to, and presents all vehicle data in a table in the GUI. It also presens information for a selected vehicle object in a detailed window. In this window, it is possible to enter new data for a vehicle and send a request to change it. It is also possible to create a new vehicle object.</p>
</div>
<div class="paragraph">
<p>Subscription to the vehicle entities is started through the Dob interface <code>EntitySubscriber</code>. As soon as an entity is updated, VehicleMmi will receive a subscription response.</p>
</div>
<div class="paragraph">
<p>The application also receives the warning message that is sent by VehicleApp. This is done through implementation of the Dob interface <code>MessageSubscriber</code>.</p>
</div>
<div class="paragraph">
<p>To obtain additional database information – that is not received throuh a subscription response – for a selected vehicle, it is possible to request this from the VehicleDb. If the database information does not exist, it is created by VehicleMmi.</p>
</div>
<div class="paragraph">
<p>It is possible to calculate the difference between a selected vehicle object and an entered speed through the the speed difference calculation service. The calculation itself it vary basic since we want to focus on how to use a Dob service.</p>
</div>
<div class="sect3">
<h4 id="_windows_and_dialogs">A.5.1. Windows and Dialogs</h4>
<div class="paragraph">
<p>This section is an overview of the windows and dialogs of the VehicleMmi application.</p>
</div>
<div class="paragraph">
<p>The list view in <a href="#vehiclemmi-list">VehicleMmi list view.</a> contains all published vehicle objects in the system. All created, changed and deleted vehicle objects are received by VehicleMmi as entity subscription responses and presented in the list view. An object may be deleted from the list view, but not modified. It is also possible to delete category information for a category code from the list view.</p>
</div>
<div id="vehiclemmi-list" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_list.png"><img src="images/vehiclemmi_list.png" alt="VehicleMmi List"></a>
</div>
<div class="title">Figure 22. VehicleMmi list view.</div>
</div>
<div class="paragraph">
<p>The dialog in <a href="#vehiclemmi-create">VehicleMmi Create dialog</a> is opened from the list view and is used to send create requests for new vehicle objects. The requests are received by VehicleApp.</p>
</div>
<div id="vehiclemmi-create" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_create.png"><img src="images/vehiclemmi_create.png" alt="VehicleMmi Create dialog"></a>
</div>
<div class="title">Figure 23. VehicleMmi Create dialog</div>
</div>
<div class="paragraph">
<p>The dialog in <a href="#vehiclemmi-update">VehicleMmi Update dialog</a> is opened from the list view and is used to send update requests for existing vehicle objects. The requests are received by VehicleApp.</p>
</div>
<div id="vehiclemmi-update" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_update.png"><img src="images/vehiclemmi_update.png" alt="VehicleMmi Update dialog"></a>
</div>
<div class="title">Figure 24. VehicleMmi Update dialog</div>
</div>
<div class="paragraph">
<p>The dialog in <a href="#vehiclemmi-calculate-speed">VehicleMmi Speed calculation dialog</a> is opened from the list view and is used to send to calculate the difference between the speed for a selected vehicle object and an entered speed. The request is sent through a service to VehicleApp and the result is given in the sevice response.</p>
</div>
<div id="vehiclemmi-calculate-speed" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_calculate_speed.png"><img src="images/vehiclemmi_calculate_speed.png" alt="Speed calculation"></a>
</div>
<div class="title">Figure 25. VehicleMmi Speed calculation dialog</div>
</div>
<div class="paragraph">
<p>The dialog in <a href="#vehiclemmi-category-info">VehicleMmi Category information dialog</a> is opened from the list view and is used to obtain category information for the selected vehicle object. If there is no information the category code in the database, the information entered in the dialog is instead stored for the given category code.</p>
</div>
<div id="vehiclemmi-category-info" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_category_info.png"><img src="images/vehiclemmi_category_info.png" alt="Category info"></a>
</div>
<div class="title">Figure 26. VehicleMmi Category information dialog</div>
</div>
</div>
<div class="sect3">
<h4 id="_dou_files_2">A.5.2. Dou-files</h4>
<div class="paragraph">
<p>No dou files are provided by VehicleMmi.</p>
</div>
</div>
<div class="sect3">
<h4 id="_internal_design_2">A.5.3. Internal Design</h4>
<div class="paragraph">
<p><a href="#vehiclemmi-class-diagram">VehicleMmi class diagram</a> shows the classes of the C# version of VehicleMmi and the most important Dob classes and consumer interfaces that they use.</p>
</div>
<div id="vehiclemmi-class-diagram" class="imageblock">
<div class="content">
<a class="image" href="images/vehiclemmi_class_diagram.png"><img src="images/vehiclemmi_class_diagram.png" alt="Class Diagram"></a>
</div>
<div class="title">Figure 27. VehicleMmi class diagram</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">App</dt>
<dd>
<p>Main class. Called by the Dob on application stop.Contains the main Dob connection.</p>
</dd>
<dt class="hdlist1">EntityFrame</dt>
<dd>
<p>Contains the list view and the buttons that open the dialogs and operates on vehicle objects.</p>
</dd>
<dt class="hdlist1">EntityListHandler</dt>
<dd>
<p>Subscribes to vehicle objects. Updates the list view according to subscription responses.</p>
</dd>
<dt class="hdlist1">EntityDialog</dt>
<dd>
<p>Implements the Create vehicle and Update vehicle dialogs. Sends vehicle object requests that are received by VehicleApp.</p>
</dd>
<dt class="hdlist1">ServiceDialog</dt>
<dd>
<p>Implements the Speed difference calculator dialog. Sends a service request that is received by VehicleApp.</p>
</dd>
<dt class="hdlist1">MessageDialog</dt>
<dd>
<p>Implements the dialog that is presented when the number of created vehicle objects has reached the limit specified by a parameter. Subscribes to a Dob message.</p>
</dd>
<dt class="hdlist1">CategoryInfoDialog</dt>
<dd>
<p>Implements the Category information dialog. Sends service requests to create new category information data code or to obtain existing data for a category information. The requests are received by VehicleDb.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_vehicledb_database_application">A.6. VehicleDb - Database Application</h3>
<div class="paragraph">
<p>VehicleDb is the database application in the system. It sets up a connection to an ODBC database and reads and writes data from and to it. These database transactions are triggered by Dob service requests.</p>
</div>
<div class="paragraph">
<p>The database contains vehicle category information. I.e. for each category code there is additional information that is stored in a database.</p>
</div>
<div class="paragraph">
<p>All database interaction is made through the Safir ODBC interface (which is deprecated, as of Safir SDK Core 6.0).</p>
</div>
<div class="paragraph">
<p>A condition for the database application to work properly is that there is an ODBC database setup. A script is provided to set up a Mimer database with the correct tables, columns, stored procedures and user information.</p>
</div>
<div class="paragraph">
<p>The database connection is setup by a few steps on startup of the application. VehicleDb provides the following services:
- Get vehicle category information
- Set vehicle category information
- Delete vehicle category information</p>
</div>
<div class="paragraph">
<p>When a service request is received, a corresponding database transaction is performed. The database transactions are performed by calling stored procedures.</p>
</div>
<div class="paragraph">
<p>When a transaction is performed successfully, a service response is sent. The response depends on the request type.</p>
</div>
<div class="sect3">
<h4 id="_dou_files_3">A.6.1. Dou-files</h4>
<div class="paragraph">
<p>The following dou files are provided with VehicleDb. For details, see the corresponding dou file.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Capabilities.Vehicles.DatabaseParameters</code></dt>
<dd>
<p>Database connection parameters.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.VehicleCategoryInfo</code></dt>
<dd>
<p>Definition of a vehicle category.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.DeleteVehicleCategoryService</code></dt>
<dd>
<p>This service is used for deletion of a vehicle category.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.GetVehicleCategoryService</code></dt>
<dd>
<p>This service is used to obtain a vehicle category info.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.GetVehicleCategoryResponse</code></dt>
<dd>
<p>The GetVehicleCategoryService response.</p>
</dd>
<dt class="hdlist1"><code>Capabilities.Vehicles.SetVehicleCategoryService</code></dt>
<dd>
<p>This service is used to create a new vehicle category info.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_internal_design_3">A.6.2. Internal Design</h4>
<div class="paragraph">
<p><a href="#vehicledb-class-diagram">VehicleDb class diagram</a> shows the VehicleApp classes and the most important interfaces that they use.</p>
</div>
<div id="vehicledb-class-diagram" class="imageblock">
<div class="content">
<a class="image" href="images/vehicledb_class_diagram.png"><img src="images/vehicledb_class_diagram.png" alt="Class Diagram"></a>
</div>
<div class="title">Figure 28. VehicleDb class diagram</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">App</dt>
<dd>
<p>Main class. Called by the Dob on application stop. Contains the main Dob connection.</p>
</dd>
<dt class="hdlist1">VehicleDatabaseServices</dt>
<dd>
<p>Registers ownership of the Vehicle category information services. Receives all service requests and triggers action in the DatabaseInteraction class.</p>
</dd>
<dt class="hdlist1">DatabaseInteraction</dt>
<dd>
<p>Performs all database interaction. Sets up the database connection on startup. Prepares database statements that are executes on request.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="websocket_api_reference">Appendix B: Dob WebSocket/JSON-RPC API reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains an API reference describing the Safir WebSocket JSON-RPC interface.</p>
</div>
<div class="paragraph">
<p>The API is compliant with the JSON-RPC specification 2.0 (<a href="http://www.jsonrpc.org/specification" class="bare">http://www.jsonrpc.org/specification</a>), and the transport
mechanism is WebSockets <a href="https://tools.ietf.org/html/rfc6455">rfc6455</a>.
To use the API, connect a WebSocket to the Safir WebSocket server and send the JSON messages defined in this section.
Remember that JSON is case sensitive.</p>
</div>
<div class="sect2">
<h3 id="_methods">B.1. Methods</h3>
<div class="paragraph">
<p>This section describes all methods exposed by the Dob JSON-RPC interface. Methods can be called by clients and
a response with the same id is guaranteed. The id can be either a string or a number. If no id is present the method
will still be executed but the caller will not get any response.</p>
</div>
<div class="paragraph">
<p>Some parameters have a specified default value. Such parameters can be omitted in a method call and will then adopt their default value.</p>
</div>
<div class="sect3">
<h4 id="_method_close">B.1.1. Method: close</h4>
<div class="paragraph">
<p>Close connection to the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned, otherwize an error is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "close", "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_createrequest">B.1.2. Method: createRequest</h4>
<div class="paragraph">
<p>Send a entity create request to a handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>entity</code> - Entity to create.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the new entity. Only allowed if the instanceIdPolicy is <em>RequestorDecidesInstanceId</em></p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler to send the request to. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>isSuccess</code> - Indicates if the request was successful or not, can be <em>true</em> or <em>false</em>.</p>
</li>
<li>
<p><code>response</code> - The response object that inherits from Safir.Dob.Response.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "createRequest", "params": {"entity": {"_DouType": "Safir.Dob.Entity"}, "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"isSuccess": true, "response": {"_DouType": "Safir.Dob.SuccessResponse"}}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_deleteallinstances">B.1.3. Method: deleteAllInstances</h4>
<div class="paragraph">
<p>Deletes all owned instances.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entities to delete.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "deleteAllInstances", "params": {"typeId": "Test.MyEntity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_deleteentity">B.1.4. Method: deleteEntity</h4>
<div class="paragraph">
<p>Deletes an entity instance in the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity to delete.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to delete.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "deleteEntity", "params": {"typeId": "Test.MyEntity", "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_deleterequest">B.1.5. Method: deleteRequest</h4>
<div class="paragraph">
<p>Send a request to delete an entity instance.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity the request is aimed at.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to delete.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>isSuccess</code> - Indicates if the request was successful or not, can be <em>true</em> or <em>false</em>.</p>
</li>
<li>
<p><code>response</code> - The response object that inherits from Safir.Dob.Response.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "deleteRequest", "params": {"typeId": "Test.MyEntity", "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"isSuccess": true, "response": {"_DouType": "Safir.Dob.SuccessResponse"}}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_getallinstanceids">B.1.6. Method: getAllInstanceIds</h4>
<div class="paragraph">
<p>Get a list of all instance id&#8217;s that is created of an entity.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>list</code> - A list of instance id&#8217;s.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "getAllInstanceIds", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": [1, 2], "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_getinstanceidpolicy">B.1.7. Method: getInstanceIdPolicy</h4>
<div class="paragraph">
<p>Get the instance id policy for a type and handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - A string that can be either <em>RequestorDecidesInstanceId</em> or <em>HandlerDecidesInstanceId</em>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "getInstanceIdPolicy", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "RequestorDecidesInstanceId", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_getnumberofinstances">B.1.8. Method: getNumberOfInstances</h4>
<div class="paragraph">
<p>Get the number of existing instances of a type.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> ALL_HANDLERS)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also subscribe for all subclasses to the specified typeId. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - Number of instances.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "getNumberOfInstances", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": 10, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_gettypehierarchy">B.1.9. Method: getTypeHierarchy</h4>
<div class="paragraph">
<p>Get the entire DOU type hierarchy. This method is only allowed if <em>EnableTypesystemCommands</em> is set to <em>true</em> in
the WebSocket server configuration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - An instance of Safir.Websocket.Typesystem.TypeHierarchy</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "getTypeHierarchy", "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Safir.Websocket.Typesystem.TypeHierarchy", "RootClass": {...}}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_iscreated">B.1.10. Method: isCreated</h4>
<div class="paragraph">
<p>Check if an entity instance exists in the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - <em>true</em> or <em>false</em>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "isCreated", "params": {"typeId": "Test.MyEntity", "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": true, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_isopen">B.1.11. Method: isOpen</h4>
<div class="paragraph">
<p>Check if there is an open connection to the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - If connected to the Dob <em>true</em> is returned, otherwize <em>false</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "isOpen", "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": true, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_open">B.1.12. Method: open</h4>
<div class="paragraph">
<p>Opens a connection to the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>connectionName</code> - Name of the new connection.</p>
</li>
<li>
<p><code>context</code> - Context for connection. <em>(<strong class="small">Default:</strong> 0)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned, otherwize an error is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "open", "params": {"connectionName": "foo"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_ping">B.1.13. Method: ping</h4>
<div class="paragraph">
<p>This method can be used to test a connection. When the Safir WebSocket server receives a ping, it will immediately respond with a "pong".
This message can also be used in those rare cases when the client WebSocket implementation doesn&#8217;t support the ping opcode. That is a low level
keep alive message that will prevent connectons with low traffic to be disconnected. In that case manual pings can be sent with a low frequent
but periodic timer.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - If connected the string "pong" is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "ping", "id": "testId"}
&lt;-- {"jsonrpc": "2.0", "result": "pong", "id": "testId"}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_readentity">B.1.14. Method: readEntity</h4>
<div class="paragraph">
<p>Read current version of an entity in the Dob.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type of the entity to read.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to read.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - The read entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "readEntity", "params": {"typeId": "Test.MyEntity", "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Test.MyEntity", "Val1": "foo"}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_registerentityhandler">B.1.15. Method: registerEntityHandler</h4>
<div class="paragraph">
<p>Register an entity handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Entity type to register.</p>
</li>
<li>
<p><code>handlerId</code> - Id of this handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
<li>
<p><code>instanceIdPolicy</code> - Who decides instance ids. A string that can be either <em>RequestorDecidesInstanceId</em> or <em>HandlerDecidesInstanceId</em>. <em>(<strong class="small">Default:</strong> RequestorDecidesInstanceId)</em></p>
</li>
<li>
<p><code>injectionHandler</code> - Does the handler handle injections. <em>(<strong class="small">Default:</strong> false)</em></p>
</li>
<li>
<p><code>pending</code> - Is this a pending registration <em>(<strong class="small">Default:</strong> false)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "registerEntityHandler", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_registerservicehandler">B.1.16. Method: registerServiceHandler</h4>
<div class="paragraph">
<p>Register a service handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Service type to register.</p>
</li>
<li>
<p><code>handlerId</code> - Id of this handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
<li>
<p><code>pending</code> - Is this a pending registration <em>(<strong class="small">Default:</strong> false)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "registerServiceHandler", "params": {"typeId": "Safir.Dob.ServiceRequest"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_sendmessage">B.1.17. Method: sendMessage</h4>
<div class="paragraph">
<p>Send a message.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>message</code> - Message to send.</p>
</li>
<li>
<p><code>channelId</code> - Channel to send on. <em>(<strong class="small">Default:</strong> DEFAULT_CHANNELS)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "sendMessage", "params": {"message": {"_DouType": "Safir.Dob.Message"}}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_servicerequest">B.1.18. Method: serviceRequest</h4>
<div class="paragraph">
<p>Send a service request to a handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>service</code> - Service object.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler to send the request to. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>isSuccess</code> - Indicates if the request was successful or not, can be <em>true</em> or <em>false</em>.</p>
</li>
<li>
<p><code>response</code> - The response object that inherits from Safir.Dob.Response.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "serviceRequest", "params": {"service": {"_DouType": "Test.MyService", "SomeValue": 100}}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"isSuccess": true, "response": {"_DouType": "Safir.Dob.SuccessResponse"}}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_setentity">B.1.19. Method: setEntity</h4>
<div class="paragraph">
<p>Creates or updates an entity in the Dob. No merge is performed, the entity will look exactly like the one submitted in the
entity parameter. Any members not present will be set to null.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>entity</code> - Entity to set in the Dob.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to set.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "setEntity", "params": {"entity": {"_DouType": "Test.MyEntity", "Val1": "foo", "Val2": "bar"}, "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_setentitychanges">B.1.20. Method: setEntityChanges</h4>
<div class="paragraph">
<p>Merge all members that are present in the entity parameter, with the current version of the entity in the Dob.
Only the members that are present in the entity parameter are considered as part of the change. This means that if the
intention is to change a specific member to null, that member must explicitly be part of the entity parameter with the value null.
Since JSON arrays don&#8217;t have indices, it limits the possibility to set changes on individual array values.
Hence, if an array is to be changed the entire array should be specified in the call.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>entity</code> - Entity merge into the Dob.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to change.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler. <em>(<strong class="small">Default:</strong> DEFAULT_HANDLER)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "setEntityChanges", "params": {"entity": {"_DouType": "Test.MyEntity", "Val1": "foo", "Val2": null}, "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_subscribeentity">B.1.21. Method: subscribeEntity</h4>
<div class="paragraph">
<p>Subscribe for entities.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Entity type to subscribe for.</p>
</li>
<li>
<p><code>instanceId</code> - Specific instance. Not allowed if <code>includeSubclasses</code> also is present. <em>(<strong class="small">Default:</strong> ALL_INSTANCES)</em></p>
</li>
<li>
<p><code>includeUpdates</code> - Get notified on updated entity states. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
<li>
<p><code>restartSubscription</code> - Restart subscription to get onNewEntity for all existing instances. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Include subclasses to specified typeId. Not allowed if <code>instanceId</code> is present <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "subscribeEntity", "params": {"typeId": "Safir.Dob.Entity", "instanceId": 10}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_subscribemessage">B.1.22. Method: subscribeMessage</h4>
<div class="paragraph">
<p>Subscribe for messages.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Name of an existing message type.</p>
</li>
<li>
<p><code>channelId</code> - Channel to subscribe on. <em>(<strong class="small">Default:</strong> ALL_CHANNELS)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also subscribe for all subclasses to the specified typeId. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "subscribeMessage", "params": {"typeId": "Safir.Dob.Message"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_subscriberegistration">B.1.23. Method: subscribeRegistration</h4>
<div class="paragraph">
<p>Subscribe for handler registrations of entities and services.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Entity or Service type to subscribe for registrations.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler of interest. <em>(<strong class="small">Default:</strong> ALL_HANDLERS)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also subscribe for registrations of subclasses to specified typeId. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
<li>
<p><code>restartSubscription</code> - Restart subscription to get onRegistered for all existing handlers. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "subscribeRegistration", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_unregisterhandler">B.1.24. Method: unregisterHandler</h4>
<div class="paragraph">
<p>Unregister an entity or service handler.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - The type to unregister.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler to unregister. <em>(<strong class="small">Default:</strong> ALL_HANDLERS)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "unregisterHandler", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_unsubscribeentity">B.1.25. Method: unsubscribeEntity</h4>
<div class="paragraph">
<p>Subscribe for entities.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Entity type to unsubscribe for.</p>
</li>
<li>
<p><code>instanceId</code> - Unsubscribe for specific instance. Not allowed if <code>includeSubclasses</code> also is present. <em>(<strong class="small">Default:</strong> ALL_INSTANCES)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also unsubscribe for subclasses to specified typeId. Not allowed if <code>instanceId</code> is present. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "unsubscribeEntity", "params": {"typeId": "Safir.Dob.Entity", "instanceId": 10}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_unsubscribemessage">B.1.26. Method: unsubscribeMessage</h4>
<div class="paragraph">
<p>Unsubscribe for messages.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Name of an existing message type.</p>
</li>
<li>
<p><code>channelId</code> - Channel to subscribe on. <em>(<strong class="small">Default:</strong> ALL_CHANNELS)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also subscribe for all subclasses to the specified typeId. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "unsubscribeMessage", "params": {"typeId": "Safir.Dob.Message"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_unsubscriberegistration">B.1.27. Method: unsubscribeRegistration</h4>
<div class="paragraph">
<p>Unsubscribe for handler registrations of entities and services.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Entity or Service type to unsubscribe for registrations.</p>
</li>
<li>
<p><code>handlerId</code> - Id of the handler of interest. <em>(<strong class="small">Default:</strong> ALL_HANDLERS)</em></p>
</li>
<li>
<p><code>includeSubclasses</code> - Also unsubscribe for registrations of subclasses to specified typeId. <em>(<strong class="small">Default:</strong> true)</em></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>value</code> - On success the string <em>OK</em> is returned.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "unsubscribeRegistration", "params": {"typeId": "Safir.Dob.Entity"}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": "OK", "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_updaterequest">B.1.28. Method: updateRequest</h4>
<div class="paragraph">
<p>Send a entity update request to the registered handler.
Only the members that are present in the entity parameter are considered as part of the update request. This means that if the
intention is to change a specific member to null, that member must explicitly be part of the entity parameter with the value null.
Since JSON arrays don&#8217;t have indices, it limits the possibility to send change requests on individual array values.
Hence, if an array is part of an update request the entire array should be specified in the request.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>entity</code> - Updated version of the entity.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id of the entity to update.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Returns</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>isSuccess</code> - Indicates if the request was successful or not, can be <em>true</em> or <em>false</em>.</p>
</li>
<li>
<p><code>response</code> - The response object that inherits from Safir.Dob.Response.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "updateRequest", "params": {"entity": {"_DouType": "Test.MyEntity", "SomeValue": "changedValue"}, "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"isSuccess": true, "response": {"_DouType": "Safir.Dob.SuccessResponse"}}, "id": 123}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_notifications">B.2. Notifications</h3>
<div class="paragraph">
<p>This section describes all notifications sent from server to client when something happens that is not an immediate response
to a method call.</p>
</div>
<div class="sect3">
<h4 id="_notification_oncompletedregistration">B.2.1. Notification: onCompletedRegistration</h4>
<div class="paragraph">
<p>Called when a pending registration has been completed.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type for which the pending registration has been completed.</p>
</li>
<li>
<p><code>handlerId</code> - The handler id.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onCompletedRegistration", "params": {"typeId": "Test.MyService", "handlerId": -6778878277529052275}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_ondeletedentity">B.2.2. Notification: onDeletedEntity</h4>
<div class="paragraph">
<p>Deleted entity notification. Subscription response to a subscribeEntity.
The received entity is what the entity state looked like when it was deleted.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - The instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The updated entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onDeletedEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_oninitialinjectionsdone">B.2.3. Notification: onInitialInjectionsDone</h4>
<div class="paragraph">
<p>Called when initial injections are done.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type for which the initial injection is done.</p>
</li>
<li>
<p><code>handlerId</code> - The handler id.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onInitialInjectionsDone", "params": {"typeId": "Test.MyEntity", "handlerId": -6778878277529052275}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_oninjecteddeletedentity">B.2.4. Notification: onInjectedDeletedEntity</h4>
<div class="paragraph">
<p>Called when an entity deletetion is injected.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - Instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The deleted injected entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onInjectedDeletedEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_oninjectednewentity">B.2.5. Notification: onInjectedNewEntity</h4>
<div class="paragraph">
<p>Called when a new entity is injected.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - Instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The injected entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onInjectedNewEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_oninjectedupdatedentity">B.2.6. Notification: onInjectedUpdatedEntity</h4>
<div class="paragraph">
<p>Called when an entity update is injected.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - Instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The injected entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onInjectedUpdatedEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onmessage">B.2.7. Notification: onMessage</h4>
<div class="paragraph">
<p>New message notification. Subscription response to a subscribeMessage.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>channelId</code> - The channel that the message was sent on.</p>
</li>
<li>
<p><code>message</code> - Received message.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onMessage", "params": {"channelId": 3313918482685577033, "message": {"_DouType": "Safir.Dob.Message"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onnewentity">B.2.8. Notification: onNewEntity</h4>
<div class="paragraph">
<p>New entity notification. Subscription response to a subscribeEntity.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - The instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The new entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onNewEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onnotmessageoverflow">B.2.9. Notification: onNotMessageOverflow</h4>
<div class="paragraph">
<p>It is meaningful to try to send messages again after an overflow.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onNotMessageOverflow"}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onnotrequestoverflow">B.2.10. Notification: onNotRequestOverflow</h4>
<div class="paragraph">
<p>It is meaningful to try to send requests again after an overflow.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onNotRequestOverflow"}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onregistered">B.2.11. Notification: onRegistered</h4>
<div class="paragraph">
<p>New registration notification. Subscription response to a subscribeRegistrations.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type that has been registered.</p>
</li>
<li>
<p><code>handlerId</code> - The handler id that has been registered.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onRegistered", "params": {"typeId": "Test.MyService", "handlerId": -6778878277529052275}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onrevokedregistration">B.2.12. Notification: onRevokedRegistration</h4>
<div class="paragraph">
<p>Called when a handler registration has been revoked.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type for which the registration has been revoked.</p>
</li>
<li>
<p><code>handlerId</code> - The handler id.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onRevokedRegistration", "params": {"typeId": "Test.MyService", "handlerId": -6778878277529052275}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onunregistered">B.2.13. Notification: onUnregistered</h4>
<div class="paragraph">
<p>Removed registration notification. Subscription response to a subscribeRegistrations.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>typeId</code> - Type that has been unregistered.</p>
</li>
<li>
<p><code>handlerId</code> - The handler id that has been unregistered.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onUnregistered", "params": {"typeId": "Test.MyService", "handlerId": -6778878277529052275}}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_notification_onupdatedentity">B.2.14. Notification: onUpdatedEntity</h4>
<div class="paragraph">
<p>Updated entity notification. Subscription response to a subscribeEntity.
The received entity is the complete current state. I.e It does not only contain the changes since last version.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>instanceId</code> - The instance id of the entity.</p>
</li>
<li>
<p><code>entity</code> - The updated entity.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onUpdatedEntity", "params": {"instanceId": 1, "entity": {"_DouType": "Test.MyEntity"}}}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_receive_and_respond_to_requests">B.3. Receive and respond to requests</h3>
<div class="paragraph">
<p>This section describes all the requests an entity or service handler can receive. It is also described what a valid response must look like.
When a handler (service handler or entity handler) receives a request, that request will always have an <em>id</em> that is a <em>number</em>.
The handler is responsible for sending a valid response as fast as possible with the same id as the request.</p>
</div>
<div class="sect3">
<h4 id="_method_oncreaterequest">B.3.1. Method: onCreateRequest</h4>
<div class="paragraph">
<p>Entity handler receives a create request.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>handlerId</code> - The handler that is being requested.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id the requestor wants the handler to create. Only present if the instanceIdPolicy is <em>RequestorDecidesInstanceId</em></p>
</li>
<li>
<p><code>entity</code> - Entity the requestor wants the handler to create.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - An instance of Safir.Dob.Response</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onCreateRequest", "params": {"handlerId": -6778878277529052275, "instanceId": 1, "entity": {"_DouType": "Safir.Dob.Entity"}}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Safir.Dob.SuccessResponse"}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_ondeleterequest">B.3.2. Method: onDeleteRequest</h4>
<div class="paragraph">
<p>Entity handler receives a delete request.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>handlerId</code> - The handler that is being requested.</p>
</li>
<li>
<p><code>typeId</code> - Type of the entity the requestor want the handler to delete.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id the requestor wants the handler to delete.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - An instance of Safir.Dob.Response</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onDeleteRequest", "params": {"handlerId": -6778878277529052275, "typeId": "Safir.Dob.Entity", "instanceId": 1}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Safir.Dob.SuccessResponse"}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_onservicerequest">B.3.3. Method: onServiceRequest</h4>
<div class="paragraph">
<p>Service handler receives service request.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>handlerId</code> - The handler that is being requested.</p>
</li>
<li>
<p><code>request</code> - The Safir.Dob.Service object containing the request.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - An instance of Safir.Dob.Response</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onServiceRequest", "params": {"handlerId": -6778878277529052275, "request": {"_DouType": "Test.MyService"}}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Safir.Dob.SuccessResponse"}, "id": 123}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_method_onupdaterequest">B.3.4. Method: onUpdateRequest</h4>
<div class="paragraph">
<p>Entity handler receives an update request.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Parameters</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>handlerId</code> - The handler that is being requested.</p>
</li>
<li>
<p><code>instanceId</code> - Instance id the requestor wants the handler to update.</p>
</li>
<li>
<p><code>entity</code> - Entity containing changes that the requestor wants the handler to merge with the current state.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Response</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>object</code> - An instance of Safir.Dob.Response</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "method": "onUpdateRequest", "params": {"handlerId": -6778878277529052275, "instanceId": 1, "entity": {"_DouType": "Safir.Dob.Entity"}}, "id": 123}
&lt;-- {"jsonrpc": "2.0", "result": {"_DouType": "Safir.Dob.SuccessResponse"}, "id": 123}</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_errors">B.4. Errors</h3>
<div class="paragraph">
<p>If an error occurs the Safir WebSocket server will send an error to the client. The error is sent in place of a response, and if possible the id of the request will be
preserved. However if it is not possible to extract the id, the error will be sent with a null-id. The error messge is specified in the JSON-RPC 2.0 specification.</p>
</div>
<div class="paragraph">
<p>Besides the predefined error codes, Safir can send the following error codes</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Error codes</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><code>SafirNotOpen (100)</code> - When fail to open a Dob connection.</p>
</li>
<li>
<p><code>SafirOverflow (101)</code> - Sending requests or messges to fast.</p>
</li>
<li>
<p><code>SafirAccessDenied (102)</code> - Trying to modify an entity without ownership.</p>
</li>
<li>
<p><code>SafirGhostExists (103)</code> - Trying to modify an entity when there is a ghost instance that hasn&#8217;t been injected.</p>
</li>
<li>
<p><code>SafirNotFound (104)</code> - Calling read or getInstanceIdPolicy on non-existing instance.</p>
</li>
<li>
<p><code>SafirIllegalValue (105)</code> - A parameter was invalid.</p>
</li>
<li>
<p><code>SafirSoftwareViolation (106)</code> - There is a programming error somewhere. For example trying register a global type on a light node.</p>
</li>
<li>
<p><code>SafirUnexpectedException (108)</code> - Unexpected exception occurred.</p>
</li>
<li>
<p><code>SafirLowMemoryException (109)</code> - Operation could not be completed because Dob shared memory is running low.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">Example</dt>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>--&gt; {"jsonrpc": "2.0", "error": {"code": 100, "message": "SafirNotOpen", "data": "Could not open connection..."}, "id": 123}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="faq">Appendix C: FAQ</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">Why do I get IllegalValueExceptions when sending message/request or setting an entity?</dt>
<dd>
<p>Most likely because you&#8217;ve got a string in your object that is longer than what is specified by the <code>maxLength</code> field in your dou-file. For various reasons the string lengths are not checked until the object is "handed" to the Dob. This means that if you put a string which is 100 characters long into a message member that has <code>maxLength</code> 10 you will not get the error until you call <code>Send</code>.</p>
<div class="paragraph">
<p>Remember that you can check the value of maxLength programmatically by calling <code>&lt;member name&gt;MaxStringLength()</code> on your class (e.g. <code>Safir::Dob::ErrorResponse::AdditionalInfoMaxStringLength()</code> to get the max length of the member AdditionalInfo).</p>
</div>
</dd>
<dt class="hdlist1">How are the callbacks invoked?</dt>
<dd>
<p>When something occurs that an application may be interested in knowing about the Dob signals an event internally that results in a call to the <code>OnDoDispatch()</code> callback. The application now has to <em>switch threads</em> to the thread that owns the connection and call <code>Dispatch()</code>. The Dispatch call will in turn call all the required callbacks (e.g. OnMessage if a message has been received). Note that a dispatch may be triggered without actually resulting in any callbacks.</p>
</dd>
<dt class="hdlist1">Can I trust IsCreated?</dt>
<dd>
<p>IsCreated can really only be trusted by the entity instance owner. All other applications can get true in one statement, and then get an exception (due to timing) on the next, where they to try to read the contents of an instance.</p>
</dd>
<dt class="hdlist1">Why does dope_main crash at startup?</dt>
<dd>
<p>Chances are that you have changed you dou-files, and that the persisted data is no longer valid. There is a solution to this, which is outlined in <a href="#persistence_service">The persistence service</a>, but of course you can just delete the persistent data by removing the files or clearing the database table contents.</p>
</dd>
<dt class="hdlist1">What do I do with the <code>ResponseSender</code> when I&#8217;m postponing a request?</dt>
<dd>
<p>If you&#8217;re postponing with the <code>redispatchCurrent</code> flag set to true you need to call <code>Discard</code> on the ResponseSender, otherwise it will get upset that you&#8217;re not sending a response and cause your application to report an error and maybe crash.</p>
</dd>
<dt class="hdlist1">Why have overflows?</dt>
<dd>
<p>One of the main design focuses of the Dob has been to facilitate creating systems that degrade gracefully, and the overflow mechanism is a result of this. When a Dob-based system comes under heavy load some data will be discarded (due to overflows), which ensures that there is an upper limit to the amount of memory and CPU used. If the Dob had not used the overflow mechanism, but instead had &#8220;infinite queues&#8221;, more and more memory would be consumed, which would lead to more and more CPU load, and eventually to a crash or some other undefined behaviour.</p>
<div class="paragraph">
<p>This of course means that your application should not introduce infinite queues of its own, since that would reintroduce the ungraceful degradation problem. There is a little bit more information in <a href="#overflow_handling">Overflow handling</a>.</p>
</div>
</dd>
<dt class="hdlist1">Why shouldn&#8217;t I have an infinite queue in my application to avoid overflows?</dt>
<dd>
<p>This is described somewhat in <a href="#overflow_handling">Overflow handling</a>, and the FAQ entry above.</p>
</dd>
<dt class="hdlist1">Whatever happened to <code>deletedByOwner</code>?</dt>
<dd>
<p>Once upon a time (well, 4.5 and earlier) the deprecated-flag in the <code>OnDeletedEntity</code> callback was known as <code>deletedByOwner</code>. This was used to signal how an entity was deleted, whether it was due to an unregistration or an explicit delete. Unfortunately this information was useless, since after the introduction of <em>ghosts</em> and persistence it was no longer possible for the Dob to guarantee that you got the right value in all circumstances. Unfortunately we did not realize this at the time, so we&#8217;ve had to deprecate this flag now.</p>
<div class="paragraph">
<p>The persistence service (<em>dope</em>), however, still uses this flag, since it has meaning when using the special <em>entity injector</em> subscribe with <code>wantsLastState</code> set to true. This will be changed in a future release, but you can safely ignore this bit of information unless you&#8217;re writing your own persistence service or entity injector.</p>
</div>
</dd>
<dt class="hdlist1">Have you got any tips for troubleshooting multicast networking?</dt>
<dd>
<p>When using multicast, and especially over routed networks it is important to be sure that
bidirectional multicast routing is enabled on the router. To test this we can recommend
<em>iperf</em> (<a href="http://sourceforge.net/projects/iperf" class="bare">http://sourceforge.net/projects/iperf</a>) and the gui frontend <em>jperf</em>
(<a href="http://sourceforge.net/projects/jperf" class="bare">http://sourceforge.net/projects/jperf</a>). One test strategy could be to run <code>iperf -u -s
-B 224.20.20.20</code> (listen to UDP packets on a multicast group) on all computers, and then
run <code>iperf -u -c 224.20.20.20</code> (send UDP multicast packets) in turn on each computer,
checking that you get output on all listeners for every run of the sender. If you&#8217;re not
getting output on all listeners for a certain sender you&#8217;ve got some routing problem.</p>
</dd>
<dt class="hdlist1">How can I be sure that I&#8217;m not using deprecated features?</dt>
<dd>
<p>In C++ you can define a preprocessor symbol <code>SAFIR_NO_DEPRECATED</code>. When this symbol is
defined any references to deprecated features will fail to compile.</p>
<div class="paragraph">
<p>For Java we have tagged deprecated features with the <code>@Deprecated</code> attribute, which should
cause your compiler to issue warnings.</p>
</div>
<div class="paragraph">
<p>For C# we have currently <em>not</em> used the <code>Obsolete</code> attribute, so no warnings are issued on
use of deprecated features.</p>
</div>
</dd>
<dt class="hdlist1">What happened to the <code>clone()</code> function in Java and why is <code>Clone()</code> deprecated in C#?</dt>
<dd>
<p>In Safir SDK Core 5 and earlier all types generated from dou-files used to have a method
for cloning in C# and Java. During the implementation of the new collection types in
Safir SDK Core 6.0 - sequence and dictionary - we realized that the Clone methods were
actually not needed. Additionally, supporting Clone for the new collection types would be
<em>a lot</em> of work. So the decision was taken to remove support for Clone.</p>
<div class="paragraph">
<p>We asked our customers about this, and they were ok with removing <code>clone()</code> in Java,
since it wasn&#8217;t being used, but in C# there is apparently quite a lot of user code that
calls Clone(), so in C# we decided to deprecate the API instead. However, the underlying
implementation now uses C# reflection, which means that we don&#8217;t need to write and
maintain all the Clone code for the new collection types.</p>
</div>
</dd>
<dt class="hdlist1">What happened to the <code>Safir.Dob.PersistenceParameters.TextColumnsAreUtf8</code> parameter?</dt>
<dd>
<p>This had to do with messy ODBC Unicode support. We have tried to make a solution that
should work without parametrization. If you really need the parameter, please let us
know!</p>
</dd>
<dt class="hdlist1">What happened to Olib and the Safir.Databases namespace?</dt>
<dd>
<p>The Safir ODBC database interface was deprecated and then removed. Please use some other way
of interacting with databases.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_building_from_source">Appendix D: Building from source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since Safir SDK Core is released under an Open Source license (as described in <a href="#licenses">Licences and Copying</a>) you are able to download and build the source code from scratch. Instructions for building is included in the source distribution of Safir SDK Core obtained from <a href="http://safirsdkcore.com/" class="bare">http://safirsdkcore.com/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_glossary">Glossary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This glossary mostly contains Safir-related acronyms and terms. General computer terms are not included, like "UDP", "Multicast" and "ODBC". Wikipedia, for example, is a much better source for explanations of those terms than this glossary could ever be.</p>
</div>
<div class="dlist glossary">
<dl>
<dt>Dob</dt>
<dd>
<p>Distributed Objects. Consists of the components Dose and Dots.</p>
</dd>
<dt>Dom</dt>
<dd>
<p>Distributed Objects Mapping. File type for mapping Dob classes to properties (in Xml).</p>
</dd>
<dt>Dope</dt>
<dd>
<p>The Safir SDK Core component that provides the persistent storage of Dob entities.</p>
</dd>
<dt>Dose</dt>
<dd>
<p>Safir component that provides the object distribution.</p>
</dd>
<dt>Dots</dt>
<dd>
<p>Safir component that provides the type system.</p>
</dd>
<dt>Dou</dt>
<dd>
<p>Distributed Objects Unit. File type for defining Dob classes (in Xml).</p>
</dd>
<dt>HMI</dt>
<dd>
<p>Human-Machine Interface.</p>
</dd>
<dt>Safir</dt>
<dd>
<p>Software Architecture For Information And Real-time systems.</p>
</dd>
<dt>Safir SDK</dt>
<dd>
<p>The technical platform of Safir.</p>
</dd>
<dt>Safir SDK Core</dt>
<dd>
<p>The core part of the Safir SDK.</p>
</dd>
<dt>SDK</dt>
<dd>
<p>Software Development Kit.</p>
</dd>
<dt>Swre</dt>
<dd>
<p>A Safir SDK Core component that provides Crash Reporting, Error/Event Logging and Trace logging functionality.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 1980-01-01 00:00:00 UTC
</div>
</div>
</body>
</html>